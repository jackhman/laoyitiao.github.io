import{_ as a,j as l,o as p,g as o,k as e,h as c,Q as s}from"./chunks/framework.a0d18f64.js";const C=JSON.parse('{"title":"ç¬¬05è®²ï¼šynchronizedå’ŒReentrantLockçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿå®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ","description":"","frontmatter":{},"headers":[],"relativePath":"posts/backEnd/Java æºç å‰–æ 34 è®²_æ–‡æ¡£/(1765) ç¬¬05è®²ï¼šynchronized å’Œ ReentrantLock çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿå®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ.md","filePath":"posts/backEnd/Java æºç å‰–æ 34 è®²_æ–‡æ¡£/(1765) ç¬¬05è®²ï¼šynchronized å’Œ ReentrantLock çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿå®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ.md","lastUpdated":1696682708000}'),t={name:"posts/backEnd/Java æºç å‰–æ 34 è®²_æ–‡æ¡£/(1765) ç¬¬05è®²ï¼šynchronized å’Œ ReentrantLock çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿå®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ.md"},r=s(`<h1 id="ç¬¬05è®²-ynchronizedå’Œreentrantlockçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ-å®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«" tabindex="-1">ç¬¬05è®²ï¼šynchronizedå’ŒReentrantLockçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿå®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ <a class="header-anchor" href="#ç¬¬05è®²-ynchronizedå’Œreentrantlockçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ-å®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«" aria-label="Permalink to &quot;ç¬¬05è®²ï¼šynchronizedå’ŒReentrantLockçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿå®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ&quot;">â€‹</a></h1><p>åœ¨ JDK 1.5 ä¹‹å‰å…±äº«å¯¹è±¡çš„åè°ƒæœºåˆ¶åªæœ‰ synchronized å’Œ volatileï¼Œåœ¨ JDK 1.5 ä¸­å¢åŠ äº†æ–°çš„æœºåˆ¶ ReentrantLockï¼Œè¯¥æœºåˆ¶çš„è¯ç”Ÿå¹¶ä¸æ˜¯ä¸ºäº†æ›¿ä»£ synchronizedï¼Œè€Œæ˜¯åœ¨ synchronized ä¸é€‚ç”¨çš„æƒ…å†µä¸‹ï¼Œæä¾›ä¸€ç§å¯ä»¥é€‰æ‹©çš„é«˜çº§åŠŸèƒ½ã€‚</p><p>æˆ‘ä»¬æœ¬è¯¾æ—¶çš„é¢è¯•é¢˜æ˜¯ï¼Œsynchronized å’Œ ReentrantLock æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p><h3 id="å…¸å‹å›ç­”" tabindex="-1">å…¸å‹å›ç­” <a class="header-anchor" href="#å…¸å‹å›ç­”" aria-label="Permalink to &quot;å…¸å‹å›ç­”&quot;">â€‹</a></h3><p>synchronized å±äºç‹¬å å¼æ‚²è§‚é”ï¼Œæ˜¯é€šè¿‡ JVM éšå¼å®ç°çš„ï¼Œsynchronized åªå…è®¸åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ“ä½œèµ„æºã€‚</p><p>åœ¨ Java ä¸­æ¯ä¸ªå¯¹è±¡éƒ½éšå¼åŒ…å«ä¸€ä¸ª monitorï¼ˆç›‘è§†å™¨ï¼‰å¯¹è±¡ï¼ŒåŠ é”çš„è¿‡ç¨‹å…¶å®å°±æ˜¯ç«äº‰ monitor çš„è¿‡ç¨‹ï¼Œå½“çº¿ç¨‹è¿›å…¥å­—èŠ‚ç  monitorenter æŒ‡ä»¤ä¹‹åï¼Œçº¿ç¨‹å°†æŒæœ‰ monitor å¯¹è±¡ï¼Œæ‰§è¡Œ monitorexit æ—¶é‡Šæ”¾ monitor å¯¹è±¡ï¼Œå½“å…¶ä»–çº¿ç¨‹æ²¡æœ‰æ‹¿åˆ° monitor å¯¹è±¡æ—¶ï¼Œåˆ™éœ€è¦é˜»å¡ç­‰å¾…è·å–è¯¥å¯¹è±¡ã€‚</p><p>ReentrantLock æ˜¯ Lock çš„é»˜è®¤å®ç°æ–¹å¼ä¹‹ä¸€ï¼Œå®ƒæ˜¯åŸºäº AQSï¼ˆAbstract Queued Synchronizerï¼Œé˜Ÿåˆ—åŒæ­¥å™¨ï¼‰å®ç°çš„ï¼Œå®ƒé»˜è®¤æ˜¯é€šè¿‡éå…¬å¹³é”å®ç°çš„ï¼Œåœ¨å®ƒçš„å†…éƒ¨æœ‰ä¸€ä¸ª state çš„çŠ¶æ€å­—æ®µç”¨äºè¡¨ç¤ºé”æ˜¯å¦è¢«å ç”¨ï¼Œå¦‚æœæ˜¯ 0 åˆ™è¡¨ç¤ºé”æœªè¢«å ç”¨ï¼Œæ­¤æ—¶çº¿ç¨‹å°±å¯ä»¥æŠŠ state æ”¹ä¸º 1ï¼Œå¹¶æˆåŠŸè·å¾—é”ï¼Œè€Œå…¶ä»–æœªè·å¾—é”çš„çº¿ç¨‹åªèƒ½å»æ’é˜Ÿç­‰å¾…è·å–é”èµ„æºã€‚</p><p>synchronized å’Œ ReentrantLock éƒ½æä¾›äº†é”çš„åŠŸèƒ½ï¼Œå…·å¤‡äº’æ–¥æ€§å’Œä¸å¯è§æ€§ã€‚åœ¨ JDK 1.5 ä¸­ synchronized çš„æ€§èƒ½è¿œè¿œä½äº ReentrantLockï¼Œä½†åœ¨ JDK 1.6 ä¹‹å synchronized çš„æ€§èƒ½ç•¥ä½äº ReentrantLockï¼Œå®ƒçš„åŒºåˆ«å¦‚ä¸‹ï¼š</p><ul><li>synchronized æ˜¯ JVM éšå¼å®ç°çš„ï¼Œè€Œ ReentrantLock æ˜¯ Java è¯­è¨€æä¾›çš„ APIï¼›</li><li>ReentrantLock å¯è®¾ç½®ä¸ºå…¬å¹³é”ï¼Œè€Œ synchronized å´ä¸è¡Œï¼›</li><li>ReentrantLock åªèƒ½ä¿®é¥°ä»£ç å—ï¼Œè€Œ synchronized å¯ä»¥ç”¨äºä¿®é¥°æ–¹æ³•ã€ä¿®é¥°ä»£ç å—ç­‰ï¼›</li><li>ReentrantLock éœ€è¦æ‰‹åŠ¨åŠ é”å’Œé‡Šæ”¾é”ï¼Œå¦‚æœå¿˜è®°é‡Šæ”¾é”ï¼Œåˆ™ä¼šé€ æˆèµ„æºè¢«æ°¸ä¹…å ç”¨ï¼Œè€Œ synchronized æ— éœ€æ‰‹åŠ¨é‡Šæ”¾é”ï¼›</li><li>ReentrantLock å¯ä»¥çŸ¥é“æ˜¯å¦æˆåŠŸè·å¾—äº†é”ï¼Œè€Œ synchronized å´ä¸è¡Œã€‚</li></ul><h3 id="è€ƒç‚¹åˆ†æ" tabindex="-1">è€ƒç‚¹åˆ†æ <a class="header-anchor" href="#è€ƒç‚¹åˆ†æ" aria-label="Permalink to &quot;è€ƒç‚¹åˆ†æ&quot;">â€‹</a></h3><p>synchronized å’Œ ReentrantLock æ˜¯æ¯”çº¿ç¨‹æ± è¿˜è¦é«˜é¢‘çš„é¢è¯•é—®é¢˜ï¼Œå› ä¸ºå®ƒåŒ…å«äº†æ›´å¤šçš„çŸ¥è¯†ç‚¹ï¼Œä¸”æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹æ›´åŠ æ·±å…¥ï¼Œå¯¹é¢è¯•è€…çš„è¦æ±‚ä¹Ÿæ›´é«˜ï¼Œå‰é¢æˆ‘ä»¬ç®€è¦åœ°ä»‹ç»äº† synchronized å’Œ ReentrantLock çš„æ¦‚å¿µåŠæ‰§è¡ŒåŸç†ï¼Œä½†å¾ˆå¤šå¤§å‚ä¼šæ›´åŠ æ·±å…¥çš„è¿½é—®æ›´å¤šå…³äºå®ƒä»¬çš„å®ç°ç»†èŠ‚ï¼Œæ¯”å¦‚ï¼š</p><ul><li>ReentrantLock çš„å…·ä½“å®ç°ç»†èŠ‚æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>JDK 1.6 æ—¶é”åšäº†å“ªäº›ä¼˜åŒ–ï¼Ÿ</li></ul><h3 id="çŸ¥è¯†æ‰©å±•" tabindex="-1">çŸ¥è¯†æ‰©å±• <a class="header-anchor" href="#çŸ¥è¯†æ‰©å±•" aria-label="Permalink to &quot;çŸ¥è¯†æ‰©å±•&quot;">â€‹</a></h3><h4 id="reentrantlock-æºç åˆ†æ" tabindex="-1">ReentrantLock æºç åˆ†æ <a class="header-anchor" href="#reentrantlock-æºç åˆ†æ" aria-label="Permalink to &quot;ReentrantLock æºç åˆ†æ&quot;">â€‹</a></h4><p>æœ¬è¯¾æ—¶ä»æºç å‡ºå‘æ¥è§£å¯† ReentrantLock çš„å…·ä½“å®ç°ç»†èŠ‚ï¼Œé¦–å…ˆæ¥çœ‹ ReentrantLock çš„ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReentrantLock</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    sync </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NonfairSync</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// éå…¬å¹³é”</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReentrantLock</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> fair) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    sync </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> fair </span><span style="color:#F97583;">?</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">FairSync</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NonfairSync</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReentrantLock</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    sync </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NonfairSync</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// éå…¬å¹³é”</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReentrantLock</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> fair) {</span></span>
<span class="line"><span style="color:#24292E;">    sync </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> fair </span><span style="color:#D73A49;">?</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">FairSync</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NonfairSync</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>æ— å‚çš„æ„é€ å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªéå…¬å¹³é”ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥æ ¹æ®ç¬¬äºŒä¸ªæ„é€ å‡½æ•°ï¼Œè®¾ç½®ä¸€ä¸ª boolean ç±»å‹çš„å€¼ï¼Œæ¥å†³å®šæ˜¯å¦ä½¿ç”¨å…¬å¹³é”æ¥å®ç°çº¿ç¨‹çš„è°ƒåº¦ã€‚</p><p><strong>å…¬å¹³é” VS éå…¬å¹³é”</strong></p><p>å…¬å¹³é”çš„å«ä¹‰æ˜¯çº¿ç¨‹éœ€è¦æŒ‰ç…§è¯·æ±‚çš„é¡ºåºæ¥è·å¾—é”ï¼›è€Œéå…¬å¹³é”åˆ™å…è®¸&quot;æ’é˜Ÿ&quot;çš„æƒ…å†µå­˜åœ¨ï¼Œæ‰€è°“çš„&quot;æ’é˜Ÿ&quot;æŒ‡çš„æ˜¯ï¼Œçº¿ç¨‹åœ¨å‘é€è¯·æ±‚çš„åŒæ—¶è¯¥é”çš„çŠ¶æ€æ°å¥½å˜æˆäº†å¯ç”¨ï¼Œé‚£ä¹ˆæ­¤çº¿ç¨‹å°±å¯ä»¥è·³è¿‡é˜Ÿåˆ—ä¸­æ‰€æœ‰æ’é˜Ÿçš„çº¿ç¨‹ç›´æ¥æ‹¥æœ‰è¯¥é”ã€‚</p><p>è€Œå…¬å¹³é”ç”±äºæœ‰æŒ‚èµ·å’Œæ¢å¤æ‰€ä»¥å­˜åœ¨ä¸€å®šçš„å¼€é”€ï¼Œå› æ­¤æ€§èƒ½ä¸å¦‚éå…¬å¹³é”ï¼Œæ‰€ä»¥ ReentrantLock å’Œ synchronized é»˜è®¤éƒ½æ˜¯éå…¬å¹³é”çš„å®ç°æ–¹å¼ã€‚</p><p>ReentrantLock æ˜¯é€šè¿‡ lock() æ¥è·å–é”ï¼Œå¹¶é€šè¿‡ unlock() é‡Šæ”¾é”ï¼Œä½¿ç”¨ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">Lock lock </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReentrantLock</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// åŠ é”</span></span>
<span class="line"><span style="color:#E1E4E8;">    lock.</span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">//......ä¸šåŠ¡å¤„ç†</span></span>
<span class="line"><span style="color:#E1E4E8;">} </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// é‡Šæ”¾é”</span></span>
<span class="line"><span style="color:#E1E4E8;">    lock.</span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">Lock lock </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReentrantLock</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// åŠ é”</span></span>
<span class="line"><span style="color:#24292E;">    lock.</span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">//......ä¸šåŠ¡å¤„ç†</span></span>
<span class="line"><span style="color:#24292E;">} </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// é‡Šæ”¾é”</span></span>
<span class="line"><span style="color:#24292E;">    lock.</span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>ReentrantLock ä¸­çš„ lock() æ˜¯é€šè¿‡ sync.lock() å®ç°çš„ï¼Œä½† Sync ç±»ä¸­çš„ lock() æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œéœ€è¦å­ç±» NonfairSync æˆ– FairSync å»å®ç°ï¼ŒNonfairSync ä¸­çš„ lock() æºç å¦‚ä¸‹ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">compareAndSetState</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// å°†å½“å‰çº¿ç¨‹è®¾ç½®ä¸ºæ­¤é”çš„æŒæœ‰è€…</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">setExclusiveOwnerThread</span><span style="color:#E1E4E8;">(Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">());</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">acquire</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">compareAndSetState</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// å°†å½“å‰çº¿ç¨‹è®¾ç½®ä¸ºæ­¤é”çš„æŒæœ‰è€…</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">setExclusiveOwnerThread</span><span style="color:#24292E;">(Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">());</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">acquire</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>FairSync ä¸­çš„ lock() æºç å¦‚ä¸‹ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">lock</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">acquire</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">lock</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">acquire</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>å¯ä»¥çœ‹å‡ºéå…¬å¹³é”æ¯”å…¬å¹³é”åªæ˜¯å¤šäº†ä¸€è¡Œ compareAndSetState æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯å°è¯•å°† state å€¼ç”± 0 ç½®æ¢ä¸º 1ï¼Œå¦‚æœè®¾ç½®æˆåŠŸçš„è¯ï¼Œåˆ™è¯´æ˜å½“å‰æ²¡æœ‰å…¶ä»–çº¿ç¨‹æŒæœ‰è¯¥é”ï¼Œä¸ç”¨å†å»æ’é˜Ÿäº†ï¼Œå¯ç›´æ¥å ç”¨è¯¥é”ï¼Œå¦åˆ™ï¼Œåˆ™éœ€è¦é€šè¿‡ acquire æ–¹æ³•å»æ’é˜Ÿã€‚</p><p>acquire æºç å¦‚ä¸‹ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">acquire</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> arg) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">tryAcquire</span><span style="color:#E1E4E8;">(arg) </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">acquireQueued</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">addWaiter</span><span style="color:#E1E4E8;">(Node.EXCLUSIVE), arg))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">selfInterrupt</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">acquire</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> arg) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#6F42C1;">tryAcquire</span><span style="color:#24292E;">(arg) </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">acquireQueued</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">addWaiter</span><span style="color:#24292E;">(Node.EXCLUSIVE), arg))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">selfInterrupt</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>tryAcquire æ–¹æ³•å°è¯•è·å–é”ï¼Œå¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™æŠŠå®ƒåŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œæ¥çœ‹ tryAcquire çš„æºç ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryAcquire</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> acquires) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Thread current </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (c </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// å…¬å¹³é”æ¯”éå…¬å¹³é”å¤šäº†ä¸€è¡Œä»£ç  !hasQueuedPredecessors() </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#B392F0;">hasQueuedPredecessors</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">compareAndSetState</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, acquires)) { </span><span style="color:#6A737D;">//å°è¯•è·å–é”</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">setExclusiveOwnerThread</span><span style="color:#E1E4E8;">(current); </span><span style="color:#6A737D;">// è·å–æˆåŠŸï¼Œæ ‡è®°è¢«æŠ¢å </span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (current </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getExclusiveOwnerThread</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> nextc </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> acquires;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (nextc </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Error</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Maximum lock count exceeded&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">setState</span><span style="color:#E1E4E8;">(nextc); </span><span style="color:#6A737D;">// set state=state+1</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryAcquire</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> acquires) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Thread current </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (c </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// å…¬å¹³é”æ¯”éå…¬å¹³é”å¤šäº†ä¸€è¡Œä»£ç  !hasQueuedPredecessors() </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#6F42C1;">hasQueuedPredecessors</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">compareAndSetState</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, acquires)) { </span><span style="color:#6A737D;">//å°è¯•è·å–é”</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">setExclusiveOwnerThread</span><span style="color:#24292E;">(current); </span><span style="color:#6A737D;">// è·å–æˆåŠŸï¼Œæ ‡è®°è¢«æŠ¢å </span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (current </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getExclusiveOwnerThread</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> nextc </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> acquires;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (nextc </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Error</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Maximum lock count exceeded&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">setState</span><span style="color:#24292E;">(nextc); </span><span style="color:#6A737D;">// set state=state+1</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>å¯¹äºæ­¤æ–¹æ³•æ¥è¯´ï¼Œå…¬å¹³é”æ¯”éå…¬å¹³é”åªå¤šä¸€è¡Œä»£ç  !hasQueuedPredecessors()ï¼Œå®ƒç”¨æ¥æŸ¥çœ‹é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰æ¯”å®ƒç­‰å¾…æ—¶é—´æ›´ä¹…çš„çº¿ç¨‹ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±å°è¯•ä¸€ä¸‹æ˜¯å¦èƒ½è·å–åˆ°é”ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œåˆ™æ ‡è®°ä¸ºå·²ç»è¢«å ç”¨ã€‚</p><p>å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™è°ƒç”¨ addWaiter æ–¹æ³•æŠŠçº¿ç¨‹åŒ…è£…æˆ Node å¯¹è±¡ï¼ŒåŒæ—¶æ”¾å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œä½† addWaiter æ–¹æ³•å¹¶ä¸ä¼šå°è¯•è·å–é”ï¼ŒacquireQueued æ–¹æ³•æ‰ä¼šå°è¯•è·å–é”ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œåˆ™æ­¤èŠ‚ç‚¹ä¼šè¢«æŒ‚èµ·ï¼Œæºç å¦‚ä¸‹ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹å°è¯•è·å–é”ï¼Œå¤±è´¥åˆ™ä¼šè¢«æŒ‚èµ·</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">acquireQueued</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Node node, </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> arg) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> failed </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// è·å–é”æ˜¯å¦æˆåŠŸçš„çŠ¶æ€æ ‡è¯†</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> interrupted </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (;;) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// è·å–å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå‰é©±èŠ‚ç‚¹ï¼‰</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Node p </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> node.</span><span style="color:#B392F0;">predecessor</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// å½“å‰èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œæœ‰æƒå°è¯•è·å–é”</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (p </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> head </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryAcquire</span><span style="color:#E1E4E8;">(arg)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">setHead</span><span style="color:#E1E4E8;">(node); </span><span style="color:#6A737D;">// è·å–æˆåŠŸï¼Œå°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸º head èŠ‚ç‚¹</span></span>
<span class="line"><span style="color:#E1E4E8;">                p.next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// åŸ head èŠ‚ç‚¹å‡ºé˜Ÿï¼Œç­‰å¾…è¢« GC</span></span>
<span class="line"><span style="color:#E1E4E8;">                failed </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;">// è·å–æˆåŠŸ</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> interrupted;</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// åˆ¤æ–­è·å–é”å¤±è´¥åæ˜¯å¦å¯ä»¥æŒ‚èµ·</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">shouldParkAfterFailedAcquire</span><span style="color:#E1E4E8;">(p, node) </span><span style="color:#F97583;">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#B392F0;">parkAndCheckInterrupt</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#6A737D;">// çº¿ç¨‹è‹¥è¢«ä¸­æ–­ï¼Œè¿”å› true</span></span>
<span class="line"><span style="color:#E1E4E8;">                interrupted </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (failed)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">cancelAcquire</span><span style="color:#E1E4E8;">(node);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹å°è¯•è·å–é”ï¼Œå¤±è´¥åˆ™ä¼šè¢«æŒ‚èµ·</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">acquireQueued</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Node node, </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> arg) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> failed </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// è·å–é”æ˜¯å¦æˆåŠŸçš„çŠ¶æ€æ ‡è¯†</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> interrupted </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (;;) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// è·å–å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå‰é©±èŠ‚ç‚¹ï¼‰</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Node p </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> node.</span><span style="color:#6F42C1;">predecessor</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// å½“å‰èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œæœ‰æƒå°è¯•è·å–é”</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (p </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> head </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryAcquire</span><span style="color:#24292E;">(arg)) {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">setHead</span><span style="color:#24292E;">(node); </span><span style="color:#6A737D;">// è·å–æˆåŠŸï¼Œå°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸º head èŠ‚ç‚¹</span></span>
<span class="line"><span style="color:#24292E;">                p.next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// åŸ head èŠ‚ç‚¹å‡ºé˜Ÿï¼Œç­‰å¾…è¢« GC</span></span>
<span class="line"><span style="color:#24292E;">                failed </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">; </span><span style="color:#6A737D;">// è·å–æˆåŠŸ</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> interrupted;</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// åˆ¤æ–­è·å–é”å¤±è´¥åæ˜¯å¦å¯ä»¥æŒ‚èµ·</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">shouldParkAfterFailedAcquire</span><span style="color:#24292E;">(p, node) </span><span style="color:#D73A49;">&amp;&amp;</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6F42C1;">parkAndCheckInterrupt</span><span style="color:#24292E;">())</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#6A737D;">// çº¿ç¨‹è‹¥è¢«ä¸­æ–­ï¼Œè¿”å› true</span></span>
<span class="line"><span style="color:#24292E;">                interrupted </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (failed)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">cancelAcquire</span><span style="color:#24292E;">(node);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>è¯¥æ–¹æ³•ä¼šä½¿ç”¨ for(;ğŸ˜‰ æ— é™å¾ªç¯çš„æ–¹å¼æ¥å°è¯•è·å–é”ï¼Œè‹¥è·å–å¤±è´¥ï¼Œåˆ™è°ƒç”¨ shouldParkAfterFailedAcquire æ–¹æ³•ï¼Œå°è¯•æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œæºç å¦‚ä¸‹ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å¯ä»¥è¢«æŒ‚èµ·</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">private</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">shouldParkAfterFailedAcquire</span><span style="color:#E1E4E8;">(Node pred, Node node) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// è·å¾—å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> ws </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> pred.waitStatus;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º SIGNALï¼Œå½“å‰çº¿ç¨‹å¯ä»¥è¢«æŒ‚èµ·ï¼ˆé˜»å¡ï¼‰</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (ws </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> Node.SIGNAL)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (ws </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) { </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">do</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// è‹¥å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸º CANCELLEDï¼Œé‚£å°±ä¸€ç›´å¾€å‰æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ­£å¸¸ç­‰å¾…çš„çŠ¶æ€ä¸ºæ­¢</span></span>
<span class="line"><span style="color:#E1E4E8;">            node.prev </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> pred </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> pred.prev;</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">while</span><span style="color:#E1E4E8;"> (pred.waitStatus </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// å¹¶å°†å½“å‰èŠ‚ç‚¹æ’åœ¨å®ƒåè¾¹</span></span>
<span class="line"><span style="color:#E1E4E8;">        pred.next </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> node;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// æŠŠå‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¿®æ”¹ä¸º SIGNAL</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">compareAndSetWaitStatus</span><span style="color:#E1E4E8;">(pred, ws, Node.SIGNAL);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å¯ä»¥è¢«æŒ‚èµ·</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">private</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">shouldParkAfterFailedAcquire</span><span style="color:#24292E;">(Node pred, Node node) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// è·å¾—å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> ws </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> pred.waitStatus;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º SIGNALï¼Œå½“å‰çº¿ç¨‹å¯ä»¥è¢«æŒ‚èµ·ï¼ˆé˜»å¡ï¼‰</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (ws </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> Node.SIGNAL)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (ws </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) { </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">do</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// è‹¥å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸º CANCELLEDï¼Œé‚£å°±ä¸€ç›´å¾€å‰æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæ­£å¸¸ç­‰å¾…çš„çŠ¶æ€ä¸ºæ­¢</span></span>
<span class="line"><span style="color:#24292E;">            node.prev </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> pred </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> pred.prev;</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">while</span><span style="color:#24292E;"> (pred.waitStatus </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// å¹¶å°†å½“å‰èŠ‚ç‚¹æ’åœ¨å®ƒåè¾¹</span></span>
<span class="line"><span style="color:#24292E;">        pred.next </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> node;</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// æŠŠå‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¿®æ”¹ä¸º SIGNAL</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">compareAndSetWaitStatus</span><span style="color:#24292E;">(pred, ws, Node.SIGNAL);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>çº¿ç¨‹å…¥åˆ—è¢«æŒ‚èµ·çš„å‰ææ¡ä»¶æ˜¯ï¼Œå‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º SIGNALï¼ŒSIGNAL çŠ¶æ€çš„å«ä¹‰æ˜¯åç»§èŠ‚ç‚¹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå½“å‰èŠ‚ç‚¹é‡Šæ”¾é”åå°†ä¼šå”¤é†’åç»§èŠ‚ç‚¹ã€‚æ‰€ä»¥åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œä¼šå…ˆåˆ¤æ–­å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå¦‚æœä¸º SIGNALï¼Œåˆ™å½“å‰çº¿ç¨‹å¯ä»¥è¢«æŒ‚èµ·å¹¶è¿”å› trueï¼›å¦‚æœå‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ &gt;0ï¼Œåˆ™è¡¨ç¤ºå‰é©±èŠ‚ç‚¹å–æ¶ˆäº†ï¼Œè¿™æ—¶å€™éœ€è¦ä¸€ç›´å¾€å‰æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æœ€è¿‘ä¸€ä¸ªæ­£å¸¸ç­‰å¾…çš„å‰é©±èŠ‚ç‚¹ï¼Œç„¶åæŠŠå®ƒä½œä¸ºè‡ªå·±çš„å‰é©±èŠ‚ç‚¹ï¼›å¦‚æœå‰é©±èŠ‚ç‚¹æ­£å¸¸ï¼ˆæœªå–æ¶ˆï¼‰ï¼Œåˆ™ä¿®æ”¹å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸º SIGNALã€‚</p><p>åˆ°è¿™é‡Œæ•´ä¸ªåŠ é”çš„æµç¨‹å°±å·²ç»èµ°å®Œäº†ï¼Œæœ€åçš„æƒ…å†µæ˜¯ï¼Œæ²¡æœ‰æ‹¿åˆ°é”çš„çº¿ç¨‹ä¼šåœ¨é˜Ÿåˆ—ä¸­è¢«æŒ‚èµ·ï¼Œç›´åˆ°æ‹¥æœ‰é”çš„çº¿ç¨‹é‡Šæ”¾é”ä¹‹åï¼Œæ‰ä¼šå»å”¤é†’å…¶ä»–çš„çº¿ç¨‹å»è·å–é”èµ„æºï¼Œæ•´ä¸ªè¿è¡Œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>`,38),E=s(`<p>unlock ç›¸æ¯”äº lock æ¥è¯´å°±ç®€å•å¾ˆå¤šäº†ï¼Œæºç å¦‚ä¸‹ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">unlock</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    sync.</span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">release</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> arg) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// å°è¯•é‡Šæ”¾é”</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">tryRelease</span><span style="color:#E1E4E8;">(arg)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// é‡Šæ”¾æˆåŠŸ</span></span>
<span class="line"><span style="color:#E1E4E8;">        Node h </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> head;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (h </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;&amp;</span><span style="color:#E1E4E8;"> h.waitStatus </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">unparkSuccessor</span><span style="color:#E1E4E8;">(h);</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">unlock</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    sync.</span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">release</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> arg) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// å°è¯•é‡Šæ”¾é”</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">tryRelease</span><span style="color:#24292E;">(arg)) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// é‡Šæ”¾æˆåŠŸ</span></span>
<span class="line"><span style="color:#24292E;">        Node h </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> head;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (h </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;&amp;</span><span style="color:#24292E;"> h.waitStatus </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">unparkSuccessor</span><span style="color:#24292E;">(h);</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>é”çš„é‡Šæ”¾æµç¨‹ä¸ºï¼Œå…ˆè°ƒç”¨ tryRelease æ–¹æ³•å°è¯•é‡Šæ”¾é”ï¼Œå¦‚æœé‡Šæ”¾æˆåŠŸï¼Œåˆ™æŸ¥çœ‹å¤´ç»“ç‚¹çš„çŠ¶æ€æ˜¯å¦ä¸º SIGNALï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å”¤é†’å¤´ç»“ç‚¹çš„ä¸‹ä¸ªèŠ‚ç‚¹å…³è”çš„çº¿ç¨‹ï¼›å¦‚æœé‡Šæ”¾é”å¤±è´¥ï¼Œåˆ™è¿”å› falseã€‚</p><p>tryRelease æºç å¦‚ä¸‹ï¼š</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * å°è¯•é‡Šæ”¾å½“å‰çº¿ç¨‹å æœ‰çš„é”</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">protected</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">tryRelease</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> releases) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getState</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> releases; </span><span style="color:#6A737D;">// é‡Šæ”¾é”åçš„çŠ¶æ€ï¼Œ0 è¡¨ç¤ºé‡Šæ”¾é”æˆåŠŸ</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// å¦‚æœæ‹¥æœ‰é”çš„çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹çš„è¯æŠ›å‡ºå¼‚å¸¸</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (Thread.</span><span style="color:#B392F0;">currentThread</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getExclusiveOwnerThread</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IllegalMonitorStateException</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">boolean</span><span style="color:#E1E4E8;"> free </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (c </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) { </span><span style="color:#6A737D;">// é”è¢«æˆåŠŸé‡Šæ”¾</span></span>
<span class="line"><span style="color:#E1E4E8;">        free </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">setExclusiveOwnerThread</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">); </span><span style="color:#6A737D;">// æ¸…ç©ºç‹¬å çº¿ç¨‹</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">setState</span><span style="color:#E1E4E8;">(c); </span><span style="color:#6A737D;">// æ›´æ–° state å€¼ï¼Œ0 è¡¨ç¤ºä¸ºé‡Šæ”¾é”æˆåŠŸ</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> free;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/**</span></span>
<span class="line"><span style="color:#6A737D;"> * å°è¯•é‡Šæ”¾å½“å‰çº¿ç¨‹å æœ‰çš„é”</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">protected</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">tryRelease</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> releases) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getState</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> releases; </span><span style="color:#6A737D;">// é‡Šæ”¾é”åçš„çŠ¶æ€ï¼Œ0 è¡¨ç¤ºé‡Šæ”¾é”æˆåŠŸ</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// å¦‚æœæ‹¥æœ‰é”çš„çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹çš„è¯æŠ›å‡ºå¼‚å¸¸</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (Thread.</span><span style="color:#6F42C1;">currentThread</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getExclusiveOwnerThread</span><span style="color:#24292E;">())</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IllegalMonitorStateException</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">boolean</span><span style="color:#24292E;"> free </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (c </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) { </span><span style="color:#6A737D;">// é”è¢«æˆåŠŸé‡Šæ”¾</span></span>
<span class="line"><span style="color:#24292E;">        free </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">setExclusiveOwnerThread</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">null</span><span style="color:#24292E;">); </span><span style="color:#6A737D;">// æ¸…ç©ºç‹¬å çº¿ç¨‹</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">setState</span><span style="color:#24292E;">(c); </span><span style="color:#6A737D;">// æ›´æ–° state å€¼ï¼Œ0 è¡¨ç¤ºä¸ºé‡Šæ”¾é”æˆåŠŸ</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> free;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>åœ¨ tryRelease æ–¹æ³•ä¸­ï¼Œä¼šå…ˆåˆ¤æ–­å½“å‰çš„çº¿ç¨‹æ˜¯ä¸æ˜¯å ç”¨é”çš„çº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼›å¦‚æœæ˜¯çš„è¯ï¼Œåˆ™å…ˆè®¡ç®—é”çš„çŠ¶æ€å€¼ getState() - releases æ˜¯å¦ä¸º 0ï¼Œå¦‚æœä¸º 0ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥æ­£å¸¸çš„é‡Šæ”¾é”ï¼Œç„¶åæ¸…ç©ºç‹¬å çš„çº¿ç¨‹ï¼Œæœ€åä¼šæ›´æ–°é”çš„çŠ¶æ€å¹¶è¿”å›æ‰§è¡Œç»“æœã€‚</p><h4 id="jdk-1-6-é”ä¼˜åŒ–" tabindex="-1">JDK 1.6 é”ä¼˜åŒ– <a class="header-anchor" href="#jdk-1-6-é”ä¼˜åŒ–" aria-label="Permalink to &quot;JDK 1.6 é”ä¼˜åŒ–&quot;">â€‹</a></h4><p><strong>è‡ªé€‚åº”è‡ªæ—‹é”</strong></p><p>JDK 1.5 åœ¨å‡çº§ä¸º JDK 1.6 æ—¶ï¼ŒHotSpot è™šæ‹Ÿæœºå›¢é˜Ÿåœ¨é”çš„ä¼˜åŒ–ä¸Šä¸‹äº†å¾ˆå¤§åŠŸå¤«ï¼Œæ¯”å¦‚å®ç°äº†è‡ªé€‚åº”å¼è‡ªæ—‹é”ã€é”å‡çº§ç­‰ã€‚</p><p>JDK 1.6 å¼•å…¥äº†è‡ªé€‚åº”å¼è‡ªæ—‹é”æ„å‘³ç€è‡ªæ—‹çš„æ—¶é—´ä¸å†æ˜¯å›ºå®šçš„æ—¶é—´äº†ï¼Œæ¯”å¦‚åœ¨åŒä¸€ä¸ªé”å¯¹è±¡ä¸Šï¼Œå¦‚æœé€šè¿‡è‡ªæ—‹ç­‰å¾…æˆåŠŸè·å–äº†é”ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°±ä¼šè®¤ä¸ºï¼Œå®ƒä¸‹ä¸€æ¬¡å¾ˆæœ‰å¯èƒ½ä¹Ÿä¼šæˆåŠŸ (é€šè¿‡è‡ªæ—‹è·å–åˆ°é”)ï¼Œå› æ­¤å…è®¸è‡ªæ—‹ç­‰å¾…çš„æ—¶é—´ä¼šç›¸å¯¹çš„æ¯”è¾ƒé•¿ï¼Œè€Œå½“æŸä¸ªé”é€šè¿‡è‡ªæ—‹å¾ˆå°‘æˆåŠŸè·å¾—è¿‡é”ï¼Œé‚£ä¹ˆä»¥ååœ¨è·å–è¯¥é”æ—¶ï¼Œå¯èƒ½ä¼šç›´æ¥å¿½ç•¥æ‰è‡ªæ—‹çš„è¿‡ç¨‹ï¼Œä»¥é¿å…æµªè´¹ CPU çš„èµ„æºï¼Œè¿™å°±æ˜¯<strong>è‡ªé€‚åº”è‡ªæ—‹é”</strong>çš„åŠŸèƒ½ã€‚</p><p><strong>é”å‡çº§</strong></p><p>é”å‡çº§å…¶å®å°±æ˜¯ä»åå‘é”åˆ°è½»é‡çº§é”å†åˆ°é‡é‡çº§é”å‡çº§çš„è¿‡ç¨‹ï¼Œè¿™æ˜¯ JDK 1.6 æä¾›çš„ä¼˜åŒ–åŠŸèƒ½ï¼Œä¹Ÿç§°ä¹‹ä¸ºé”è†¨èƒ€ã€‚</p><p><strong>åå‘é”</strong>æ˜¯æŒ‡åœ¨æ— ç«äº‰çš„æƒ…å†µä¸‹è®¾ç½®çš„ä¸€ç§é”çŠ¶æ€ã€‚åå‘é”çš„æ„æ€æ˜¯å®ƒä¼šåå‘äºç¬¬ä¸€ä¸ªè·å–å®ƒçš„çº¿ç¨‹ï¼Œå½“é”å¯¹è±¡ç¬¬ä¸€æ¬¡è¢«è·å–åˆ°ä¹‹åï¼Œä¼šåœ¨æ­¤å¯¹è±¡å¤´ä¸­è®¾ç½®æ ‡ç¤ºä¸º&quot;01&quot;ï¼Œè¡¨ç¤ºåå‘é”çš„æ¨¡å¼ï¼Œå¹¶ä¸”åœ¨å¯¹è±¡å¤´ä¸­è®°å½•æ­¤çº¿ç¨‹çš„ IDï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ˜¯æŒæœ‰åå‘é”çš„çº¿ç¨‹æ¯æ¬¡åœ¨è¿›å…¥çš„è¯ï¼Œä¸å†è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œï¼Œå¦‚ Lockingã€Unlocking ç­‰ï¼Œç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹å°è¯•è·å–æ­¤é”çš„æ—¶å€™ï¼Œåå‘é”æ¨¡å¼æ‰ä¼šç»“æŸï¼Œåå‘é”å¯ä»¥æé«˜å¸¦æœ‰åŒæ­¥ä½†æ— ç«äº‰çš„ç¨‹åºæ€§èƒ½ã€‚ä½†å¦‚æœåœ¨å¤šæ•°é”æ€»ä¼šè¢«ä¸åŒçš„çº¿ç¨‹è®¿é—®æ—¶ï¼Œåå‘é”æ¨¡å¼å°±æ¯”è¾ƒå¤šä½™äº†ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ -XX:-UseBiasedLocking æ¥ç¦ç”¨åå‘é”ä»¥æé«˜æ€§èƒ½ã€‚</p><p><strong>è½»é‡é”</strong> æ˜¯ç›¸å¯¹äºé‡é‡é”è€Œè¨€çš„ï¼Œåœ¨ JDK 1.6 ä¹‹å‰ï¼Œsynchronized æ˜¯é€šè¿‡æ“ä½œç³»ç»Ÿçš„äº’æ–¥é‡ï¼ˆmutex lockï¼‰æ¥å®ç°çš„ï¼Œè¿™ç§å®ç°æ–¹å¼éœ€è¦åœ¨ç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€ä¹‹é—´åšè½¬æ¢ï¼Œæœ‰å¾ˆå¤§çš„æ€§èƒ½æ¶ˆè€—ï¼Œè¿™ç§ä¼ ç»Ÿå®ç°é”çš„æ–¹å¼è¢«ç§°ä¹‹ä¸º<strong>é‡é‡é”ã€‚</strong></p><p>è€Œ<strong>è½»é‡é”</strong>æ˜¯é€šè¿‡æ¯”è¾ƒå¹¶äº¤æ¢ï¼ˆCASï¼ŒCompare and Swapï¼‰æ¥å®ç°çš„ï¼Œå®ƒå¯¹æ¯”çš„æ˜¯çº¿ç¨‹å’Œå¯¹è±¡çš„ Mark Wordï¼ˆå¯¹è±¡å¤´ä¸­çš„ä¸€ä¸ªåŒºåŸŸï¼‰ï¼Œå¦‚æœæ›´æ–°æˆåŠŸåˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹æˆåŠŸæ‹¥æœ‰æ­¤é”ï¼›å¦‚æœå¤±è´¥ï¼Œè™šæ‹Ÿæœºä¼šå…ˆæ£€æŸ¥å¯¹è±¡çš„ Mark Word æ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹çš„æ ˆå¸§ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¯´æ˜å½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰æ­¤é”ï¼Œå¦åˆ™ï¼Œåˆ™è¯´æ˜æ­¤é”å·²ç»è¢«å…¶ä»–çº¿ç¨‹å ç”¨äº†ã€‚å½“ä¸¤ä¸ªä»¥ä¸Šçš„çº¿ç¨‹äº‰æŠ¢æ­¤é”æ—¶ï¼Œè½»é‡çº§é”å°±è†¨èƒ€ä¸ºé‡é‡çº§é”ï¼Œè¿™å°±æ˜¯é”å‡çº§çš„è¿‡ç¨‹ï¼Œä¹Ÿæ˜¯ JDK 1.6 é”ä¼˜åŒ–çš„å†…å®¹ã€‚</p><h3 id="å°ç»“" tabindex="-1">å°ç»“ <a class="header-anchor" href="#å°ç»“" aria-label="Permalink to &quot;å°ç»“&quot;">â€‹</a></h3><p>æœ¬è¯¾æ—¶é¦–å…ˆè®²äº† synchronized å’Œ ReentrantLock çš„å®ç°è¿‡ç¨‹ï¼Œç„¶åè®²äº† synchronized å’Œ ReentrantLock çš„åŒºåˆ«ï¼Œæœ€åé€šè¿‡æºç çš„æ–¹å¼è®²äº† ReentrantLock åŠ é”å’Œè§£é”çš„æ‰§è¡Œæµç¨‹ã€‚æ¥ç€åˆè®²äº† JDK 1.6 ä¸­çš„é”ä¼˜åŒ–ï¼ŒåŒ…æ‹¬è‡ªé€‚åº”å¼è‡ªæ—‹é”çš„å®ç°è¿‡ç¨‹ï¼Œä»¥åŠ synchronized çš„ä¸‰ç§é”çŠ¶æ€å’Œé”å‡çº§çš„æ‰§è¡Œæµç¨‹ã€‚</p><p>synchronized åˆšå¼€å§‹ä¸ºåå‘é”ï¼Œéšç€é”ç«äº‰è¶Šæ¥è¶Šæ¿€çƒˆï¼Œä¼šå‡çº§ä¸ºè½»é‡çº§é”å’Œé‡é‡çº§é”ã€‚å¦‚æœå¤§å¤šæ•°é”è¢«ä¸åŒçš„çº¿ç¨‹æ‰€äº‰æŠ¢å°±ä¸å»ºè®®ä½¿ç”¨åå‘é”äº†ã€‚</p>`,18);function y(i,d,F,A,u,D){const n=l("Image");return p(),o("div",null,[r,e(n,{alt:"",src:"https://s0.lgstatic.com/i/image3/M01/02/7D/Ciqah157DAiAK_DJAAC0JawhGp4730.png"}),c(),E])}const k=a(t,[["render",y]]);export{C as __pageData,k as default};
