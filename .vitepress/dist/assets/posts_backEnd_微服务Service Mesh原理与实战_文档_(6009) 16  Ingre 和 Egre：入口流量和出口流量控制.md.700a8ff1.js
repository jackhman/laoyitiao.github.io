import{_ as o,j as e,o as t,g as c,k as n,h as a,Q as l,s as p}from"./chunks/framework.a0d18f64.js";const B=JSON.parse('{"title":"16Ingre和Egre：入口流量和出口流量控制","description":"","frontmatter":{},"headers":[],"relativePath":"posts/backEnd/微服务Service Mesh原理与实战_文档/(6009) 16  Ingre 和 Egre：入口流量和出口流量控制.md","filePath":"posts/backEnd/微服务Service Mesh原理与实战_文档/(6009) 16  Ingre 和 Egre：入口流量和出口流量控制.md","lastUpdated":1696682708000}'),r={name:"posts/backEnd/微服务Service Mesh原理与实战_文档/(6009) 16  Ingre 和 Egre：入口流量和出口流量控制.md"},y=l(`<h1 id="_16ingre和egre-入口流量和出口流量控制" tabindex="-1">16Ingre和Egre：入口流量和出口流量控制 <a class="header-anchor" href="#_16ingre和egre-入口流量和出口流量控制" aria-label="Permalink to &quot;16Ingre和Egre：入口流量和出口流量控制&quot;">​</a></h1><p>Ingress 是 Kubernetes 集群为了让外部可以访问，引入的一种资源类型。一般 Ingress 为常见的 Nginx 这样的反向代理服务器提供具体功能，诸如负载均衡、SSL 证书卸载，以及基于名称的虚拟主机功能。这些功能是反向代理服务器的基本功能，</p><p><strong>Ingress 可以理解为入口网关</strong> ，而 Egress 和 Ingress 的功能相仿，只是流量的代理流向不同，<strong>Egress 负责出口流量的代理</strong>。</p><p>在讲解 Istio 的 Ingress 之前，我们还是先来看一下传统的 Kubernetes 是如何做 Ingress 代理的。</p><h3 id="为什么需要-ingress" tabindex="-1">为什么需要 Ingress <a class="header-anchor" href="#为什么需要-ingress" aria-label="Permalink to &quot;为什么需要 Ingress&quot;">​</a></h3><p>这里我们需要讲到一些 Kubernetes 的基本知识和概念，你可以把 Kubernetes 集群简单理解为一个内部网络，我们想要在集群外直接访问 Kubernetes 的 Pod IP 是不通的，只能通过一些代理手段<strong>做一次路由转发才可以访问</strong> 。一般来说有两种常用的方式访问 Kubernetes 集群内部的网络，分别是<strong>NodePort 模式和 Ingress 模式</strong>。</p><p>为了更好地理解今天要学习的内容，我们先简单聊一聊 Kubernetes 集群中的一些名词。</p><p>Pod：Pod 是可以在 Kubernetes 中创建和管理的、最小的可部署计算单元，每个 Pod 都有独立的 IP，Pod 内部由多个Container（容器）组成。</p><p>Service：将运行在一组 Pods 上的应用程序公开为网络服务的抽象方法。Service 是一个抽象的概念，等同于微服务中的 Service 概念。</p><p>Node：Kubernetes 通过将容器放入在节点（Node）上运行的 Pod 中执行工作负载。节点可以是一个虚拟机或者物理机器，主要取决于所在的集群配置。</p><p>ClusterIP：Kubernetes 为了让 Service 可以进行内部访问，为每个 Service 提供了一个唯一 IP，通过 ClusterIP 可以访问 Service 对应的一组 Pod。</p><h4 id="nodeport-模式" tabindex="-1">NodePort 模式 <a class="header-anchor" href="#nodeport-模式" aria-label="Permalink to &quot;NodePort 模式&quot;">​</a></h4><p>刚刚我们提到过，集群外部是无法直接访问集群内部的资源的，在 Kubernetes 集群内部，我们可以<strong>通过 Service 的域名访问服务的 Pod</strong>。下面是一个简单的 YAML 配置，这个配置可以让集群外部通过 NodePort 的方式访问集群内部的资源：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">my-service</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NodePort</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">MyApp</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># 默认情况下，为了方便起见，\`targetPort\` 被设置为与 \`port\` 字段相同的值</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># 可选字段</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># 默认情况下，为了方便起见，Kubernetes 控制平面会从某个范围内分配一个端口号（默认：30000-32767）</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">nodePort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">30007</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">my-service</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NodePort</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">MyApp</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># 默认情况下，为了方便起见，\`targetPort\` 被设置为与 \`port\` 字段相同的值</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># 可选字段</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># 默认情况下，为了方便起见，Kubernetes 控制平面会从某个范围内分配一个端口号（默认：30000-32767）</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">nodePort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">30007</span></span></code></pre></div><p>NodePort 的默认端口范围是 30000-32767，但是一般不建议应用程序使用这个端口范围，以免引发冲突。</p><p>如上示例，集群外部首先访问 NodePort 的端口，示例中端口为 30007，<strong>通过 IPVS 一系列的劫持路由操作</strong>，将流量路由到集群内部的 my-service 服务的端口 80，这个端口是 ClusterIP 暴露出来的端口，在 Kubernetes 集群内部可以通过 ClusterIP:Port 的方式访问 my-service 服务。</p><p>至此，集群外部如何访问集群内部的整个流程就串起来了，而下面的 TargetPort 是服务自身的端口，接下来的 Kubernetes 集群内部会通<strong>过服务发现的方式</strong>，将流量转发到服务对应的 Pod IP 的 TargetPort 上面。</p><p>到这里，NodePort 的访问方式我们就讲完了。通过原理的学习你可以了解到，NodePort 的方式存在一些问题，比如<strong>配置方式不灵活</strong>，需要前端的入口层将 upstream 的地址配置为 NodePort 的地址和端口，如果 Kubernetes 集群的 Node 节点所在的机器发生扩容或者缩容，都需要相应做出调整。</p><p>另外，通过几台特定的 Node 机器做数据转发，一旦流量增加，可能会影响该机器宿主机的稳定性。如果集群对外暴露多个服务，维护的难度也随之增加，上面提到的扩缩容问题，会被数倍放大：<strong>一台 Node 机器的变动，需要修改大量的入口服务配置</strong>。</p><p>那么，有没有更好的方式解决 NodePort 的问题呢？接下来我们来看 Ingress 模式。</p><h4 id="ingress-模式" tabindex="-1">Ingress 模式 <a class="header-anchor" href="#ingress-模式" aria-label="Permalink to &quot;Ingress 模式&quot;">​</a></h4><p>客户端通过 Ingress 上定义的路由规则，转发到特定的 Service 上面，比如通过设置 path、header、host 等路由规则来决定具体转发到哪个 Service。</p>`,22),E=l(`<p>Ingress 工作原理图</p><p>通过下面的配置你可以看到，Ingress 是一种全新的资源类型，与所有其他 Kubernetes 资源一样，Ingress 需要使用 apiVersion、kind 和 metadata 字段。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> networking.Kubernetes.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Ingress</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> minimal</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ingress</span></span>
<span class="line"><span style="color:#E1E4E8;">  annotations</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    nginx.ingress.kubernetes.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">rewrite</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">target</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  rules</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> http</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      paths</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> path</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">testpath</span></span>
<span class="line"><span style="color:#E1E4E8;">        pathType</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Prefix</span></span>
<span class="line"><span style="color:#E1E4E8;">        backend</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          service</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> test</span></span>
<span class="line"><span style="color:#E1E4E8;">            port</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">              number</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> networking.Kubernetes.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Ingress</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> minimal</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ingress</span></span>
<span class="line"><span style="color:#24292E;">  annotations</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    nginx.ingress.kubernetes.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">rewrite</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">target</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  rules</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> http</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      paths</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> path</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">testpath</span></span>
<span class="line"><span style="color:#24292E;">        pathType</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Prefix</span></span>
<span class="line"><span style="color:#24292E;">        backend</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">          service</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">            name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> test</span></span>
<span class="line"><span style="color:#24292E;">            port</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">              number</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span></span></code></pre></div><p>我们来看一下， Ingress 资源类型特有的几个字段的含义。</p><ul><li><p>host：可选择和域名匹配的 host，比如如果设置 host 字段 foo.bar.com，则需要通过 foo.bar.com 的域名访问。如果这个例子中没有设置 host 字段，则表明任何域名过来的请求都可以匹配。</p></li><li><p>http.paths.path：用于请求 path 的匹配，比如这个例子通过 pathType:Prefix 前缀匹配的方式，所有 path 中前缀为 /testpath 的路径，都会被匹配到；而其他没有匹配到的 path 就会返回 404。</p></li><li><p>http.paths.backend：其中 name 字段表示服务名，这个服务名和 Kubernetes 中的Service 名称相匹配；port 则是 Service 的端口号，流量会通过 clusterIP:port 的方式被转发到特定服务。</p></li></ul><h4 id="ingressclass-资源类型" tabindex="-1">IngressClass 资源类型 <a class="header-anchor" href="#ingressclass-资源类型" aria-label="Permalink to &quot;IngressClass 资源类型&quot;">​</a></h4><p>在 Kubernetes1.18 版本之前，IngressClass 是通过 Ingress 中的一个 kubernetes.io/ingress.class 注解来指定的，下面我们来看一下从 1.18 开始如何配置 Ingress Class。</p><p>通过在 Ingress 资源类型中<strong>设置 IngressClassName</strong>来指定特定的 IngressClass 配置，IngressClass 的配置如下，其中包含了 ingress-controller 的名称，在这里 ingress-controller 名称为 example.com/ingress-controller：</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">apiVersion</span><span style="color:#E1E4E8;">: networking.k8s.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1</span></span>
<span class="line"><span style="color:#B392F0;">kind</span><span style="color:#E1E4E8;">: IngressClass</span></span>
<span class="line"><span style="color:#B392F0;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">name</span><span style="color:#E1E4E8;">: external</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">lb</span></span>
<span class="line"><span style="color:#B392F0;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">controller</span><span style="color:#E1E4E8;">: example.com</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">ingress</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">controller</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">parameters</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">apiGroup</span><span style="color:#E1E4E8;">: k8s.example.com</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">kind</span><span style="color:#E1E4E8;">: IngressParameters</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">name</span><span style="color:#E1E4E8;">: external</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">lb</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">apiVersion</span><span style="color:#24292E;">: networking.k8s.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1</span></span>
<span class="line"><span style="color:#6F42C1;">kind</span><span style="color:#24292E;">: IngressClass</span></span>
<span class="line"><span style="color:#6F42C1;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">: external</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">lb</span></span>
<span class="line"><span style="color:#6F42C1;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">controller</span><span style="color:#24292E;">: example.com</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">ingress</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">controller</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">parameters</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">apiGroup</span><span style="color:#24292E;">: k8s.example.com</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">kind</span><span style="color:#24292E;">: IngressParameters</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">: external</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">lb</span></span></code></pre></div><p><strong>ingress-controller</strong></p><p>ingress-controller 并不是随着 Kubernetes 集群一起启动的，下面我们先来看一下如何在 Minukube 环境中使用 Nginx ingress-controller。</p><p>启动 Minukube 集群，需要先删除已有的 Minukube 集群：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">minikube delete</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">minikube delete</span></span></code></pre></div><p>然后通过虚拟机方式启动，因为 Ingress 的 Addon 无法在 Docker 模式使用：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">minikube start </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">kubernetes</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">version</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">v1.</span><span style="color:#FDAEB7;font-style:italic;">19</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">vm</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">true</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">minikube start </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">kubernetes</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">version</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">v1.</span><span style="color:#B31D28;font-style:italic;">19</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">vm</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">true</span></span></code></pre></div><p>启动 ingress-controller ：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">minikube addons enable ingress</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">minikube addons enable ingress</span></span></code></pre></div><p>部署 helloapp：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl create deployment web </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">image</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">gcr.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">google</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">samples</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">hello</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">app</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">1.0</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl create deployment web </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">image</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">gcr.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">google</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">samples</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">hello</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">app</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">1.0</span></span></code></pre></div><p>创建 Ingress 资源：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl apply </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f https</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//k8s.io/examples/service/networking/example-ingress.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl apply </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f https</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//k8s.io/examples/service/networking/example-ingress.yaml</span></span></code></pre></div><p>通过 minikube iP 命令获取 Ip 地址，并修改 /etc/hosts，将其添加在文件结尾，代码中 127.0.0.1 就是 minikube ip 获取的 IP：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#E1E4E8;"> hello</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">world.info</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#24292E;"> hello</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">world.info</span></span></code></pre></div><p>通过 cURL 或者浏览器访问 hello-world.info：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">curl hello</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">world.info</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">curl hello</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">world.info</span></span></code></pre></div><p>至此，Kubernetes 原生的 Ingress 就讲完了。Ingress 解决了 NodePod 配置不方便的问题，但通过 YAML 的方式控制 Ingress 依然是一件麻烦事，另外 Ingress 内部依然是使用 ClusterIP 的方式来访问 Service，而这样的方式是通过 IPVS 四层转发做到的。</p><p>在前面的章节中，我们也提到了四层负载均衡存在流量不均衡的问题，那么在 Ingress 中应该如何解决呢？下面我们来看一下 Service Mesh 世界中的 Istio 是如何做 Ingress 的。</p><h4 id="istio-gateway" tabindex="-1">Istio Gateway <a class="header-anchor" href="#istio-gateway" aria-label="Permalink to &quot;Istio Gateway&quot;">​</a></h4><p>Istio 采用了一种新的模型------Istio Gateway 来代替 Kubernetes 中的 Ingress 资源类型。<strong>Gateway 允许外部流量访问内部服务</strong>，得益于 Istio 强大的控制面配置，Gateway 资源类型的配置非常简单，只需要配置流量转发即可。</p><p>先删除已有的 Minukube 集群：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">minikube delete</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">minikube delete</span></span></code></pre></div><p>首先启动 Minikube，并启动 Tunnel：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">minikube start </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">kubernetes</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">version</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">v1.</span><span style="color:#FDAEB7;font-style:italic;">19</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">driver</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">docker</span></span>
<span class="line"><span style="color:#E1E4E8;">minikube tunnel</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">minikube start </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">kubernetes</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">version</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">v1.</span><span style="color:#B31D28;font-style:italic;">19</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">driver</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">docker</span></span>
<span class="line"><span style="color:#24292E;">minikube tunnel</span></span></code></pre></div><p>这样外部就可以通过 Minikube IP 访问集群内部的资源了。</p><p>下面进入 Istio 目录，部署一个测试服务：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl apply </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f samples</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">httpbin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">httpbin.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl apply </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f samples</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">httpbin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">httpbin.yaml</span></span></code></pre></div><p>通过命令查看 Pod 是否成功启动，根据机器配置不同，这里的 Pod 启动可能需要一定的时间，请耐心等待 pod 启动成功：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl get pods</span></span>
<span class="line"><span style="color:#E1E4E8;">NAME                              READY   STATUS     RESTARTS   AGE</span></span>
<span class="line"><span style="color:#E1E4E8;">details</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v1</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">79c697d759</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">gt9th       </span><span style="color:#79B8FF;">2</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">     Running    </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">95d</span></span>
<span class="line"><span style="color:#E1E4E8;">httpbin</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">74fb669cc6</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">jzs87          </span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">     Init</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          7s</span></span>
<span class="line"><span style="color:#E1E4E8;">productpage</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v1</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">65576bb7bf</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">wjkjm   </span><span style="color:#79B8FF;">2</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">     Running    </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">95d</span></span>
<span class="line"><span style="color:#E1E4E8;">ratings</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v1</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">7d99676f7f</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">h9blt       </span><span style="color:#79B8FF;">2</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">     Running    </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">95d</span></span>
<span class="line"><span style="color:#E1E4E8;">reviews</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v1</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">987d495c</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">pmnb9         </span><span style="color:#79B8FF;">2</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">     Running    </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">95d</span></span>
<span class="line"><span style="color:#E1E4E8;">reviews</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v2</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">6c5bf657cf</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">qd2kr       </span><span style="color:#79B8FF;">2</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">     Running    </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">95d</span></span>
<span class="line"><span style="color:#E1E4E8;">reviews</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v3</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">5f7b9f4f77</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">gnv4c       </span><span style="color:#79B8FF;">2</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">     Running    </span><span style="color:#79B8FF;">7</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">95d</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl get pods</span></span>
<span class="line"><span style="color:#24292E;">NAME                              READY   STATUS     RESTARTS   AGE</span></span>
<span class="line"><span style="color:#24292E;">details</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v1</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">79c697d759</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">gt9th       </span><span style="color:#005CC5;">2</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">     Running    </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">95d</span></span>
<span class="line"><span style="color:#24292E;">httpbin</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">74fb669cc6</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">jzs87          </span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">     Init</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          7s</span></span>
<span class="line"><span style="color:#24292E;">productpage</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v1</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">65576bb7bf</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">wjkjm   </span><span style="color:#005CC5;">2</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">     Running    </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">95d</span></span>
<span class="line"><span style="color:#24292E;">ratings</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v1</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">7d99676f7f</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">h9blt       </span><span style="color:#005CC5;">2</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">     Running    </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">95d</span></span>
<span class="line"><span style="color:#24292E;">reviews</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v1</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">987d495c</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">pmnb9         </span><span style="color:#005CC5;">2</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">     Running    </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">95d</span></span>
<span class="line"><span style="color:#24292E;">reviews</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v2</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">6c5bf657cf</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">qd2kr       </span><span style="color:#005CC5;">2</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">     Running    </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">95d</span></span>
<span class="line"><span style="color:#24292E;">reviews</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v3</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">5f7b9f4f77</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">gnv4c       </span><span style="color:#005CC5;">2</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">     Running    </span><span style="color:#005CC5;">7</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">95d</span></span></code></pre></div><p>创建 Istio Gateway，注意：<strong>这里设置了 hosts 为 httpbin.example.com</strong>，也就是只有 host 为httpbin.example.com 才能正确访问 httpbin 的服务：</p><pre><code>kubectl apply -f - &lt;&lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: httpbin-gateway
spec:
  selector:
    istio: ingressgateway # use Istio default gateway implementation
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - &quot;httpbin.example.com&quot;
EOF
</code></pre><p>将 httpbin 服务暴露给 Istio Gateway，其中 destination 中的 host 字段为 Istio Service 配置中的服务名，Envoy 会通过<strong>服务发现</strong>的方式将流量路由到 httpbin 对应的 Pod IP：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl apply </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#E1E4E8;">EOF</span></span>
<span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> networking.istio.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1alpha3</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> VirtualService</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> httpbin</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  hosts</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;httpbin.example.com&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  gateways</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> httpbin</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">gateway</span></span>
<span class="line"><span style="color:#E1E4E8;">  http</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> match</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> uri</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        prefix</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">status</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> uri</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        prefix</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">delay</span></span>
<span class="line"><span style="color:#E1E4E8;">    route</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> destination</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        port</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          number</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8000</span></span>
<span class="line"><span style="color:#E1E4E8;">        host</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> httpbin</span></span>
<span class="line"><span style="color:#E1E4E8;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl apply </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#24292E;">EOF</span></span>
<span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> networking.istio.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1alpha3</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> VirtualService</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> httpbin</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  hosts</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;httpbin.example.com&quot;</span></span>
<span class="line"><span style="color:#24292E;">  gateways</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> httpbin</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">gateway</span></span>
<span class="line"><span style="color:#24292E;">  http</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> match</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> uri</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        prefix</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">status</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> uri</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        prefix</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">delay</span></span>
<span class="line"><span style="color:#24292E;">    route</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> destination</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        port</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">          number</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8000</span></span>
<span class="line"><span style="color:#24292E;">        host</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> httpbin</span></span>
<span class="line"><span style="color:#24292E;">EOF</span></span></code></pre></div><p>接下来，我们通过 cURL 访问特定的 URL Path 就可以访问该服务了，这里需要注意的是：<strong>需要设置 host 为 httpbin.example.com</strong> 。因为在前面的 Gateway 配置中，我们绑定了 host，当然你也可以通过<strong>修改 /etc/hosts</strong> 来绑定域名为本地地址：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">curl </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">I </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">HHost</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">httpbin.example.com http</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//127.0.0.1/status/200</span></span>
<span class="line"><span style="color:#E1E4E8;">HTTP</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1.1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> OK</span></span>
<span class="line"><span style="color:#E1E4E8;">server</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">envoy</span></span>
<span class="line"><span style="color:#E1E4E8;">date</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Mon, 08 Feb </span><span style="color:#79B8FF;">2021</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">04</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">42</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">54</span><span style="color:#E1E4E8;"> GMT</span></span>
<span class="line"><span style="color:#E1E4E8;">content</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">type</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> text</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">html; charset</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">utf</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">8</span></span>
<span class="line"><span style="color:#E1E4E8;">access</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">control</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">allow</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">origin</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span></span>
<span class="line"><span style="color:#E1E4E8;">access</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">control</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">allow</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">credentials</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">content</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">length</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">x</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">envoy</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">upstream</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">service</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">time</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">327</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">curl </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">I </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">HHost</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">httpbin.example.com http</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//127.0.0.1/status/200</span></span>
<span class="line"><span style="color:#24292E;">HTTP</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1.1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> OK</span></span>
<span class="line"><span style="color:#24292E;">server</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">envoy</span></span>
<span class="line"><span style="color:#24292E;">date</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Mon, 08 Feb </span><span style="color:#005CC5;">2021</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">04</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">42</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">54</span><span style="color:#24292E;"> GMT</span></span>
<span class="line"><span style="color:#24292E;">content</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">type</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> text</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">html; charset</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">utf</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">8</span></span>
<span class="line"><span style="color:#24292E;">access</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">control</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">allow</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">origin</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span></span>
<span class="line"><span style="color:#24292E;">access</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">control</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">allow</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">credentials</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">content</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">length</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">x</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">envoy</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">upstream</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">service</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">time</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">327</span></span></code></pre></div><p>如果没有匹配到路由规则，则会返回404：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ curl </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">I </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">HHost</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">httpbin.example.com http</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//127.0.0.1/1status/200</span></span>
<span class="line"><span style="color:#E1E4E8;">HTTP</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1.1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">404</span><span style="color:#E1E4E8;"> Not Found</span></span>
<span class="line"><span style="color:#E1E4E8;">date</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Mon, 08 Feb </span><span style="color:#79B8FF;">2021</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">04</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">45</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> GMT</span></span>
<span class="line"><span style="color:#E1E4E8;">server</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">envoy</span></span>
<span class="line"><span style="color:#E1E4E8;">transfer</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">encoding</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> chunked</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ curl </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">I </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">HHost</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">httpbin.example.com http</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//127.0.0.1/1status/200</span></span>
<span class="line"><span style="color:#24292E;">HTTP</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1.1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">404</span><span style="color:#24292E;"> Not Found</span></span>
<span class="line"><span style="color:#24292E;">date</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Mon, 08 Feb </span><span style="color:#005CC5;">2021</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">04</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">45</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> GMT</span></span>
<span class="line"><span style="color:#24292E;">server</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">envoy</span></span>
<span class="line"><span style="color:#24292E;">transfer</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">encoding</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> chunked</span></span></code></pre></div><p>通过命令查看 Envoy 日志，这里的 httpbin-74fb669cc6-jzs87 是通过上面 kubectl get pods 命令获取到的 Pod 名称，需要加上 -c container 的名称来查看 Envoy 的日志：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> kubectl logs  httpbin</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">74fb669cc6</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">jzs87 </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">c istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">proxy</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> kubectl logs  httpbin</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">74fb669cc6</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">jzs87 </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">c istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">proxy</span></span></code></pre></div><p>这里我列了几条刚才访问产生的 Envoy 日志，你可以看到有正确的 200 日志和错误的 404 日志：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#79B8FF;">2021</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">02</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">08T04</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">29</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">17.</span><span style="color:#FDAEB7;font-style:italic;">701261Z</span><span style="color:#E1E4E8;">	info	Envoy proxy is ready</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2021</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">02</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">08T04</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">42</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">54.</span><span style="color:#FDAEB7;font-style:italic;">644Z</span><span style="color:#E1E4E8;">] </span><span style="color:#9ECBFF;">&quot;HEAD /status/200 HTTP/1.1&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">225</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">199</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;172.17.0.2&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;curl/7.54.0&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;be1d93ab-32b3-9882-8c34-87dd39ddf6ab&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;httpbin.example.com&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;127.0.0.1:80&quot;</span><span style="color:#E1E4E8;"> inbound</span><span style="color:#F97583;">|</span><span style="color:#79B8FF;">8000</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">http</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">httpbin.default.svc.cluster.local </span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">34580</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">16</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.17</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">2</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> outbound_.</span><span style="color:#FDAEB7;font-style:italic;">8000_</span><span style="color:#E1E4E8;">._.httpbin.default.svc.cluster.local </span><span style="color:#F97583;">default</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2021</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">02</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">08T04</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">45</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">14.</span><span style="color:#FDAEB7;font-style:italic;">862Z</span><span style="color:#E1E4E8;">] </span><span style="color:#9ECBFF;">&quot;HEAD /status2/200 HTTP/1.1&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">404</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">351</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">337</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;172.17.0.2&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;curl/7.54.0&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;b433ee7d-6f89-9854-bee7-eeed33884003&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;httpbin.example.com&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;127.0.0.1:80&quot;</span><span style="color:#E1E4E8;"> inbound</span><span style="color:#F97583;">|</span><span style="color:#79B8FF;">8000</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">http</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">httpbin.default.svc.cluster.local </span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">36896</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">16</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.17</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">2</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> outbound_.</span><span style="color:#FDAEB7;font-style:italic;">8000_</span><span style="color:#E1E4E8;">._.httpbin.default.svc.cluster.local </span><span style="color:#F97583;">default</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2021</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">02</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">08T04</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">45</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">57.</span><span style="color:#FDAEB7;font-style:italic;">688Z</span><span style="color:#E1E4E8;">] </span><span style="color:#9ECBFF;">&quot;HEAD /status/500 HTTP/1.1&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">500</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">11</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;172.17.0.2&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;curl/7.54.0&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;5ca2dbf4-473f-9dd0-97a0-397a98f2805c&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;httpbin.example.com&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;127.0.0.1:80&quot;</span><span style="color:#E1E4E8;"> inbound</span><span style="color:#F97583;">|</span><span style="color:#79B8FF;">8000</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">http</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">httpbin.default.svc.cluster.local </span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">37604</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">16</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.17</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">2</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> outbound_.</span><span style="color:#FDAEB7;font-style:italic;">8000_</span><span style="color:#E1E4E8;">._.httpbin.default.svc.cluster.local </span><span style="color:#F97583;">default</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2021</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">02</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">08T04</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">46</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">04</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">233Z</span><span style="color:#E1E4E8;">] </span><span style="color:#9ECBFF;">&quot;HEAD /status/400 HTTP/1.1&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">400</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;172.17.0.2&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;curl/7.54.0&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;4c6e9a80-74f4-98bb-ba3e-8140a4a16099&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;httpbin.example.com&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;127.0.0.1:80&quot;</span><span style="color:#E1E4E8;"> inbound</span><span style="color:#F97583;">|</span><span style="color:#79B8FF;">8000</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">http</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">httpbin.default.svc.cluster.local </span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">37722</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">16</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.17</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">2</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> outbound_.</span><span style="color:#FDAEB7;font-style:italic;">8000_</span><span style="color:#E1E4E8;">._.httpbin.default.svc.cluster.local </span><span style="color:#F97583;">default</span></span>
<span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2021</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">02</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">08T04</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">53</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">33.</span><span style="color:#FDAEB7;font-style:italic;">695Z</span><span style="color:#E1E4E8;">] </span><span style="color:#9ECBFF;">&quot;HEAD /status/500 HTTP/1.1&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">500</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;172.17.0.2&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;curl/7.54.0&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;6865f4bf-c407-9fa2-a6e2-f14668a9ba63&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;httpbin.example.com&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;127.0.0.1:80&quot;</span><span style="color:#E1E4E8;"> inbound</span><span style="color:#F97583;">|</span><span style="color:#79B8FF;">8000</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">http</span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;">httpbin.default.svc.cluster.local </span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">45104</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">16</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.17</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">2</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> outbound_.</span><span style="color:#FDAEB7;font-style:italic;">8000_</span><span style="color:#E1E4E8;">._.httpbin.default.svc.cluster.local </span><span style="color:#F97583;">default</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#005CC5;">2021</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">02</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">08T04</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">29</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">17.</span><span style="color:#B31D28;font-style:italic;">701261Z</span><span style="color:#24292E;">	info	Envoy proxy is ready</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2021</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">02</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">08T04</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">42</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">54.</span><span style="color:#B31D28;font-style:italic;">644Z</span><span style="color:#24292E;">] </span><span style="color:#032F62;">&quot;HEAD /status/200 HTTP/1.1&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">225</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">199</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;172.17.0.2&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;curl/7.54.0&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;be1d93ab-32b3-9882-8c34-87dd39ddf6ab&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;httpbin.example.com&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;127.0.0.1:80&quot;</span><span style="color:#24292E;"> inbound</span><span style="color:#D73A49;">|</span><span style="color:#005CC5;">8000</span><span style="color:#D73A49;">|</span><span style="color:#24292E;">http</span><span style="color:#D73A49;">|</span><span style="color:#24292E;">httpbin.default.svc.cluster.local </span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">34580</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">16</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.17</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">2</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> outbound_.</span><span style="color:#B31D28;font-style:italic;">8000_</span><span style="color:#24292E;">._.httpbin.default.svc.cluster.local </span><span style="color:#D73A49;">default</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2021</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">02</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">08T04</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">45</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">14.</span><span style="color:#B31D28;font-style:italic;">862Z</span><span style="color:#24292E;">] </span><span style="color:#032F62;">&quot;HEAD /status2/200 HTTP/1.1&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">404</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">351</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">337</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;172.17.0.2&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;curl/7.54.0&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;b433ee7d-6f89-9854-bee7-eeed33884003&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;httpbin.example.com&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;127.0.0.1:80&quot;</span><span style="color:#24292E;"> inbound</span><span style="color:#D73A49;">|</span><span style="color:#005CC5;">8000</span><span style="color:#D73A49;">|</span><span style="color:#24292E;">http</span><span style="color:#D73A49;">|</span><span style="color:#24292E;">httpbin.default.svc.cluster.local </span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">36896</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">16</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.17</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">2</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> outbound_.</span><span style="color:#B31D28;font-style:italic;">8000_</span><span style="color:#24292E;">._.httpbin.default.svc.cluster.local </span><span style="color:#D73A49;">default</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2021</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">02</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">08T04</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">45</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">57.</span><span style="color:#B31D28;font-style:italic;">688Z</span><span style="color:#24292E;">] </span><span style="color:#032F62;">&quot;HEAD /status/500 HTTP/1.1&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">500</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">14</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">11</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;172.17.0.2&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;curl/7.54.0&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;5ca2dbf4-473f-9dd0-97a0-397a98f2805c&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;httpbin.example.com&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;127.0.0.1:80&quot;</span><span style="color:#24292E;"> inbound</span><span style="color:#D73A49;">|</span><span style="color:#005CC5;">8000</span><span style="color:#D73A49;">|</span><span style="color:#24292E;">http</span><span style="color:#D73A49;">|</span><span style="color:#24292E;">httpbin.default.svc.cluster.local </span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">37604</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">16</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.17</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">2</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> outbound_.</span><span style="color:#B31D28;font-style:italic;">8000_</span><span style="color:#24292E;">._.httpbin.default.svc.cluster.local </span><span style="color:#D73A49;">default</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2021</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">02</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">08T04</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">46</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">04</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">233Z</span><span style="color:#24292E;">] </span><span style="color:#032F62;">&quot;HEAD /status/400 HTTP/1.1&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">400</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;172.17.0.2&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;curl/7.54.0&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;4c6e9a80-74f4-98bb-ba3e-8140a4a16099&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;httpbin.example.com&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;127.0.0.1:80&quot;</span><span style="color:#24292E;"> inbound</span><span style="color:#D73A49;">|</span><span style="color:#005CC5;">8000</span><span style="color:#D73A49;">|</span><span style="color:#24292E;">http</span><span style="color:#D73A49;">|</span><span style="color:#24292E;">httpbin.default.svc.cluster.local </span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">37722</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">16</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.17</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">2</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> outbound_.</span><span style="color:#B31D28;font-style:italic;">8000_</span><span style="color:#24292E;">._.httpbin.default.svc.cluster.local </span><span style="color:#D73A49;">default</span></span>
<span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2021</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">02</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">08T04</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">53</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">33.</span><span style="color:#B31D28;font-style:italic;">695Z</span><span style="color:#24292E;">] </span><span style="color:#032F62;">&quot;HEAD /status/500 HTTP/1.1&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">500</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;172.17.0.2&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;curl/7.54.0&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;6865f4bf-c407-9fa2-a6e2-f14668a9ba63&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;httpbin.example.com&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;127.0.0.1:80&quot;</span><span style="color:#24292E;"> inbound</span><span style="color:#D73A49;">|</span><span style="color:#005CC5;">8000</span><span style="color:#D73A49;">|</span><span style="color:#24292E;">http</span><span style="color:#D73A49;">|</span><span style="color:#24292E;">httpbin.default.svc.cluster.local </span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">45104</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">16</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.17</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">2</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> outbound_.</span><span style="color:#B31D28;font-style:italic;">8000_</span><span style="color:#24292E;">._.httpbin.default.svc.cluster.local </span><span style="color:#D73A49;">default</span></span></code></pre></div><p>最后，可以通过命令，清除 httpbin 服务和相关的 Istio Gateway 配置：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl delete gateway httpbin</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">gateway</span></span>
<span class="line"><span style="color:#E1E4E8;">$ kubectl delete virtualservice httpbin</span></span>
<span class="line"><span style="color:#E1E4E8;">$ kubectl delete </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">ignore</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">not</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">found</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f samples</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">httpbin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">httpbin.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl delete gateway httpbin</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">gateway</span></span>
<span class="line"><span style="color:#24292E;">$ kubectl delete virtualservice httpbin</span></span>
<span class="line"><span style="color:#24292E;">$ kubectl delete </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">ignore</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">not</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">found</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">true</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f samples</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">httpbin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">httpbin.yaml</span></span></code></pre></div><p>至此，Istio 的外部访问方式------Gateway 资源类型，就学习完成了，Gateway 类型利用 Envoy 的强大功能，可以实现路由层丰富的配置。这些功能和网格内部提供的功能、配置方式一样，包括<strong>熔断、丰富的负载均衡策略、服务发现、金丝雀发布</strong> 等，通过<strong>服务发现</strong> 的方式你也可以<strong>解决 Kubernetes Ingress 四层路由的缺陷</strong>。</p><p>接下来，我们继续学习 Egress 出口流量控制。</p><h3 id="egress-出口流量" tabindex="-1">Egress 出口流量 <a class="header-anchor" href="#egress-出口流量" aria-label="Permalink to &quot;Egress 出口流量&quot;">​</a></h3><p>Egress 出口流量是云原生引入的新的设计模式和架构，在传统的 Web 架构中，很少有出口网关的概念。通过 Egress 架构的学习，可以拓展我们在微服务治理中的思维方式，在学习 Egress 过程中，我也会讲到如何通过 Egress 架构赋能传统微服务架构。</p><p>在学习 Istio Egress 以前，我们先来了解下 Kubernetes 中的 Egress 。</p><h4 id="kubernetes-中的-egress" tabindex="-1">Kubernetes 中的 Egress <a class="header-anchor" href="#kubernetes-中的-egress" aria-label="Permalink to &quot;Kubernetes 中的 Egress&quot;">​</a></h4><p>相较于 Kubernetes 中 Ingress 的强大功能，Kubernetes 中的 Egress 就显得比较弱了，Kubernetes 的 Egress 并没有引入像 Nginx 这样的七层负载均衡器，只是<strong>在 IP 地址或端口层面（OSI 第 3 层或第 4 层）控制网络流量</strong>。</p><p>下面我们通过一个简单的配置进行学习下。</p><p>通过 Network Policy 的资源，可以配置在三层或者四层网络的 Ingress 或者 Egress 策略。这里的配置设置了一些 IP 和端口的黑白名单：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> networking.k8s.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> NetworkPolicy</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> test</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">network</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">policy</span></span>
<span class="line"><span style="color:#E1E4E8;">  namespace</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">default</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  podSelector</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    matchLabels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      role</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> db</span></span>
<span class="line"><span style="color:#E1E4E8;">  policyTypes</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> Ingress</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> Egress</span></span>
<span class="line"><span style="color:#E1E4E8;">  ingress</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> from</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> ipBlock</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        cidr</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.17</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">16</span></span>
<span class="line"><span style="color:#E1E4E8;">        except</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.17</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">24</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> namespaceSelector</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        matchLabels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          project</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> myproject</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> podSelector</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        matchLabels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          role</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> frontend</span></span>
<span class="line"><span style="color:#E1E4E8;">    ports</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> protocol</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">      port</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6379</span></span>
<span class="line"><span style="color:#E1E4E8;">  egress</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> to</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> ipBlock</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        cidr</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">24</span></span>
<span class="line"><span style="color:#E1E4E8;">    ports</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> protocol</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">      port</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5978</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> networking.k8s.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> NetworkPolicy</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> test</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">network</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">policy</span></span>
<span class="line"><span style="color:#24292E;">  namespace</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">default</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  podSelector</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    matchLabels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      role</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> db</span></span>
<span class="line"><span style="color:#24292E;">  policyTypes</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> Ingress</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> Egress</span></span>
<span class="line"><span style="color:#24292E;">  ingress</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> from</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> ipBlock</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        cidr</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.17</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">16</span></span>
<span class="line"><span style="color:#24292E;">        except</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.17</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">24</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> namespaceSelector</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        matchLabels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">          project</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> myproject</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> podSelector</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        matchLabels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">          role</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> frontend</span></span>
<span class="line"><span style="color:#24292E;">    ports</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> protocol</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> TCP</span></span>
<span class="line"><span style="color:#24292E;">      port</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6379</span></span>
<span class="line"><span style="color:#24292E;">  egress</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> to</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> ipBlock</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        cidr</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">24</span></span>
<span class="line"><span style="color:#24292E;">    ports</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> protocol</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> TCP</span></span>
<span class="line"><span style="color:#24292E;">      port</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5978</span></span></code></pre></div><h4 id="istio-egress" tabindex="-1">Istio Egress <a class="header-anchor" href="#istio-egress" aria-label="Permalink to &quot;Istio Egress&quot;">​</a></h4><p>Istio Egress 和 Kubernetes 中的 Egress 不同，<strong>Istio的 Egress 本质上是一个 Envoy Proxy</strong> ，通过 Envoy 强大的<strong>七层代理功能</strong>，提供丰富的路由策略，而不局限于简单的四层网络 IP 端口黑白名单的配置。</p><p>通过下面的架构图，你可以看到每个服务的本地 Proxy 可以通过连接到 Egress Gateway 访问外部服务，达到精准的安全策略控制。</p>`,65),i=l(`<p>Istio Egress 工作原理示意图</p><p>下面我们通过一个简单的例子，来学习 Istio Egress。</p><p>首先创建一个新的服务 Sleep：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl apply </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f samples</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sleep</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sleep.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl apply </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f samples</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sleep</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sleep.yaml</span></span></code></pre></div><p>设置 Pod 的环境变量：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">export SOURCE_POD</span><span style="color:#F97583;">=</span><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;">(kubectl get pod </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">l app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">sleep </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">o jsonpath</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">{.items..metadata.name})</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">export SOURCE_POD</span><span style="color:#D73A49;">=</span><span style="color:#6F42C1;">$</span><span style="color:#24292E;">(kubectl get pod </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">l app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">sleep </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">o jsonpath</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">{.items..metadata.name})</span></span></code></pre></div><p>在设置策略之前，我们先尝试从 Pod 内部访问外部服务：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl exec </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">it $SOURCE_POD </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">c sleep </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;"> curl </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">I https</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//www.douban.com | grep  &quot;HTTP/&quot;; kubectl exec -it $SOURCE_POD -c sleep -- curl -I https://edition.cnn.com | grep &quot;HTTP/&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl exec </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">it $SOURCE_POD </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">c sleep </span><span style="color:#D73A49;">--</span><span style="color:#24292E;"> curl </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">I https</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//www.douban.com | grep  &quot;HTTP/&quot;; kubectl exec -it $SOURCE_POD -c sleep -- curl -I https://edition.cnn.com | grep &quot;HTTP/&quot;</span></span></code></pre></div><p>可以得到以下结果，表明访问外部正常：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">HTTP</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1.1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> OK</span></span>
<span class="line"><span style="color:#E1E4E8;">HTTP</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">HTTP</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1.1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> OK</span></span>
<span class="line"><span style="color:#24292E;">HTTP</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span></span></code></pre></div><p>通过下述命令，查看 Istio Egress Gateway 是否部署：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl get pod </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">l istio</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">egressgateway </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">n istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">system</span></span>
<span class="line"><span style="color:#E1E4E8;">NAME                                   READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#E1E4E8;">istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">egressgateway</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">8556f8c8dc</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">4tkn7   </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">95d</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl get pod </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">l istio</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">egressgateway </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">n istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">system</span></span>
<span class="line"><span style="color:#24292E;">NAME                                   READY   STATUS    RESTARTS   AGE</span></span>
<span class="line"><span style="color:#24292E;">istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">egressgateway</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">8556f8c8dc</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">4tkn7   </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">95d</span></span></code></pre></div><p>创建一个 ServiceEntry，允许流量直接访问一个外部服务：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl apply </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#E1E4E8;">EOF</span></span>
<span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> networking.istio.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1alpha3</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> ServiceEntry</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> cnn</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  hosts</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> edition.cnn.com</span></span>
<span class="line"><span style="color:#E1E4E8;">  ports</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> number</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> http</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">port</span></span>
<span class="line"><span style="color:#E1E4E8;">    protocol</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> HTTP</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> number</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">443</span></span>
<span class="line"><span style="color:#E1E4E8;">    name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> https</span></span>
<span class="line"><span style="color:#E1E4E8;">    protocol</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> HTTPS</span></span>
<span class="line"><span style="color:#E1E4E8;">  resolution</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> DNS</span></span>
<span class="line"><span style="color:#E1E4E8;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl apply </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#24292E;">EOF</span></span>
<span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> networking.istio.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1alpha3</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> ServiceEntry</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> cnn</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  hosts</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> edition.cnn.com</span></span>
<span class="line"><span style="color:#24292E;">  ports</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> number</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> http</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">port</span></span>
<span class="line"><span style="color:#24292E;">    protocol</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> HTTP</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> number</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">443</span></span>
<span class="line"><span style="color:#24292E;">    name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> https</span></span>
<span class="line"><span style="color:#24292E;">    protocol</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> HTTPS</span></span>
<span class="line"><span style="color:#24292E;">  resolution</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> DNS</span></span>
<span class="line"><span style="color:#24292E;">EOF</span></span></code></pre></div><p>为 edition.cnn.com 端口 80 创建 Egress Gateway，并为指向 Egress Gateway 的流量创建一个 Destination Rule：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl apply </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#E1E4E8;">EOF</span></span>
<span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> networking.istio.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1alpha3</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Gateway</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">egressgateway</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  selector</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    istio</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> egressgateway</span></span>
<span class="line"><span style="color:#E1E4E8;">  servers</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> port</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      number</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">      name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> http</span></span>
<span class="line"><span style="color:#E1E4E8;">      protocol</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> HTTP</span></span>
<span class="line"><span style="color:#E1E4E8;">    hosts</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> edition.cnn.com</span></span>
<span class="line"><span style="color:#F97583;">---</span></span>
<span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> networking.istio.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1alpha3</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> DestinationRule</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> egressgateway</span><span style="color:#F97583;">-for-</span><span style="color:#E1E4E8;">cnn</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  host</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">egressgateway.istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">system.svc.cluster.local</span></span>
<span class="line"><span style="color:#E1E4E8;">  subsets</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> cnn</span></span>
<span class="line"><span style="color:#E1E4E8;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl apply </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#24292E;">EOF</span></span>
<span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> networking.istio.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1alpha3</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Gateway</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">egressgateway</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  selector</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    istio</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> egressgateway</span></span>
<span class="line"><span style="color:#24292E;">  servers</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> port</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      number</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">      name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> http</span></span>
<span class="line"><span style="color:#24292E;">      protocol</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> HTTP</span></span>
<span class="line"><span style="color:#24292E;">    hosts</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> edition.cnn.com</span></span>
<span class="line"><span style="color:#D73A49;">---</span></span>
<span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> networking.istio.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1alpha3</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> DestinationRule</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> egressgateway</span><span style="color:#D73A49;">-for-</span><span style="color:#24292E;">cnn</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  host</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">egressgateway.istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">system.svc.cluster.local</span></span>
<span class="line"><span style="color:#24292E;">  subsets</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> cnn</span></span>
<span class="line"><span style="color:#24292E;">EOF</span></span></code></pre></div><p>定义一个 VirtualService，将流量从 Sidecar 引导至 Egress Gateway，再从 Egress Gateway 引导至外部服务：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl apply </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#E1E4E8;">EOF</span></span>
<span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> networking.istio.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1alpha3</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> VirtualService</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> direct</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">cnn</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">through</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">egress</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">gateway</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  hosts</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> edition.cnn.com</span></span>
<span class="line"><span style="color:#E1E4E8;">  gateways</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">egressgateway</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> mesh</span></span>
<span class="line"><span style="color:#E1E4E8;">  http</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> match</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> gateways</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> mesh</span></span>
<span class="line"><span style="color:#E1E4E8;">      port</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    route</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> destination</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        host</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">egressgateway.istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">system.svc.cluster.local</span></span>
<span class="line"><span style="color:#E1E4E8;">        subset</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> cnn</span></span>
<span class="line"><span style="color:#E1E4E8;">        port</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          number</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">      weight</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> match</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> gateways</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">egressgateway</span></span>
<span class="line"><span style="color:#E1E4E8;">      port</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    route</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> destination</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        host</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> edition.cnn.com</span></span>
<span class="line"><span style="color:#E1E4E8;">        port</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          number</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">      weight</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">100</span></span>
<span class="line"><span style="color:#E1E4E8;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl apply </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#24292E;">EOF</span></span>
<span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> networking.istio.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1alpha3</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> VirtualService</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> direct</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">cnn</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">through</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">egress</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">gateway</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  hosts</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> edition.cnn.com</span></span>
<span class="line"><span style="color:#24292E;">  gateways</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">egressgateway</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> mesh</span></span>
<span class="line"><span style="color:#24292E;">  http</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> match</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> gateways</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> mesh</span></span>
<span class="line"><span style="color:#24292E;">      port</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    route</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> destination</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        host</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">egressgateway.istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">system.svc.cluster.local</span></span>
<span class="line"><span style="color:#24292E;">        subset</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> cnn</span></span>
<span class="line"><span style="color:#24292E;">        port</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">          number</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">      weight</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> match</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> gateways</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">egressgateway</span></span>
<span class="line"><span style="color:#24292E;">      port</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    route</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> destination</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        host</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> edition.cnn.com</span></span>
<span class="line"><span style="color:#24292E;">        port</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">          number</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">      weight</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">100</span></span>
<span class="line"><span style="color:#24292E;">EOF</span></span></code></pre></div><p>访问外部第三方服务：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl exec </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">it $SOURCE_POD </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">c sleep </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;"> curl </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">sL </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">o </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">dev</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">D </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> http</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//edition.cnn.com/politics</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl exec </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">it $SOURCE_POD </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">c sleep </span><span style="color:#D73A49;">--</span><span style="color:#24292E;"> curl </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">sL </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">o </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">dev</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">null</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">D </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> http</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//edition.cnn.com/politics</span></span></code></pre></div><p>查看 istio-egressgateway 日志：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl logs </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">l istio</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">egressgateway </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">c istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">proxy </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">n istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">system </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> tail</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl logs </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">l istio</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">egressgateway </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">c istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">proxy </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">n istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">system </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> tail</span></span></code></pre></div><p>可以看到如下日志，表明流量经过了 Egress Gateway：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2021</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">02</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">08T06</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">02</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">46.</span><span style="color:#FDAEB7;font-style:italic;">098Z</span><span style="color:#E1E4E8;">] </span><span style="color:#9ECBFF;">&quot;GET /politics HTTP/2&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">301</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;-&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">162</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">147</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;172.18.0.17&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;curl/7.69.1&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;57d13492-b521-961b-bd93-90ab3f0e295e&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;edition.cnn.com&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;151.101.129.67:80&quot;</span><span style="color:#E1E4E8;"> outbound</span><span style="color:#F97583;">|</span><span style="color:#79B8FF;">80</span><span style="color:#F97583;">||</span><span style="color:#E1E4E8;">edition.cnn.com </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">4</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">41758</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">4</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">8080</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">17</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">32816</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">[</span><span style="color:#005CC5;">2021</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">02</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">08T06</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">02</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">46.</span><span style="color:#B31D28;font-style:italic;">098Z</span><span style="color:#24292E;">] </span><span style="color:#032F62;">&quot;GET /politics HTTP/2&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">301</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;-&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">162</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">147</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;172.18.0.17&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;curl/7.69.1&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;57d13492-b521-961b-bd93-90ab3f0e295e&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;edition.cnn.com&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;151.101.129.67:80&quot;</span><span style="color:#24292E;"> outbound</span><span style="color:#D73A49;">|</span><span style="color:#005CC5;">80</span><span style="color:#D73A49;">||</span><span style="color:#24292E;">edition.cnn.com </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">4</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">41758</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">4</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">8080</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">17</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">32816</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span></span></code></pre></div><p>清除服务相关配置：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl delete gateway istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">egressgateway</span></span>
<span class="line"><span style="color:#E1E4E8;">$ kubectl delete serviceentry cnn</span></span>
<span class="line"><span style="color:#E1E4E8;">$ kubectl delete virtualservice direct</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">cnn</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">through</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">egress</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">gateway</span></span>
<span class="line"><span style="color:#E1E4E8;">$ kubectl delete destinationrule egressgateway</span><span style="color:#F97583;">-for-</span><span style="color:#E1E4E8;">cnn</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl delete gateway istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">egressgateway</span></span>
<span class="line"><span style="color:#24292E;">$ kubectl delete serviceentry cnn</span></span>
<span class="line"><span style="color:#24292E;">$ kubectl delete virtualservice direct</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">cnn</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">through</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">egress</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">gateway</span></span>
<span class="line"><span style="color:#24292E;">$ kubectl delete destinationrule egressgateway</span><span style="color:#D73A49;">-for-</span><span style="color:#24292E;">cnn</span></span></code></pre></div><p>至此，Istio Egress Gateway 就配置完成了，通过这部分的学习，我们可以看到 Istio Egress Gateway 的强大配置，通过 Egress Gateway 我们可以<strong>对外部流量进行权限控制和精准的路由匹配访问</strong>。</p><p>在实际工作的项目中，我借鉴了 Istio Egress Gateway 的思想，<strong>将所有外部第三方服务的访问流量都转发到 Egress Gateway</strong> ，经由 Egress Gateway 访问出去，通过这样的方式可以大大<strong>降低外部服务访问的延时，维持 HTTP 的 KeepAlive 长连接</strong>。因为如果服务的机器数量过多，访问外部频率又不是很高，与外部服务的连接就很容易断掉，不得不重新建连，而现在大多数外部服务都是 HTTPS 的，需要消耗过多的 SSL 握手时间。</p><h3 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>这一讲我主要介绍了 Ingress 和 Egress：入口流量和出口流量控制。通过今天的学习，相信你已经了解了 Kubernetes和 Istio中 Ingress 和 Egress 的基本概念和区别。</p><p>本讲内容总结如下：</p>`,31),F=p("p",null,"今天我们学习了一种全新的设计模式：Egress，Egress 最基本的功能是做出口流量的权限控制。其实通过 Envoy 的强大七层代理实现的 Egress Gateway 可以实现很多功能，在实际项目中我就通过 Egress Gateway 提升了外部服务访问的性能，那么在你的经验里 Egress Gateway 还有哪些应用场景呢? 欢迎在留言区和我分享你的观点。",-1),d=p("p",null,"今天内容到这里就结束了，下一讲我会讲解如何在 Istio 中完成金丝雀发布：金丝雀部署和版本控制。我们下一讲再见！",-1);function u(D,g,A,C,h,b){const s=e("Image");return t(),c("div",null,[y,n(s,{alt:"Drawing 0.png",src:"https://s0.lgstatic.com/i/image6/M00/04/29/CioPOWAikmiAcbONAACHq-N5-0s752.png"}),a(),E,n(s,{alt:"Drawing 1.png",src:"https://s0.lgstatic.com/i/image6/M00/04/2D/Cgp9HWAikpmAQQN3AAP80pyzQ1o891.png"}),a(),i,n(s,{alt:"Drawing 2.png",src:"https://s0.lgstatic.com/i/image6/M00/04/2D/Cgp9HWAikquAESGWAAGAzMGoHMY346.png"}),a(),F,d])}const m=o(r,[["render",u]]);export{B as __pageData,m as default};
