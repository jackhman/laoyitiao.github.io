import{_ as o,j as e,o as t,g as c,k as n,h as p,Q as l,s}from"./chunks/framework.4e7d56ce.js";const I=JSON.parse('{"title":"Istio 环境搭建 ","description":"","frontmatter":{},"headers":[],"relativePath":"posts/backEnd/微服务Service Mesh原理与实战_文档/(6007) 14  Itio 入门：基于最新 1.7 版本的环境搭建和介绍.md","filePath":"posts/backEnd/微服务Service Mesh原理与实战_文档/(6007) 14  Itio 入门：基于最新 1.7 版本的环境搭建和介绍.md","lastUpdated":1696417798000}'),r={name:"posts/backEnd/微服务Service Mesh原理与实战_文档/(6007) 14  Itio 入门：基于最新 1.7 版本的环境搭建和介绍.md"},y=l(`<p>今天我要和你分享的内容是 Istio 入门，主要包括 Istio 基础知识和基于最新版本的环境搭建。</p><p>谈到 Service Mesh，不得不提及 Istio，作为 Google、IBM、lynx 联合推出的 Service Mesh 解决方案，Istio 几乎成了 Service Mesh 的代名词，但<strong>实际上 Istio 仅仅是 Service Mesh 中的控制面，它的主要功能是为数据面下发服务治理策略</strong>。</p><p>早期 Istio 也尝试过接管一些流量治理的功能，比如&quot;为人诟病&quot;的 Mixer 模块，就是用来做限流和遥测信息收集的，后来因为转发性能的问题，在后续版本还是交由数据面负责了。</p><p>Istio 最近在 1.5 版本进行了一次大的变更，由早期的微服务架构变成了单体架构。之前版本的Istio 由 Pilot、Citadel、Galley、Sidecar 注入器等多个微服务组成，但<strong>现在只需要一个 Istiod 的单体服务</strong>。</p><p>这样的单体架构，使 Istio 作为一个开源软件，更容易部署、配置和维护。另外得益于部署便利性的提升，<strong>Istio 也支持在虚拟机环境部署</strong>了。</p><p>最新版本的 Istio 控制面由以下几个组件组成。</p><ul><li><p><strong>Pilot：<strong>Istio 控制面中最核心的模块，负责运行时配置下发，具体来说，就是和 Envoy 之间</strong>基于 xDS 协议</strong>进行的各种 Envoy 配置信息的推送，包括服务发现、路由发现、集群发现、监听器发现等。</p></li><li><p><strong>Citadel</strong>：负责证书的分发和轮换，使 Sidecar 代理两端实现双向 TLS 认证、访问授权等。</p></li><li><p><strong>Galley</strong>：配置信息的格式和正确性校验，将配置信息提供给 Pilot 使用。</p></li></ul><p>现在你已经对 Istio 的基础知识有了一个简单的了解，接下来我将带你动手搭建一个 Istio 的环境，并通过环境搭建带你进一步认识 Istio ，你也可以在搭建的过程中进一步感受这几个组件的功能。</p><h3 id="istio-环境搭建" tabindex="-1">Istio 环境搭建 <a class="header-anchor" href="#istio-环境搭建" aria-label="Permalink to &quot;Istio 环境搭建&quot;">​</a></h3><p>因为 Istio 强依赖于 Kubernetes 环境，所以我们需要先进行 Kubernetes 环境的搭建，为了更加方便，我们使用 Minikube 在本地搭建。</p><p>在 macOS 环境下，只要简单运行如下命令即可：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ brew install minikube</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ brew install minikube</span></span></code></pre></div><p>安装成功后，使用如下命令启动：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ minikube start </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">kubernetes</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">version</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">v1.</span><span style="color:#FDAEB7;font-style:italic;">19</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">driver</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">docker</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ minikube start </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">kubernetes</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">version</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">v1.</span><span style="color:#B31D28;font-style:italic;">19</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">driver</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">docker</span></span></code></pre></div><p>这里需要注意的是，因为 Istio 的最新版本要求是 1.16 以上的 Kubernetes 环境，所以要指定高于此版本的版本号，这里我直接使用了最新的稳定版本。</p><p>另外启动过程中，如果遇到问题，可以加上 --alsologtostderr 输出详细的错误信息，建议将 Docker 版本也升级至最新。</p><p>下载最新版本的 Istio：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ curl </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">L https</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//istio.io/downloadIstio | ISTIO_VERSION=1.7.3 sh -</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ curl </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">L https</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//istio.io/downloadIstio | ISTIO_VERSION=1.7.3 sh -</span></span></code></pre></div><p><strong>为了保证后续命令的准确性，这里指定了版本号。</strong></p><p>进入下载目录：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ cd istio</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1.7</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">3</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ cd istio</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1.7</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">3</span></span></code></pre></div><p>将 Istioctl 客户端添加到可执行路径：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ export PATH</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">$PWD</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">bin</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">$PATH</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ export PATH</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">$PWD</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">bin</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">$PATH</span></span></code></pre></div><p>使用 Istioctl 客户端安装 Istio：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ istioctl install </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">set profile</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">demo</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ istioctl install </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">set profile</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">demo</span></span></code></pre></div><p>在默认命名空间开启自动注入 Envoy Sidecar：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl label namespace </span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;"> istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">injection</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">enabled</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl label namespace </span><span style="color:#D73A49;">default</span><span style="color:#24292E;"> istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">injection</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">enabled</span></span></code></pre></div><p>通过上述操作，Istio 的环境就安装好了，你可以通过下面的命令查看 Istio 组件：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl get svc </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">n istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">system</span></span>
<span class="line"><span style="color:#E1E4E8;">NAME                   TYPE           CLUSTER</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">IP       EXTERNAL</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">IP   </span><span style="color:#B392F0;">PORT</span><span style="color:#E1E4E8;">(S)                                                                      AGE</span></span>
<span class="line"><span style="color:#E1E4E8;">istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">egressgateway    ClusterIP      </span><span style="color:#79B8FF;">10.104</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">140</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">107</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">80</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP,</span><span style="color:#79B8FF;">443</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP,</span><span style="color:#79B8FF;">15443</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP                                                     2d5h</span></span>
<span class="line"><span style="color:#E1E4E8;">istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ingressgateway   LoadBalancer   </span><span style="color:#79B8FF;">10.103</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">123</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">96</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">pending</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">15021</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">32148</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP,</span><span style="color:#79B8FF;">80</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">32124</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP,</span><span style="color:#79B8FF;">443</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">31370</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP,</span><span style="color:#79B8FF;">31400</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">31690</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP,</span><span style="color:#79B8FF;">15443</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">32721</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP   2d5h</span></span>
<span class="line"><span style="color:#E1E4E8;">istiod                 ClusterIP      </span><span style="color:#79B8FF;">10.106</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">54</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">115</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">15010</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP,</span><span style="color:#79B8FF;">15012</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP,</span><span style="color:#79B8FF;">443</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP,</span><span style="color:#79B8FF;">15014</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP,</span><span style="color:#79B8FF;">853</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP                                2d5h</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl get svc </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">n istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">system</span></span>
<span class="line"><span style="color:#24292E;">NAME                   TYPE           CLUSTER</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">IP       EXTERNAL</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">IP   </span><span style="color:#6F42C1;">PORT</span><span style="color:#24292E;">(S)                                                                      AGE</span></span>
<span class="line"><span style="color:#24292E;">istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">egressgateway    ClusterIP      </span><span style="color:#005CC5;">10.104</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">140</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">107</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP,</span><span style="color:#005CC5;">443</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP,</span><span style="color:#005CC5;">15443</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP                                                     2d5h</span></span>
<span class="line"><span style="color:#24292E;">istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ingressgateway   LoadBalancer   </span><span style="color:#005CC5;">10.103</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">123</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">96</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">pending</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">15021</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">32148</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP,</span><span style="color:#005CC5;">80</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">32124</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP,</span><span style="color:#005CC5;">443</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">31370</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP,</span><span style="color:#005CC5;">31400</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">31690</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP,</span><span style="color:#005CC5;">15443</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">32721</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP   2d5h</span></span>
<span class="line"><span style="color:#24292E;">istiod                 ClusterIP      </span><span style="color:#005CC5;">10.106</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">54</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">115</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">15010</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP,</span><span style="color:#005CC5;">15012</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP,</span><span style="color:#005CC5;">443</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP,</span><span style="color:#005CC5;">15014</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP,</span><span style="color:#005CC5;">853</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP                                2d5h</span></span></code></pre></div><p>Istio 以一个服务的形式部署在 Kubernetes 集群中。我们可以看到，部署好的 Pods 中，除了有 Istiod 这个核心组件外，还有 Istio Egressgate Way 和 Istio Ingressgate Way 两个组件，分别是出口网关和入口网关。</p><p>至此，我们已经成功完成平台搭建。接下来，我们将部署<strong>示例程序 Bookinfo</strong>，通过这个官方 Demo 你可以直观感受 Istio 的功能。</p><h3 id="部署-bookinfo-示例程序" tabindex="-1">部署 Bookinfo 示例程序 <a class="header-anchor" href="#部署-bookinfo-示例程序" aria-label="Permalink to &quot;部署 Bookinfo 示例程序&quot;">​</a></h3><p>部署示例程序：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl apply </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f samples</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">bookinfo</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">platform</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">kube</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">bookinfo.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl apply </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f samples</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">bookinfo</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">platform</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">kube</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">bookinfo.yaml</span></span></code></pre></div><p>通过下面的命令可以查看 Pod 的运行状态：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl get pods</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl get pods</span></span></code></pre></div><p>当 Pod ready 后，我们可以通过内部服务访问的方式，查看服务的运行情况：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl exec </span><span style="color:#9ECBFF;">&quot;$(kubectl get pod -l app=ratings -o jsonpath=&#39;{.items[0].metadata.name}&#39;)&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">c ratings </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;"> curl </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">s productpage</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">9080</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">productpage </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> grep </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">o </span><span style="color:#9ECBFF;">&quot;&lt;title&gt;.*&lt;/title&gt;&quot;</span></span>
<span class="line"><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">title</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">Simple Bookstore App</span><span style="color:#F97583;">&lt;/</span><span style="color:#E1E4E8;">title</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl exec </span><span style="color:#032F62;">&quot;$(kubectl get pod -l app=ratings -o jsonpath=&#39;{.items[0].metadata.name}&#39;)&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">c ratings </span><span style="color:#D73A49;">--</span><span style="color:#24292E;"> curl </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">s productpage</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">9080</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">productpage </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> grep </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">o </span><span style="color:#032F62;">&quot;&lt;title&gt;.*&lt;/title&gt;&quot;</span></span>
<span class="line"><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">title</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">Simple Bookstore App</span><span style="color:#D73A49;">&lt;/</span><span style="color:#24292E;">title</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><p>现在，服务已经正常启动了。接下来，我们通过 Ingress 的方式，让浏览器可以打开这个页面。</p><p>通过 Ingress 打通内外网服务：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl apply </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f samples</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">bookinfo</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">networking</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">bookinfo</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">gateway.yaml</span></span>
<span class="line"><span style="color:#E1E4E8;">gateway.networking.istio.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">bookinfo</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">gateway created</span></span>
<span class="line"><span style="color:#E1E4E8;">virtualservice.networking.istio.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">bookinfo created</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl apply </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f samples</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">bookinfo</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">networking</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">bookinfo</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">gateway.yaml</span></span>
<span class="line"><span style="color:#24292E;">gateway.networking.istio.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">bookinfo</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">gateway created</span></span>
<span class="line"><span style="color:#24292E;">virtualservice.networking.istio.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">bookinfo created</span></span></code></pre></div><p>查看 Minikube 的 IP：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ minikube ip</span></span>
<span class="line"><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ minikube ip</span></span>
<span class="line"><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span></span></code></pre></div><p>然后，打开新的终端窗口，为 LoadBalancer 类型的服务打通外网：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ minikube tunnel</span></span>
<span class="line"><span style="color:#E1E4E8;">The service Istio </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ingressgateway requires privileged ports to be exposed</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> [</span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">443</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">sudo permission will be asked </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> it.</span></span>
<span class="line"><span style="color:#E1E4E8;">Starting tunnel </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> service Istio </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ingressgateway.</span></span>
<span class="line"><span style="color:#E1E4E8;">Password</span><span style="color:#F97583;">:</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ minikube tunnel</span></span>
<span class="line"><span style="color:#24292E;">The service Istio </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ingressgateway requires privileged ports to be exposed</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> [</span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">443</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">sudo permission will be asked </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> it.</span></span>
<span class="line"><span style="color:#24292E;">Starting tunnel </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> service Istio </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ingressgateway.</span></span>
<span class="line"><span style="color:#24292E;">Password</span><span style="color:#D73A49;">:</span></span></code></pre></div><p>打开浏览器访问<a href="http://127.0.0.1/productpage" target="_blank" rel="noreferrer">http://127.0.0.1/productpage</a>（IP 替换为上面运行的 Minikube IP）， 就可以看到如下页面了。</p>`,46),E=l(`<p>现在，我们已经可以访问 Bookinfo 的这个程序了。接下来，看一下如何在 Istio 中部署基于 Kiali 的可视化界面。</p><h3 id="可观测性部署" tabindex="-1">可观测性部署 <a class="header-anchor" href="#可观测性部署" aria-label="Permalink to &quot;可观测性部署&quot;">​</a></h3><p>Kiali 是一个基于服务网格的 Istio 管理控制台，它提供了一些数据的仪表盘和可观测能力，同时可以让你去操作网格的配置。</p><p>使用如下方式快速部署一个用于演示的 Kiali：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl apply </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f samples</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">addons</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl apply </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f samples</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">addons</span></span></code></pre></div><p>因为安装的组件比较多，也比较消耗资源，<strong>如果机器资源并非特别充足，可能会出现启动比较慢的情况，需要多等待一段时间</strong>。查看 Pod 的状态可以通过以下命令进行：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl get pod </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">n istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">system </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">o wide</span></span>
<span class="line"><span style="color:#E1E4E8;">NAME                                    READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES</span></span>
<span class="line"><span style="color:#E1E4E8;">grafana</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">57bb676c4c</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">4nfcd                </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">13d</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">11</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">egressgateway</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">8556f8c8dc</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">pnlbl    </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">16d</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">4</span><span style="color:#E1E4E8;">    minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ingressgateway</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">589d868684</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">xcx42   </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">16d</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">6</span><span style="color:#E1E4E8;">    minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">istiod</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">86d65b6959</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">jl8fs                 </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">4</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">16d</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">3</span><span style="color:#E1E4E8;">    minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">jaeger</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">75948789b4</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">9bc4f                 </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">15</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">13d</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">13</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">kiali</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">7d5cb68b45</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">cz75l                  </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">13d</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">5</span><span style="color:#E1E4E8;">    minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">prometheus</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">7c8bf6df84</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">8jp99             </span><span style="color:#79B8FF;">2</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">13d</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">9</span><span style="color:#E1E4E8;">    minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl get pod </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">n istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">system </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">o wide</span></span>
<span class="line"><span style="color:#24292E;">NAME                                    READY   STATUS    RESTARTS   AGE   IP            NODE       NOMINATED NODE   READINESS GATES</span></span>
<span class="line"><span style="color:#24292E;">grafana</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">57bb676c4c</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">4nfcd                </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">13d</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">11</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">egressgateway</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">8556f8c8dc</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">pnlbl    </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">16d</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">4</span><span style="color:#24292E;">    minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ingressgateway</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">589d868684</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">xcx42   </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">16d</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">6</span><span style="color:#24292E;">    minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">istiod</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">86d65b6959</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">jl8fs                 </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">4</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">16d</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">3</span><span style="color:#24292E;">    minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">jaeger</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">75948789b4</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">9bc4f                 </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">15</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">13d</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">13</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">kiali</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">7d5cb68b45</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">cz75l                  </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">13</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">13d</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">5</span><span style="color:#24292E;">    minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">prometheus</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">7c8bf6df84</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">8jp99             </span><span style="color:#005CC5;">2</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">12</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">13d</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">9</span><span style="color:#24292E;">    minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><p>如果有启动比较慢的 Pod，我们也可以通过下面的命令查看一下 Pod 的事件，了解一下具体原因。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl describe pod kiali</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">7d5cb68b45</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">cz75l </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">n istio</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">system</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl describe pod kiali</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">7d5cb68b45</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">cz75l </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">n istio</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">system</span></span></code></pre></div><p>Pod 全部启动成功后，通过下面的命令查看整个调用关系情况：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ istioctl dashboard kiali</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ istioctl dashboard kiali</span></span></code></pre></div><p>运行之后就可以看到下面的页面了。</p>`,12),i=l(`<p>调用关系图</p><p>现在，我们已经可以通过页面看到完整的调用关系图，这可以让我们更直观地了解程序的运行状态。</p><h3 id="实例服务原理解析" tabindex="-1">实例服务原理解析 <a class="header-anchor" href="#实例服务原理解析" aria-label="Permalink to &quot;实例服务原理解析&quot;">​</a></h3><p>我们可以分析一下整个 Bookinfo 示例程序的搭建过程，就拿我们访问的 productpage 页面来说。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v1</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Service</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> productpage</span></span>
<span class="line"><span style="color:#E1E4E8;">  labels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> productpage</span></span>
<span class="line"><span style="color:#E1E4E8;">    service</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> productpage</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  ports</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> port</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">9080</span></span>
<span class="line"><span style="color:#E1E4E8;">    name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> http</span></span>
<span class="line"><span style="color:#E1E4E8;">  selector</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> productpage</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v1</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Service</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> productpage</span></span>
<span class="line"><span style="color:#24292E;">  labels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> productpage</span></span>
<span class="line"><span style="color:#24292E;">    service</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> productpage</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  ports</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> port</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9080</span></span>
<span class="line"><span style="color:#24292E;">    name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> http</span></span>
<span class="line"><span style="color:#24292E;">  selector</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> productpage</span></span></code></pre></div><p>我们首先<strong>定义了一个 Service 类型的资源</strong>，而 Service 是 Kubernetes 抽象出来的服务概念，一组 Pod 的集合便是 Kubernetes 的 Service。Pod 是有生命周期的，Pod 的 IP 在不同的生命周期内发生变化，但抽象出来的 Service 名称是不会变化的。这样我们就可以通过服务名访问这些后端 IP，而不用感知后端 Pod IP 的变化。</p><p>然后我们在 Metadata 中定义了这一组 Service 的 label ，通过 selector 指定响应的标签，就可以访问带有这组标签定义的 Pod 集合。另外这组配置还指定了服务端口为 9080，服务的协议为 HTTP ，这些信息将用于 Sidecar 的代理转发。</p><p>接下来，我们通过 Deployment 控制 Pod 的生命周期，定义了 Pod 的副本数量。下面的示例中，定义一个 replicas 为 1，也就是 Pod 的副本数量为 1，因为是测试环境，所以没有设置更多的副本数量保障服务的 SLA 。</p><p>当然一些常规的镜像拉取地址和拉取方式也做了定义：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> apps</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Deployment</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> productpage</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v1</span></span>
<span class="line"><span style="color:#E1E4E8;">  labels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> productpage</span></span>
<span class="line"><span style="color:#E1E4E8;">    version</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v1</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  replicas</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  selector</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    matchLabels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> productpage</span></span>
<span class="line"><span style="color:#E1E4E8;">      version</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v1</span></span>
<span class="line"><span style="color:#E1E4E8;">  template</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      labels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> productpage</span></span>
<span class="line"><span style="color:#E1E4E8;">        version</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v1</span></span>
<span class="line"><span style="color:#E1E4E8;">    spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      serviceAccountName</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> bookinfo</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">productpage</span></span>
<span class="line"><span style="color:#E1E4E8;">      containers</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> productpage</span></span>
<span class="line"><span style="color:#E1E4E8;">        image</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> docker.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">istio</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">examples</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">bookinfo</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">productpage</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v1</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">1.16</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">        imagePullPolicy</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">        ports</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> containerPort</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">9080</span></span>
<span class="line"><span style="color:#E1E4E8;">        volumeMounts</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> tmp</span></span>
<span class="line"><span style="color:#E1E4E8;">          mountPath</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">tmp</span></span>
<span class="line"><span style="color:#E1E4E8;">      volumes</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> tmp</span></span>
<span class="line"><span style="color:#E1E4E8;">        emptyDir</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> {}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> apps</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Deployment</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> productpage</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v1</span></span>
<span class="line"><span style="color:#24292E;">  labels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> productpage</span></span>
<span class="line"><span style="color:#24292E;">    version</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v1</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  replicas</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  selector</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    matchLabels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> productpage</span></span>
<span class="line"><span style="color:#24292E;">      version</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v1</span></span>
<span class="line"><span style="color:#24292E;">  template</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      labels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> productpage</span></span>
<span class="line"><span style="color:#24292E;">        version</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v1</span></span>
<span class="line"><span style="color:#24292E;">    spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      serviceAccountName</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> bookinfo</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">productpage</span></span>
<span class="line"><span style="color:#24292E;">      containers</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> productpage</span></span>
<span class="line"><span style="color:#24292E;">        image</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> docker.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">istio</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">examples</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">bookinfo</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">productpage</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v1</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">1.16</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">2</span></span>
<span class="line"><span style="color:#24292E;">        imagePullPolicy</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">        ports</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> containerPort</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9080</span></span>
<span class="line"><span style="color:#24292E;">        volumeMounts</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> tmp</span></span>
<span class="line"><span style="color:#24292E;">          mountPath</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">tmp</span></span>
<span class="line"><span style="color:#24292E;">      volumes</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> tmp</span></span>
<span class="line"><span style="color:#24292E;">        emptyDir</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> {}</span></span></code></pre></div><p>另外在 Kubernetes 的 Service 里面并没有版本的概念，如果我们想进行染色或者金丝雀发布，就需要借助 Istio 的能力。通过上述命令可以看到，在 Deployment 类型中定义了 Version V1 的 lable，这个 lable 最终会转化成不同的服务名，比如 productpage-v1 的方式，下发到 Sidecar 中， Sidecar 根据这个服务名称进行服务发现，以实现不同版本号访问的方法。</p><p>下一步，我们用到了 Ingress 模式。我们定义一组网关类型的资源， Istio 通过 Gateway 将服务发布成<strong>外部可访问</strong>的服务，通过 80 端口将服务通过 Ingress 网关转发到特定的服务上。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> networking.istio.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1alpha3</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Gateway</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> bookinfo</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">gateway</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  selector</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    istio</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> ingressgateway # use istio </span><span style="color:#F97583;">default</span><span style="color:#E1E4E8;"> controller</span></span>
<span class="line"><span style="color:#E1E4E8;">  servers</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> port</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      number</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">      name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> http</span></span>
<span class="line"><span style="color:#E1E4E8;">      protocol</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> HTTP</span></span>
<span class="line"><span style="color:#E1E4E8;">    hosts</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;*&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> networking.istio.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1alpha3</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Gateway</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> bookinfo</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">gateway</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  selector</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    istio</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> ingressgateway # use istio </span><span style="color:#D73A49;">default</span><span style="color:#24292E;"> controller</span></span>
<span class="line"><span style="color:#24292E;">  servers</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> port</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      number</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">      name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> http</span></span>
<span class="line"><span style="color:#24292E;">      protocol</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> HTTP</span></span>
<span class="line"><span style="color:#24292E;">    hosts</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;*&quot;</span></span></code></pre></div><p>在这里，Gateway 资源类型，需要配合 VirtualService 类型的资源一起使用。那么，定义匹配到的 URI 具体路由到哪个服务呢？</p><p>在这个程序中你可以看到匹配到 /productpage 路径的服务，而<strong>在 route 中定义了 destination 的 host 将会是路由的服务名</strong>。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> networking.istio.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1alpha3</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> VirtualService</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> bookinfo</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  hosts</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;*&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  gateways</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> bookinfo</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">gateway</span></span>
<span class="line"><span style="color:#E1E4E8;">  http</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> match</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> uri</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        exact</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">productpage</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> uri</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        prefix</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/static</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> uri</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        exact</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">login</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> uri</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        exact</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">logout</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> uri</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        prefix</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">api</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">products</span></span>
<span class="line"><span style="color:#E1E4E8;">    route</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> destination</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        host</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> productpage</span></span>
<span class="line"><span style="color:#E1E4E8;">        port</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          number</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">9080</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> networking.istio.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1alpha3</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> VirtualService</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> bookinfo</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  hosts</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;*&quot;</span></span>
<span class="line"><span style="color:#24292E;">  gateways</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> bookinfo</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">gateway</span></span>
<span class="line"><span style="color:#24292E;">  http</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> match</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> uri</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        exact</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">productpage</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> uri</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        prefix</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/static</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> uri</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        exact</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">login</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> uri</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        exact</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">logout</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> uri</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        prefix</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">api</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">products</span></span>
<span class="line"><span style="color:#24292E;">    route</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> destination</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        host</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> productpage</span></span>
<span class="line"><span style="color:#24292E;">        port</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">          number</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9080</span></span></code></pre></div><p>最后我们通过一张图，整体回顾一下整个 Istio 的架构：</p>`,17),d=s("p",null,"Istio 架构示意图",-1),F=s("p",null,"Istio 通过 Galley 模块管理配置，Pilot 模块解析配置为 xDS 协议格式，通过 gRPC 和 Envoy 进行通信，以便完成配置和节点信息更新， pilot-agent 作为 Envoy 守护模块，保证 Envoy 的正常运行和平滑重启。",-1),g=s("p",null,"本地业务服务 productpage 通过 iptables 劫持的方式和本地 Envoy 进行通信，Envoy 完成服务发现后将请求转发到 ProductDetail 服务的所在 Pod，同样通过 iptables 劫持的方式将请求转发到本地的业务服务 ProductDetail。",-1),D=s("h3",{id:"总结",tabindex:"-1"},[p("总结 "),s("a",{class:"header-anchor",href:"#总结","aria-label":'Permalink to "总结"'},"​")],-1),A=s("p",null,"这一讲我主要讲解了 Istio 的基础知识，并通过一个简单的示例让你了解了整个 Istio 的运作模式。",-1),u=s("p",null,"本讲内容总结如下：",-1),v=s("p",null,"参照上面的示例，通过之前的 Kiali 的调用关系图，你可以发现在示例中，productpage 页面中会随机展示 reviews 服务的不同版本。那如何变更默认配置，可以让访问 reviews 服务显示特定版本呢？如果按照不同比例访问 review 特定版本，又如何配置呢？欢迎在留言区和我分享你的观点。",-1),h=s("p",null,"下一讲我会与你分享 xDS：控制面和数据面的通信桥梁。利用 xDS 协议，Envoy 可以实现配置的完全动态化，配置实时更新而无须重启 Envoy 或者影响业务。通过这部分内容的学习，希望你可以掌握数据面 Envoy 如何动态地更新服务的各种配置。我们下一讲再见！",-1);function b(C,k,m,B,f,_){const a=e("Image");return t(),c("div",null,[y,n(a,{alt:"Drawing 0.png",src:"https://s0.lgstatic.com/i/image/M00/92/C0/CgqCHmASi8uAdsqeAAKHpD0j4qg994.png"}),E,n(a,{alt:"Drawing 1.png",src:"https://s0.lgstatic.com/i/image2/M01/0A/AC/CgpVE2ASi9WAXwlcAARJrTHcx40431.png"}),p(),i,n(a,{alt:"3-1.png",src:"https://s0.lgstatic.com/i/image/M00/94/C3/CgqCHmAZTISAfD_yAACNyFBh83E067.png"}),p(),d,F,g,D,A,u,n(a,{alt:"Drawing 3.png",src:"https://s0.lgstatic.com/i/image2/M01/0A/A9/Cip5yGASi-6AGLTqAAGmg-MI4sk397.png"}),v,h])}const T=o(r,[["render",b]]);export{I as __pageData,T as default};
