import{_ as l,j as o,o as e,g as c,k as a,h as p,Q as s}from"./chunks/framework.4e7d56ce.js";const P=JSON.parse('{"title":"11K8Service：轻松搞定服务发现和负载均衡","description":"","frontmatter":{},"headers":[],"relativePath":"posts/backEnd/113-Kubernetes 原理剖析与实战应用文档/(4528) 11  K8 Service：轻松搞定服务发现和负载均衡.md","filePath":"posts/backEnd/113-Kubernetes 原理剖析与实战应用文档/(4528) 11  K8 Service：轻松搞定服务发现和负载均衡.md","lastUpdated":1696682708000}'),t={name:"posts/backEnd/113-Kubernetes 原理剖析与实战应用文档/(4528) 11  K8 Service：轻松搞定服务发现和负载均衡.md"},r=s('<h1 id="_11k8service-轻松搞定服务发现和负载均衡" tabindex="-1">11K8Service：轻松搞定服务发现和负载均衡 <a class="header-anchor" href="#_11k8service-轻松搞定服务发现和负载均衡" aria-label="Permalink to &quot;11K8Service：轻松搞定服务发现和负载均衡&quot;">​</a></h1><p>经过前面几节课的学习，我们已经可以发布高可用的业务了，通过 PV 持久化地保存数据，通过 Deployment或Statefulset 这类工作负载来管理多实例，从而保证服务的高可用。</p><p>想一想，这个时候如果有别的应用来访问我们的服务的话，该怎么办呢？直接访问后端的 Pod IP 吗？不，这里我们还需要做服务发现（Service Discovery）。</p><h3 id="为什么需要服务发现" tabindex="-1">为什么需要服务发现？ <a class="header-anchor" href="#为什么需要服务发现" aria-label="Permalink to &quot;为什么需要服务发现？&quot;">​</a></h3><p>传统的应用部署，服务实例的网络位置是固定的，即在给定的机器上进行部署，这个时候的服务地址一般是机器的 IP 加上某个特定的端口号。</p><p>但是在 Kubernetes 中，这是完全不同的。业务都是通过 Pod 来承载的，每个 Pod 的生命周期又很短暂，用后即焚，IP 地址也都是随机分配，动态变化的。而且，我们还经常会遇到一些高并发的流量进来，这时候往往需要快速扩容，服务的实例数也会随之动态调整。因此我们在这里就不能用传统的基于 IP 的方式去访问某个服务了。这个对于所有云上的系统，以及微服务应用体系，都是一个大难题。这时我们就需要做服务发现来确定服务的访问地址。</p><p>今天我们就来聊聊 Kubernetes 中的服务发现 ------ Service。</p><h3 id="kubernetes-中的-service" tabindex="-1">Kubernetes 中的 Service <a class="header-anchor" href="#kubernetes-中的-service" aria-label="Permalink to &quot;Kubernetes 中的 Service&quot;">​</a></h3><p>在之前的课程中，我们知道 Deployment、StatefulSet 这类工作负载都是通过 labelSelector 来管理一组 Pod 的。那么 Kubernetes 中的 Service 也采用了同样的做法，如下图。</p>',9),E=s(`<p>（<a href="https://platform9.com/wp-content/uploads/2019/05/kubernetes-service-discovery.jpg" target="_blank" rel="noreferrer">https://platform9.com/wp-content/uploads/2019/05/kubernetes-service-discovery.jpg</a>）</p><p>这样一个 Service 会选择集群所有 label 中带有<code>app=nginx</code>和<code>env=prod</code>的 Pod。</p><p>我们来看看这样的一个 Service 是如何定义的：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">$ cat nginx-svc.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-prod-svc-demo</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># service 是 namespace 级别的对象</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:       </span><span style="color:#6A737D;"># Pod选择器</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">env</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">prod</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterIP</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># service 的类型</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:  </span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;"># service 的端口号</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 对应到 Pod 上的端口号</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 还支持 udp，http 等</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">$ cat nginx-svc.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-prod-svc-demo</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># service 是 namespace 级别的对象</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:       </span><span style="color:#6A737D;"># Pod选择器</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">env</span><span style="color:#24292E;">: </span><span style="color:#032F62;">prod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># service 的类型</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:  </span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">       </span><span style="color:#6A737D;"># service 的端口号</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 对应到 Pod 上的端口号</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 还支持 udp，http 等</span></span></code></pre></div><p>现在我们先来看如下一个 Deployment的定义：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">$ cat nginx-deploy.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-prod-deploy</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">env</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">prod</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">env</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">prod</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">env</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">prod</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx:1.14.2</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">$ cat nginx-deploy.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-prod-deploy</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">env</span><span style="color:#24292E;">: </span><span style="color:#032F62;">prod</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">env</span><span style="color:#24292E;">: </span><span style="color:#032F62;">prod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">env</span><span style="color:#24292E;">: </span><span style="color:#032F62;">prod</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.14.2</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><p>我们创建好这个 Deployment后，查看其 Pod 状态：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deploy</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">UP-TO-DATE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AVAILABLE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">nginx-prod-deploy</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">/3</span><span style="color:#E1E4E8;">     </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">           </span><span style="color:#79B8FF;">5</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wide</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                 </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">IP</span><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">             </span><span style="color:#9ECBFF;">NOMINATED</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">READINESS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GATES</span></span>
<span class="line"><span style="color:#B392F0;">nginx-prod-deploy-6fb6fbb77d-h2gn4</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">87</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.1</span><span style="color:#9ECBFF;">.0.31</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">docker-desktop</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">nginx-prod-deploy-6fb6fbb77d-r78k9</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">87</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.1</span><span style="color:#9ECBFF;">.0.29</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">docker-desktop</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">nginx-prod-deploy-6fb6fbb77d-xm8tp</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">87</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.1</span><span style="color:#9ECBFF;">.0.30</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">docker-desktop</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deploy</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">UP-TO-DATE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AVAILABLE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-prod-deploy</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">/3</span><span style="color:#24292E;">     </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">            </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">           </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                 </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">          </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">             </span><span style="color:#032F62;">NOMINATED</span><span style="color:#24292E;"> </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READINESS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GATES</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-prod-deploy-6fb6fbb77d-h2gn4</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">87</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.1</span><span style="color:#032F62;">.0.31</span><span style="color:#24292E;">   </span><span style="color:#032F62;">docker-desktop</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-prod-deploy-6fb6fbb77d-r78k9</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">87</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.1</span><span style="color:#032F62;">.0.29</span><span style="color:#24292E;">   </span><span style="color:#032F62;">docker-desktop</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-prod-deploy-6fb6fbb77d-xm8tp</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">87</span><span style="color:#032F62;">s</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.1</span><span style="color:#032F62;">.0.30</span><span style="color:#24292E;">   </span><span style="color:#032F62;">docker-desktop</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><p>我们再来创建下上面定义的 Service：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nginx-svc.yaml</span></span>
<span class="line"><span style="color:#B392F0;">service/nginx-prod-svc-demo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">svc</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                  </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">CLUSTER-IP</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">EXTERNAL-IP</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">PORT</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">S</span><span style="color:#E1E4E8;">)   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">nginx-prod-svc-demo</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">ClusterIP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.111</span><span style="color:#9ECBFF;">.193.186</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">/TCP</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">6</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">可以看到，这个</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Service</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">分配到了一个地址为10.111.193.186的</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">IP，这是一个虚拟</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">IP（VIP）地址，集群内所有的</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">和</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">都可以通过这个虚拟</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">IP</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">地址加端口的方式来访问该</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Service。这个</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Service</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">会根据标签选择器，把匹配到的</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">的</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">IP</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">地址都挂载到后端。我们使用\`</span><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> describe\`</span><span style="color:#B392F0;">来看看这个</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Service：</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">describe</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">svc</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nginx-prod-svc-demo</span></span>
<span class="line"><span style="color:#B392F0;">Name:</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">nginx-prod-svc-demo</span></span>
<span class="line"><span style="color:#B392F0;">Namespace:</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#B392F0;">Labels:</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">Annotations:</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">Selector:</span><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">app=nginx,env=prod</span></span>
<span class="line"><span style="color:#B392F0;">Type:</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">ClusterIP</span></span>
<span class="line"><span style="color:#B392F0;">IP:</span><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">10.111</span><span style="color:#9ECBFF;">.193.186</span></span>
<span class="line"><span style="color:#B392F0;">Port:</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">http</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">/TCP</span></span>
<span class="line"><span style="color:#B392F0;">TargetPort:</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">/TCP</span></span>
<span class="line"><span style="color:#B392F0;">Endpoints:</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">10.1</span><span style="color:#9ECBFF;">.0.29:80,10.1.0.30:80,10.1.0.31:80</span></span>
<span class="line"><span style="color:#B392F0;">Session</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Affinity:</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">None</span></span>
<span class="line"><span style="color:#B392F0;">Events:</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx-svc.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">service/nginx-prod-svc-demo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">svc</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                  </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">        </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">       </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-prod-svc-demo</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.111</span><span style="color:#032F62;">.193.186</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">6</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">可以看到，这个</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Service</span><span style="color:#24292E;"> </span><span style="color:#032F62;">分配到了一个地址为10.111.193.186的</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Cluster</span><span style="color:#24292E;"> </span><span style="color:#032F62;">IP，这是一个虚拟</span><span style="color:#24292E;"> </span><span style="color:#032F62;">IP（VIP）地址，集群内所有的</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">和</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">都可以通过这个虚拟</span><span style="color:#24292E;"> </span><span style="color:#032F62;">IP</span><span style="color:#24292E;"> </span><span style="color:#032F62;">地址加端口的方式来访问该</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Service。这个</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Service</span><span style="color:#24292E;"> </span><span style="color:#032F62;">会根据标签选择器，把匹配到的</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">的</span><span style="color:#24292E;"> </span><span style="color:#032F62;">IP</span><span style="color:#24292E;"> </span><span style="color:#032F62;">地址都挂载到后端。我们使用\`</span><span style="color:#6F42C1;">kubectl</span><span style="color:#032F62;"> describe\`</span><span style="color:#6F42C1;">来看看这个</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Service：</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">describe</span><span style="color:#24292E;"> </span><span style="color:#032F62;">svc</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx-prod-svc-demo</span></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">nginx-prod-svc-demo</span></span>
<span class="line"><span style="color:#6F42C1;">Namespace:</span><span style="color:#24292E;">         </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#6F42C1;">Labels:</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Annotations:</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Selector:</span><span style="color:#24292E;">          </span><span style="color:#032F62;">app=nginx,env=prod</span></span>
<span class="line"><span style="color:#6F42C1;">Type:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#6F42C1;">IP:</span><span style="color:#24292E;">                </span><span style="color:#005CC5;">10.111</span><span style="color:#032F62;">.193.186</span></span>
<span class="line"><span style="color:#6F42C1;">Port:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">http</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#6F42C1;">TargetPort:</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#6F42C1;">Endpoints:</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">10.1</span><span style="color:#032F62;">.0.29:80,10.1.0.30:80,10.1.0.31:80</span></span>
<span class="line"><span style="color:#6F42C1;">Session</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Affinity:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">None</span></span>
<span class="line"><span style="color:#6F42C1;">Events:</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><p>可以看到，这时候 Service 关联的 Endpoints 里面有三个 IP 地址，和我们上面看到的 Pod IP 地址完全吻合。</p><p>我们试着来缩容 Deployment 的副本数，再来看看 Service 关联的 Pod IP 地址有什么变化：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">scale</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--replicas=2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deploy</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nginx-prod-deploy</span></span>
<span class="line"><span style="color:#B392F0;">deployment.apps/nginx-prod-deploy</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">scaled</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-o</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">wide</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                 </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">IP</span><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">             </span><span style="color:#9ECBFF;">NOMINATED</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">NODE</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">READINESS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">GATES</span></span>
<span class="line"><span style="color:#B392F0;">nginx-prod-deploy-6fb6fbb77d-r78k9</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">11</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.1</span><span style="color:#9ECBFF;">.0.29</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">docker-desktop</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">nginx-prod-deploy-6fb6fbb77d-xm8tp</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">11</span><span style="color:#9ECBFF;">m</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.1</span><span style="color:#9ECBFF;">.0.30</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">docker-desktop</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">describe</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">svc</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nginx-prod-svc-demo</span></span>
<span class="line"><span style="color:#B392F0;">Name:</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">nginx-prod-svc-demo</span></span>
<span class="line"><span style="color:#B392F0;">Namespace:</span><span style="color:#E1E4E8;">         </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#B392F0;">Labels:</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">Annotations:</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#B392F0;">Selector:</span><span style="color:#E1E4E8;">          </span><span style="color:#9ECBFF;">app=nginx,env=prod</span></span>
<span class="line"><span style="color:#B392F0;">Type:</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">ClusterIP</span></span>
<span class="line"><span style="color:#B392F0;">IP:</span><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">10.111</span><span style="color:#9ECBFF;">.193.186</span></span>
<span class="line"><span style="color:#B392F0;">Port:</span><span style="color:#E1E4E8;">              </span><span style="color:#9ECBFF;">http</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">/TCP</span></span>
<span class="line"><span style="color:#B392F0;">TargetPort:</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">/TCP</span></span>
<span class="line"><span style="color:#B392F0;">Endpoints:</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">10.1</span><span style="color:#9ECBFF;">.0.29:80,10.1.0.30:80</span></span>
<span class="line"><span style="color:#B392F0;">Session</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Affinity:</span><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">None</span></span>
<span class="line"><span style="color:#B392F0;">Events:</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">scale</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--replicas=2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deploy</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx-prod-deploy</span></span>
<span class="line"><span style="color:#6F42C1;">deployment.apps/nginx-prod-deploy</span><span style="color:#24292E;"> </span><span style="color:#032F62;">scaled</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-o</span><span style="color:#24292E;"> </span><span style="color:#032F62;">wide</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                 </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">IP</span><span style="color:#24292E;">          </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">             </span><span style="color:#032F62;">NOMINATED</span><span style="color:#24292E;"> </span><span style="color:#032F62;">NODE</span><span style="color:#24292E;">   </span><span style="color:#032F62;">READINESS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">GATES</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-prod-deploy-6fb6fbb77d-r78k9</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">11</span><span style="color:#032F62;">m</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.1</span><span style="color:#032F62;">.0.29</span><span style="color:#24292E;">   </span><span style="color:#032F62;">docker-desktop</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-prod-deploy-6fb6fbb77d-xm8tp</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">11</span><span style="color:#032F62;">m</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.1</span><span style="color:#032F62;">.0.30</span><span style="color:#24292E;">   </span><span style="color:#032F62;">docker-desktop</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">describe</span><span style="color:#24292E;"> </span><span style="color:#032F62;">svc</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx-prod-svc-demo</span></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">nginx-prod-svc-demo</span></span>
<span class="line"><span style="color:#6F42C1;">Namespace:</span><span style="color:#24292E;">         </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#6F42C1;">Labels:</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Annotations:</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#6F42C1;">Selector:</span><span style="color:#24292E;">          </span><span style="color:#032F62;">app=nginx,env=prod</span></span>
<span class="line"><span style="color:#6F42C1;">Type:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#6F42C1;">IP:</span><span style="color:#24292E;">                </span><span style="color:#005CC5;">10.111</span><span style="color:#032F62;">.193.186</span></span>
<span class="line"><span style="color:#6F42C1;">Port:</span><span style="color:#24292E;">              </span><span style="color:#032F62;">http</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#6F42C1;">TargetPort:</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span></span>
<span class="line"><span style="color:#6F42C1;">Endpoints:</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">10.1</span><span style="color:#032F62;">.0.29:80,10.1.0.30:80</span></span>
<span class="line"><span style="color:#6F42C1;">Session</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Affinity:</span><span style="color:#24292E;">  </span><span style="color:#032F62;">None</span></span>
<span class="line"><span style="color:#6F42C1;">Events:</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><p>可见当 Pod 的生命周期发生变化时，比如缩容或者异常退出，Service 会自动把有问题的 Pod 从后端地址中摘除。这样实现的好处在于，我们可以始终通过一个虚拟的稳定 IP 地址来访问服务，而不用关心其后端真正实例的变化。</p><p>Kubernetes 中 Service 一共有四种类型，除了上面讲的 ClusterIP，还有 NodePort、LoadBalancer 和 ExternalName。</p><p>其中 LoadBalancer 在云上用的较多，使用的时候需要跟各家云厂商做适配，比如部署对应的 cloud-controller-manager。有兴趣的话，可以查看<a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#loadbalancer" target="_blank" rel="noreferrer">这个文档</a>，看看如何在云上使用。LoadBalancer主要用于做外部的服务发现，即暴露给集群外部的访问。</p><p>ExternalName 类型的 Service 在实际中使用的频率不是特别高，但是对于某些特殊场景还是有一些用途的。比如在云上或者内部已经运行着一个应用服务，但是暂时没有运行在 Kubernetes 中，如果想让在 Kubernetes 集群中的 Pod 访问该服务，这时当然可以直接使用它的域名地址，也可以通过 ExternalName 类型的 Service 来解决。这样就可以直接访问 Kubernetes 内部的 Service 了。</p><p>这样一来方便后续服务迁移到 Kubernetes 中，二来也方便随时切换到备份的服务上，而不用更改 Pod 内的任何配置。由于使用频率并不高，我们不做重点介绍，有兴趣可以参考这篇<a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#externalname" target="_blank" rel="noreferrer">文档</a>。</p><p>我们最后来看下另外一种 NodePort 类型的 Service：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">my-nodeport-service</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">my-app</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NodePort</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 这里设置类型为 NodePort</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:  </span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nodePort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">30000</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">my-nodeport-service</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">my-app</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NodePort</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 这里设置类型为 NodePort</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:  </span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nodePort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">30000</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span></code></pre></div><p>顾名思义，这种类型的 Service 通过任一 Node 节点的 IP 地址，再加上端口号就可以访问 Service 后端负载了。我们看下面这个流量图，方便理解。</p>`,21),y=s(`<p>（<a href="https://miro.medium.com/max/1680/1" target="_blank" rel="noreferrer">https://miro.medium.com/max/1680/1</a>*CdyUtG-8CfGu2oFC5s0KwA.png）</p><p>NodePort 类型的 Service 创建好了以后，Kubernetes 会在每个 Node 节点上开个端口，比如这里的 30000 端口。这个时候我们可以访问任何一个 Node 的 IP 地址，通过 30000 端口即可访问该服务。</p><p>那么如果在集群内部，该如何访问这些 Service 呢？</p><h3 id="集群内如何访问-service" tabindex="-1">集群内如何访问 Service？ <a class="header-anchor" href="#集群内如何访问-service" aria-label="Permalink to &quot;集群内如何访问 Service？&quot;">​</a></h3><p>一般来说，在 Kubernetes 集群内，我们有两种方式可以访问到一个 Service。</p><ol><li><p>如果该 Service 有 ClusterIP，我们就可以直接用这个虚拟 IP 去访问。比如我们上面创建的 nginx-prod-svc-demo 这个 Service，我们通过<code>kubectl get svc nginx-prod-svc-demo -n dmeo</code>或<code>kubectl get svc nginx-prod-svc-demo -n dmeo</code>就可以看到其 Cluster IP 为 10.111.193.186，端口号为 80。那么我们通过 http(s)😕/10.111.193.186:80 就可以访问到该服务。</p></li><li><p>当然我们也可以使用该 Service 的域名，依赖于集群内部的 DNS 即可访问。还是以上面的例子做说明，同 namespace 下的 Pod 可以直接通过 nginx-prod-svc-demo 这个 Service 名去访问。如果是不同 namespace 下的 Pod 则需要加上该 Service 所在的 namespace 名，即<code>nginx-prod-svc-demo.demo</code>去访问。</p></li></ol><p>如果在某个 namespace 下，Service 先于 Pod 创建出来，那么 kubelet 在创建 Pod 的时候，会自动把这些 namespace 相同的 Service 访问信息当作环境变量注入 Pod 中，即<code>{SVCNAME}_SERVICE_HOST</code>和<code>{SVCNAME}_SERVICE_PORT</code>。这里<code>SVCNAME</code>对应是各个 Service 的大写名称，名字中的横线会被自动转换成下划线。比如：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># env</span></span>
<span class="line"><span style="color:#E1E4E8;">KUBERNETES_PORT</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp://10.96.0.1:443</span></span>
<span class="line"><span style="color:#E1E4E8;">KUBERNETES_SERVICE_PORT</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">443</span></span>
<span class="line"><span style="color:#E1E4E8;">HOSTNAME</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">nginx-prod-deploy2-68d8fb9586-4m5hr</span></span>
<span class="line"><span style="color:#E1E4E8;">NGINX_PROD_SVC_DEMO_SERVICE_PORT_HTTP</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">NGINX_PROD_SVC_DEMO_SERVICE_HOST</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10.111</span><span style="color:#9ECBFF;">.193.186</span></span>
<span class="line"><span style="color:#E1E4E8;">KUBERNETES_PORT_443_TCP_ADDR</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10.96</span><span style="color:#9ECBFF;">.0.1</span></span>
<span class="line"><span style="color:#E1E4E8;">NGINX_PROD_SVC_DEMO_SERVICE_PORT</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">NGINX_PROD_SVC_DEMO_PORT</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp://10.111.193.186:80</span></span>
<span class="line"><span style="color:#E1E4E8;">KUBERNETES_PORT_443_TCP_PORT</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">443</span></span>
<span class="line"><span style="color:#E1E4E8;">KUBERNETES_PORT_443_TCP_PROTO</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">NGINX_PROD_SVC_DEMO_PORT_80_TCP_ADDR</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10.111</span><span style="color:#9ECBFF;">.193.186</span></span>
<span class="line"><span style="color:#E1E4E8;">NGINX_PROD_SVC_DEMO_PORT_80_TCP_PORT</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">NGINX_PROD_SVC_DEMO_PORT_80_TCP_PROTO</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp</span></span>
<span class="line"><span style="color:#E1E4E8;">KUBERNETES_PORT_443_TCP</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp://10.96.0.1:443</span></span>
<span class="line"><span style="color:#E1E4E8;">KUBERNETES_SERVICE_PORT_HTTPS</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">443</span></span>
<span class="line"><span style="color:#E1E4E8;">KUBERNETES_SERVICE_HOST</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10.96</span><span style="color:#9ECBFF;">.0.1</span></span>
<span class="line"><span style="color:#E1E4E8;">NGINX_PROD_SVC_DEMO_PORT_80_TCP</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">tcp://10.111.193.186:80</span></span>
<span class="line"><span style="color:#79B8FF;">...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># env</span></span>
<span class="line"><span style="color:#24292E;">KUBERNETES_PORT</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp://10.96.0.1:443</span></span>
<span class="line"><span style="color:#24292E;">KUBERNETES_SERVICE_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">443</span></span>
<span class="line"><span style="color:#24292E;">HOSTNAME</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">nginx-prod-deploy2-68d8fb9586-4m5hr</span></span>
<span class="line"><span style="color:#24292E;">NGINX_PROD_SVC_DEMO_SERVICE_PORT_HTTP</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">NGINX_PROD_SVC_DEMO_SERVICE_HOST</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10.111</span><span style="color:#032F62;">.193.186</span></span>
<span class="line"><span style="color:#24292E;">KUBERNETES_PORT_443_TCP_ADDR</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10.96</span><span style="color:#032F62;">.0.1</span></span>
<span class="line"><span style="color:#24292E;">NGINX_PROD_SVC_DEMO_SERVICE_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">NGINX_PROD_SVC_DEMO_PORT</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp://10.111.193.186:80</span></span>
<span class="line"><span style="color:#24292E;">KUBERNETES_PORT_443_TCP_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">443</span></span>
<span class="line"><span style="color:#24292E;">KUBERNETES_PORT_443_TCP_PROTO</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp</span></span>
<span class="line"><span style="color:#24292E;">NGINX_PROD_SVC_DEMO_PORT_80_TCP_ADDR</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10.111</span><span style="color:#032F62;">.193.186</span></span>
<span class="line"><span style="color:#24292E;">NGINX_PROD_SVC_DEMO_PORT_80_TCP_PORT</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">NGINX_PROD_SVC_DEMO_PORT_80_TCP_PROTO</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp</span></span>
<span class="line"><span style="color:#24292E;">KUBERNETES_PORT_443_TCP</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp://10.96.0.1:443</span></span>
<span class="line"><span style="color:#24292E;">KUBERNETES_SERVICE_PORT_HTTPS</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">443</span></span>
<span class="line"><span style="color:#24292E;">KUBERNETES_SERVICE_HOST</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10.96</span><span style="color:#032F62;">.0.1</span></span>
<span class="line"><span style="color:#24292E;">NGINX_PROD_SVC_DEMO_PORT_80_TCP</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">tcp://10.111.193.186:80</span></span>
<span class="line"><span style="color:#005CC5;">...</span></span></code></pre></div><p>知道了这两种访问方式，我们就可以在启动 Pod 的时候，通过注入环境变量、启动参数或者挂载配置文件等方式，来指定要访问的 Service 信息。如果是同 namespace 的 Pod，可以直接从自己的环境变量中知道同 namespace 下的其他 Service 的访问方式。</p><p>那么这样通过该 Service 进行访问时，Kubernetes 又是如何实现负载均衡的呢，即将流量打到后端挂载的各个 Pod 上面去？</p><h3 id="集群内部的负载均衡如何实现" tabindex="-1">集群内部的负载均衡如何实现？ <a class="header-anchor" href="#集群内部的负载均衡如何实现" aria-label="Permalink to &quot;集群内部的负载均衡如何实现？&quot;">​</a></h3><p>这一切都是通过 kube-proxy 来实现的。所有的节点上都会运行着一个 kube-proxy的服务，主要监听 Kubernetes 中的 Service 和 Endpoints。当 Service 或 Endpoints 发生变化时，就会调用相应的接口创建对应的规则出来，常用模式主要是 iptables 模式和 IPVS 模式。iptables 模式比较简单，使用起来也方便。而 IPVS 支持更高的吞吐量以及复杂的负载均衡策略，你可以通过<a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#proxy-mode-ipvs" target="_blank" rel="noreferrer">官方文档</a>了解更多 IPVS 模式的工作原理。</p><p>目前 kube-proxy 默认的工作方式是 iptables 模式，我们来通过如下一个 iptables 模式的例子来看一下实际访问链路是什么样的。</p>`,13),F=s(`<p>（<a href="https://d33wubrfki0l68.cloudfront.net/27b2978647a8d7bdc2a96b213f0c0d3242ef9ce0/e8c9b/images/docs/services-iptables-overview.svg" target="_blank" rel="noreferrer">https://d33wubrfki0l68.cloudfront.net/27b2978647a8d7bdc2a96b213f0c0d3242ef9ce0/e8c9b/images/docs/services-iptables-overview.svg</a>）</p><p>当你通过 Service 的域名去访问时，会先通过 CoreDNS 解析出 Service 对应的 Cluster IP，即虚拟 IP。然后请求到达宿主机的网络后，就会被kube-proxy所配置的 iptables 规则所拦截，之后请求会被转发到每一个实际的后端 Pod 上面去，这样就实现了负载均衡。</p><h3 id="headless-service" tabindex="-1">Headless Service <a class="header-anchor" href="#headless-service" aria-label="Permalink to &quot;Headless Service&quot;">​</a></h3><p>如果我们在定义 Service 的时候，将spec.clusterIP设置为 None，这个时候创建出来的 Service 并不会分配到一个 Cluster IP，此时它就被称为Headless Service。</p><p>现在我们来通过一个例子来看看 Headless Service 有什么特殊的地方。我们在上面的 Service 基础上，增加了spec.clusterIP为None，并命名为nginx-prod-demo-headless-svc：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Service</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-prod-demo-headless-svc</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">clusterIP</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">None</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">: </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">env</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">prod</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">ClusterIP</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:  </span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">http</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">port</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">targetPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">protocol</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">TCP</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Service</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-prod-demo-headless-svc</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">clusterIP</span><span style="color:#24292E;">: </span><span style="color:#032F62;">None</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">: </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">env</span><span style="color:#24292E;">: </span><span style="color:#032F62;">prod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">ClusterIP</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:  </span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">http</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">port</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">targetPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">protocol</span><span style="color:#24292E;">: </span><span style="color:#032F62;">TCP</span></span></code></pre></div><p>通过 kubectl 创建成功后，我们现在<code>kubectl get</code>一下看看：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">svc</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                           </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">CLUSTER-IP</span><span style="color:#E1E4E8;">       </span><span style="color:#9ECBFF;">EXTERNAL-IP</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">PORT</span><span style="color:#E1E4E8;">(</span><span style="color:#B392F0;">S</span><span style="color:#E1E4E8;">)   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">nginx-prod-demo-headless-svc</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">ClusterIP</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">None</span><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">/TCP</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">4</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">nginx-prod-svc-demo</span><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">ClusterIP</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">10.111</span><span style="color:#9ECBFF;">.193.186</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">&lt;</span><span style="color:#9ECBFF;">non</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">80</span><span style="color:#9ECBFF;">/TCP</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">3</span><span style="color:#9ECBFF;">d5h</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">svc</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                           </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">        </span><span style="color:#032F62;">CLUSTER-IP</span><span style="color:#24292E;">       </span><span style="color:#032F62;">EXTERNAL-IP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">PORT</span><span style="color:#24292E;">(</span><span style="color:#6F42C1;">S</span><span style="color:#24292E;">)   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-prod-demo-headless-svc</span><span style="color:#24292E;">   </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#032F62;">None</span><span style="color:#24292E;">             </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">4</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">nginx-prod-svc-demo</span><span style="color:#24292E;">            </span><span style="color:#032F62;">ClusterIP</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">10.111</span><span style="color:#032F62;">.193.186</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">&lt;</span><span style="color:#032F62;">non</span><span style="color:#24292E;">e</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">80</span><span style="color:#032F62;">/TCP</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">3</span><span style="color:#032F62;">d5h</span></span></code></pre></div><p>可以看到这个叫 nginx-prod-demo-headless-svc 的 Service 并没有分配到一个 ClusterIP，符合预期，毕竟我们已经设置了 spec.clusterIP 为 None。</p><p>我们来创建一个 Pod，看看 DNS 记录有没有什么差别。 Pod 的 yaml 文件如下：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">headless-svc-test-pod</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">dns-test</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">busybox:1.28</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;sh&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;-c&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;echo The app is running! &amp;&amp; sleep 3600&#39;</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">headless-svc-test-pod</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">dns-test</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox:1.28</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;sh&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;-c&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;echo The app is running! &amp;&amp; sleep 3600&#39;</span><span style="color:#24292E;">]</span></span></code></pre></div><p>该 Pod 创建出来后，我们通过<code>kubectl exec</code>进入 Pod 中，运行如下两条 nslookup 查询命令，依次查看两个 Service 对应的 DNS 记录：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exec</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-it</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">headless-svc-test-pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sh</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">exec</span><span style="color:#E1E4E8;"> [POD] [COMMAND] is DEPRECATED and will be removed </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> a future version. Use kubectl kubectl exec [POD] -- [COMMAND] instead.</span></span>
<span class="line"><span style="color:#B392F0;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># nslookup nginx-prod-demo-headless-svc</span></span>
<span class="line"><span style="color:#B392F0;">Server:</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">10.96</span><span style="color:#9ECBFF;">.0.10</span></span>
<span class="line"><span style="color:#B392F0;">Address</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.96</span><span style="color:#9ECBFF;">.0.10</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Name:</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">nginx-prod-demo-headless-svc</span></span>
<span class="line"><span style="color:#B392F0;">Address</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.1</span><span style="color:#9ECBFF;">.0.32</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">-1-0-32.nginx-prod-demo-headless-svc.demo.svc.cluster.local</span></span>
<span class="line"><span style="color:#B392F0;">Address</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.1</span><span style="color:#9ECBFF;">.0.33</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#9ECBFF;">-1-0-33.nginx-prod-demo-headless-svc.demo.svc.cluster.local</span></span>
<span class="line"><span style="color:#B392F0;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># nslookup nginx-prod-svc-demo</span></span>
<span class="line"><span style="color:#B392F0;">Server:</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">10.96</span><span style="color:#9ECBFF;">.0.10</span></span>
<span class="line"><span style="color:#B392F0;">Address</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.96</span><span style="color:#9ECBFF;">.0.10</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Name:</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">nginx-prod-svc-demo</span></span>
<span class="line"><span style="color:#B392F0;">Address</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.111</span><span style="color:#9ECBFF;">.193.186</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nginx-prod-svc-demo.demo.svc.cluster.local</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exec</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-it</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">headless-svc-test-pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sh</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">exec</span><span style="color:#24292E;"> [POD] [COMMAND] is DEPRECATED and will be removed </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> a future version. Use kubectl kubectl exec [POD] -- [COMMAND] instead.</span></span>
<span class="line"><span style="color:#6F42C1;">/</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># nslookup nginx-prod-demo-headless-svc</span></span>
<span class="line"><span style="color:#6F42C1;">Server:</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">10.96</span><span style="color:#032F62;">.0.10</span></span>
<span class="line"><span style="color:#6F42C1;">Address</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.96</span><span style="color:#032F62;">.0.10</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">      </span><span style="color:#032F62;">nginx-prod-demo-headless-svc</span></span>
<span class="line"><span style="color:#6F42C1;">Address</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.1</span><span style="color:#032F62;">.0.32</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">-1-0-32.nginx-prod-demo-headless-svc.demo.svc.cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">Address</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.1</span><span style="color:#032F62;">.0.33</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#032F62;">-1-0-33.nginx-prod-demo-headless-svc.demo.svc.cluster.local</span></span>
<span class="line"><span style="color:#6F42C1;">/</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># nslookup nginx-prod-svc-demo</span></span>
<span class="line"><span style="color:#6F42C1;">Server:</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">10.96</span><span style="color:#032F62;">.0.10</span></span>
<span class="line"><span style="color:#6F42C1;">Address</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.96</span><span style="color:#032F62;">.0.10</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Name:</span><span style="color:#24292E;">      </span><span style="color:#032F62;">nginx-prod-svc-demo</span></span>
<span class="line"><span style="color:#6F42C1;">Address</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.111</span><span style="color:#032F62;">.193.186</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nginx-prod-svc-demo.demo.svc.cluster.local</span></span></code></pre></div><p>我们可以看到正常 Service<code>nginx-prod-svc-demo</code>对应的 DNS 记录的是与虚拟 IP<code>10.111.193.166</code>有关的记录，而 Headless Service<code>nginx-prod-demo-headless-svc</code>则解析到所有后端的 Pod 的地址。</p><p>总结下， Headless Service 主要有如下两种场景。</p><ol><li><p>用户可以自己选择要连接哪个 Pod，通过查询 Service 的 DNS 记录来获取后端真实负载的 IP 地址，自主选择要连接哪个 IP；</p></li><li><p>可用于部署有状态服务。回顾下，我们在 StatefulSet 那节课也有 Headless Service 例子，每个 StatefulSet 管理的 Pod 都有一个单独的 DNS 记录，且域名保持不变，即<code>&lt;PodName&gt;.&lt;ServiceName&gt;.&lt;NamespaceName&gt;.svc.cluster.local</code>。这样 Statefulset 中的各个 Pod 就可以直接通过 Pod 名字解决相互间身份以及访问问题。</p></li></ol><h3 id="写在最后" tabindex="-1">写在最后 <a class="header-anchor" href="#写在最后" aria-label="Permalink to &quot;写在最后&quot;">​</a></h3><p>Service 是 Kubernetes 很重要的对象，主要负责为各种工作负载暴露服务，方便各个服务之间互访。通过对一组 Pod 提供统一入口，Service 极大地方便了用户使用，用户只需要与 Service 打交道即可，而不用过多地关心后端实例的变动，比如扩缩容、容器异常、节点宕机，等等。</p><p>正是因为有了 Service 的支持，你在 Kubernetes 部署业务会非常方便，这是相比较于 Docker Swarm 以及 Mesos Marathon 巨大的技术优势，可以说，它是 Kubernetes 是运行大规模微服务的最佳载体。</p><p>好的，如果你对本节课有什么想法或者疑问，欢迎你在留言区留言，我们一起讨论。</p>`,20);function i(C,d,B,v,g,m){const n=o("Image");return e(),c("div",null,[r,a(n,{alt:"image (4).png",src:"https://s0.lgstatic.com/i/image/M00/56/EA/Ciqc1F9sPFSAMnmPAAO5U6ZAsB0716.png"}),p(),E,a(n,{alt:"image (5).png",src:"https://s0.lgstatic.com/i/image/M00/56/F5/CgqCHl9sPGuAbYFBAAR9dQ-LWLw022.png"}),p(),y,a(n,{alt:"image (6).png",src:"https://s0.lgstatic.com/i/image/M00/56/F5/CgqCHl9sPH6AMn4jAA32mDhWECM868.png"}),p(),F])}const D=l(t,[["render",i]]);export{P as __pageData,D as default};
