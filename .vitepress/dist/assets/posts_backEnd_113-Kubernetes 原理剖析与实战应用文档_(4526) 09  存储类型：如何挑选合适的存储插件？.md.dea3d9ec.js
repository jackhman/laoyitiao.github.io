import{_ as o,j as e,o as t,g as c,k as n,h as p,s as a,Q as l}from"./chunks/framework.4e7d56ce.js";const q=JSON.parse('{"title":"Kubernetes 中的 Volume 是如何设计的？ ","description":"","frontmatter":{},"headers":[],"relativePath":"posts/backEnd/113-Kubernetes 原理剖析与实战应用文档/(4526) 09  存储类型：如何挑选合适的存储插件？.md","filePath":"posts/backEnd/113-Kubernetes 原理剖析与实战应用文档/(4526) 09  存储类型：如何挑选合适的存储插件？.md","lastUpdated":1696417798000}'),r={name:"posts/backEnd/113-Kubernetes 原理剖析与实战应用文档/(4526) 09  存储类型：如何挑选合适的存储插件？.md"},E=a("p",null,"在以前玩虚拟机的时代，大家比较少考虑存储的问题，因为在通过底层 IaaS 平台申请虚拟机的时候，大多数情况下，我们都会事先预估好需要的容量，方便虚拟机起来后可以稳定的使用这些存储资源。",-1),y=a("p",null,'但是容器与生俱来就是按照可以"运行在任何地方"（run anywhere）这一想法来设计的，对外部存储有着天然的诉求和依赖，并且由于容器本身的生命周期很短暂，在容器内保存数据是件很危险的事情，所以 Docker 通过挂载 Volume 来解决这一问题，如下图所示。',-1),i=l('<p>（<a href="https://docs.docker.com/storage/images/types-of-mounts-volume.png" target="_blank" rel="noreferrer">https://docs.docker.com/storage/images/types-of-mounts-volume.png</a>）</p><p>一般来说，这些 Volume 都是和容器的生命周期进行绑定的。当然也可以单独创建，然后按需挂载到容器中。大家有兴趣可以查看目前 <a href="https://docs.docker.com/engine/extend/legacy_plugins/#volume-plugins" target="_blank" rel="noreferrer">Docker 都适配了哪些 volume plugins</a>（卷插件）。</p><p>现在，我们先来看看 Kubernetes 中的 Volume 跟 Docker 中的设计有什么不同。</p><h3 id="kubernetes-中的-volume-是如何设计的" tabindex="-1">Kubernetes 中的 Volume 是如何设计的？ <a class="header-anchor" href="#kubernetes-中的-volume-是如何设计的" aria-label="Permalink to &quot;Kubernetes 中的 Volume 是如何设计的？&quot;">​</a></h3><p>Kubernetes 中的 Volume 在设计上，跟 Docker 略有不同。</p><p>我们都知道在Kubernetes 中，Pod 里包含了一组容器，这些容器是可以共享存储的，如下图所示。同时 Pod 内的容器又受制于各自的重启策略（你可以回到 05 节课，回顾一下重启策略），我们需要保证容器重启不会对这些存储产生影响。因此 Kubernetes 中 Volume 的生命周期是直接和 Pod 挂钩的，而不是 Pod 内的某个容器，即 Pod 在 Volume 在。在 Pod 被删除时，才会对 Volume 进行解绑（unmount）、删除等操作。至于 Volume 中的数据是否会被删除，取决于Volume 的具体类型。</p>',6),F=a("p",null,"为了丰富可以对接的存储后端，Kubernetes 中提供了很多volume plugin可供使用。我将目前的一些 plugins 做了如下的分类，方便你进行初步的了解和比较。",-1),u=a("p",null,"如下图所示，Kubelet 内部调用相应的 plugin 实现，将外部的存储挂载到 Pod 内。类似于CephFS、NFS以及 awsEBS 这一类插件，是需要管理员提前在对应的存储系统中申请好的，Kubernetes 本身其实并不负责这些Volume 的申请。",-1),d=l(`<p>（<a href="https://miro.medium.com/max/2400/1" target="_blank" rel="noreferrer">https://miro.medium.com/max/2400/1</a>*xsxMjNGNd6C_L9Vd3zYMWA.png）</p><h3 id="常见的几种内置-volume-插件" tabindex="-1">常见的几种内置 Volume 插件 <a class="header-anchor" href="#常见的几种内置-volume-插件" aria-label="Permalink to &quot;常见的几种内置 Volume 插件&quot;">​</a></h3><p>我们在前文的表格中列举了很多插件，我们在此不一一讲述其具体用法，大家有兴趣，可以到官方文档中进行进一步学习。</p><p>这里我介绍几个日常工作和生产环境中经常使用到的几个插件。</p><h4 id="configmap-和-secret" tabindex="-1">ConfigMap 和 Secret <a class="header-anchor" href="#configmap-和-secret" aria-label="Permalink to &quot;ConfigMap 和 Secret&quot;">​</a></h4><p>首先来看 ConfigMap 和 Secret，这两类对象都可以通过 Volume 形式挂载到 Pod 内，我们在上一节课中其实已经有过例子来讲述其作用和用法，在此不再赘述。</p><h4 id="downward-api" tabindex="-1">Downward API <a class="header-anchor" href="#downward-api" aria-label="Permalink to &quot;Downward API&quot;">​</a></h4><p>再来看看DownwardAPI，这是个非常有用的插件，可以帮助你获取 Pod 对象中定义的字段，比如 Pod 的标签（Labels）、Pod 的 IP 地址及 Pod 所在的命名空间（namespace）等。Downward API 有两种使用方法，既支持环境变量注入，也支持通过 Volume 挂载。</p><p>我们来看个 Volume 挂载的例子，如下是一个 Pod 的 yaml 文件：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">downwardapi-volume-demo.yaml</span></span>
<span class="line"><span style="color:#B392F0;">apiVersion:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#B392F0;">kind:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#B392F0;">metadata:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">downwardapi-volume-demo</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">namespace:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">labels:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">zone:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">us-east-coast</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">cluster:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">downward-api-test-cluster1</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">rack:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">rack-123</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">annotations:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">annotation1:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;345&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">annotation2:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;456&quot;</span></span>
<span class="line"><span style="color:#B392F0;">spec:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">containers:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">volume-test-container</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">image:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">busybox:1.28</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">command</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&quot;sh&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;-c&quot;]</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">args:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">while</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ </span><span style="color:#F97583;">-e</span><span style="color:#E1E4E8;"> /etc/podinfo/labels ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-en</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;\\n\\n&#39;</span><span style="color:#E1E4E8;">; </span><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/podinfo/labels</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">fi</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> [[ </span><span style="color:#F97583;">-e</span><span style="color:#E1E4E8;"> /etc/podinfo/annotations ]]; </span><span style="color:#F97583;">then</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#79B8FF;">echo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-en</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;\\n\\n&#39;</span><span style="color:#E1E4E8;">; </span><span style="color:#B392F0;">cat</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/podinfo/annotations</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">fi</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">sleep</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">done</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">volumeMounts:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">podinfo</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">mountPath:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/podinfo</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">volumes:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">name:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">podinfo</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">downwardAPI:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">items:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">path:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;labels&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">fieldRef:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#B392F0;">fieldPath:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">metadata.labels</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#B392F0;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">path:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;annotations&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">fieldRef:</span></span>
<span class="line"><span style="color:#E1E4E8;">              </span><span style="color:#B392F0;">fieldPath:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">metadata.annotations</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">downwardapi-volume-demo.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">apiVersion:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#6F42C1;">kind:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#6F42C1;">metadata:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">downwardapi-volume-demo</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">namespace:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">labels:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">zone:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">us-east-coast</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">cluster:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">downward-api-test-cluster1</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">rack:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">rack-123</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">annotations:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">annotation1:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;345&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">annotation2:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;456&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">spec:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">containers:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">volume-test-container</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">image:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">busybox:1.28</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">command</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;sh&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;-c&quot;]</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">args:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">while</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">do</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ </span><span style="color:#D73A49;">-e</span><span style="color:#24292E;"> /etc/podinfo/labels ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-en</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;\\n\\n&#39;</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/podinfo/labels</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">fi</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> [[ </span><span style="color:#D73A49;">-e</span><span style="color:#24292E;"> /etc/podinfo/annotations ]]; </span><span style="color:#D73A49;">then</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#005CC5;">echo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-en</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;\\n\\n&#39;</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">cat</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/podinfo/annotations</span><span style="color:#24292E;">; </span><span style="color:#D73A49;">fi</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">sleep</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">done</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">volumeMounts:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">podinfo</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">mountPath:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/podinfo</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">volumes:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">name:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">podinfo</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">downwardAPI:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">items:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">path:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;labels&quot;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">fieldRef:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#6F42C1;">fieldPath:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">metadata.labels</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#6F42C1;">-</span><span style="color:#24292E;"> </span><span style="color:#032F62;">path:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;annotations&quot;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">fieldRef:</span></span>
<span class="line"><span style="color:#24292E;">              </span><span style="color:#6F42C1;">fieldPath:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">metadata.annotations</span></span></code></pre></div><p>我们先创建这个 Pod，并通过<code>kubectl logs</code>来查看它的输出日志：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">create</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">downwardapi-volume-demo.yaml</span></span>
<span class="line"><span style="color:#B392F0;">pod/downwardapi-volume-demo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">created</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                      </span><span style="color:#9ECBFF;">READY</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">STATUS</span><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">RESTARTS</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">downwardapi-volume-demo</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">/1</span><span style="color:#E1E4E8;">     </span><span style="color:#9ECBFF;">Running</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          </span><span style="color:#79B8FF;">5</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">$</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">logs</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">demo</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">downwardapi-volume-demo</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">cluster</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;downward-api-test-cluster1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">rack</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;rack-123&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">zone</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;us-east-coast&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">annotation1</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;345&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">annotation2</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;456&quot;</span></span>
<span class="line"><span style="color:#B392F0;">kubernetes.io/config.seen</span><span style="color:#E1E4E8;">=</span><span style="color:#B392F0;">&quot;2020-09-03T12:01:58.1728583Z&quot;</span></span>
<span class="line"><span style="color:#B392F0;">kubernetes.io/config.source</span><span style="color:#E1E4E8;">=</span><span style="color:#B392F0;">&quot;api&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">cluster</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;downward-api-test-cluster1&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">rack</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;rack-123&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">zone</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;us-east-coast&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">annotation1</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;345&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">annotation2</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;456&quot;</span></span>
<span class="line"><span style="color:#B392F0;">kubernetes.io/config.seen</span><span style="color:#E1E4E8;">=</span><span style="color:#B392F0;">&quot;2020-09-03T12:01:58.1728583Z&quot;</span></span>
<span class="line"><span style="color:#B392F0;">kubernetes.io/config.source</span><span style="color:#E1E4E8;">=</span><span style="color:#B392F0;">&quot;api&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">create</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">downwardapi-volume-demo.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">pod/downwardapi-volume-demo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">created</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                      </span><span style="color:#032F62;">READY</span><span style="color:#24292E;">   </span><span style="color:#032F62;">STATUS</span><span style="color:#24292E;">    </span><span style="color:#032F62;">RESTARTS</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">downwardapi-volume-demo</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">/1</span><span style="color:#24292E;">     </span><span style="color:#032F62;">Running</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          </span><span style="color:#005CC5;">5</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">$</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">logs</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-n</span><span style="color:#24292E;"> </span><span style="color:#032F62;">demo</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">downwardapi-volume-demo</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">cluster</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;downward-api-test-cluster1&quot;</span></span>
<span class="line"><span style="color:#24292E;">rack</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;rack-123&quot;</span></span>
<span class="line"><span style="color:#24292E;">zone</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;us-east-coast&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">annotation1</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;345&quot;</span></span>
<span class="line"><span style="color:#24292E;">annotation2</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;456&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">kubernetes.io/config.seen</span><span style="color:#24292E;">=</span><span style="color:#6F42C1;">&quot;2020-09-03T12:01:58.1728583Z&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">kubernetes.io/config.source</span><span style="color:#24292E;">=</span><span style="color:#6F42C1;">&quot;api&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">cluster</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;downward-api-test-cluster1&quot;</span></span>
<span class="line"><span style="color:#24292E;">rack</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;rack-123&quot;</span></span>
<span class="line"><span style="color:#24292E;">zone</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;us-east-coast&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">annotation1</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;345&quot;</span></span>
<span class="line"><span style="color:#24292E;">annotation2</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;456&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">kubernetes.io/config.seen</span><span style="color:#24292E;">=</span><span style="color:#6F42C1;">&quot;2020-09-03T12:01:58.1728583Z&quot;</span></span>
<span class="line"><span style="color:#6F42C1;">kubernetes.io/config.source</span><span style="color:#24292E;">=</span><span style="color:#6F42C1;">&quot;api&quot;</span></span></code></pre></div><p>从上面的日志输出，我们可以看到 Downward API 可以通过 Volume 挂载到 Pod 里面，并被容器获取。</p><h4 id="emptydir" tabindex="-1">EmptyDir <a class="header-anchor" href="#emptydir" aria-label="Permalink to &quot;EmptyDir&quot;">​</a></h4><p>在 Kubernetes 中，我们也可以使用临时存储，类似于创建一个 temp dir。我们将这种类型的插件叫作 EmptyDir，从名字就可以知道，在刚开始创建的时候，就是空的临时文件夹。在 Pod 被删除后，也一同被删除，所以并不适合保存关键数据。</p><p>在使用的时候，可以参照如下的方式使用 EmptyDir：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">empty-dir-vol-demo</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">busybox:1.28</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">volume-test-container</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/cache</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cache-volume</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">cache-volume</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">emptyDir</span><span style="color:#E1E4E8;">: {}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">empty-dir-vol-demo</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox:1.28</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">volume-test-container</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/cache</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cache-volume</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">cache-volume</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">emptyDir</span><span style="color:#24292E;">: {}</span></span></code></pre></div><p>一般来说，EmptyDir 可以用来做一些临时存储，比如为耗时较长的计算任务存储中间结果或者作为共享卷为同一个 Pod 内的容器提供数据等等。</p><p>除此之外，我们也可以将<code>emptyDir.medium</code>字段设置为&quot;Memory&quot;，来挂载 tmpfs （一种基于内存的文件系统）类型的 EmptyDir。比如下面这个例子:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">empty-dir-vol-memory-demo</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">busybox:1.28</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">imagePullPolicy</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">myvolumes-container</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">command</span><span style="color:#E1E4E8;">: [</span><span style="color:#9ECBFF;">&#39;sh&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;-c&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;echo container is Running ; df -h ; sleep 3600&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/demo</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-volume</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo-volume</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">emptyDir</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">medium</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Memory</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">empty-dir-vol-memory-demo</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">busybox:1.28</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">imagePullPolicy</span><span style="color:#24292E;">: </span><span style="color:#032F62;">IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">myvolumes-container</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">command</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&#39;sh&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;-c&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;echo container is Running ; df -h ; sleep 3600&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/demo</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-volume</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo-volume</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">emptyDir</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">medium</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Memory</span></span></code></pre></div><h4 id="hostpath" tabindex="-1">HostPath <a class="header-anchor" href="#hostpath" aria-label="Permalink to &quot;HostPath&quot;">​</a></h4><p>我们再来看 HostPath，它和 EmptyDir 一样，都是利用宿主机的存储为容器分配资源。但是两者有个很大的区别，就是 HostPath 中的数据并不会随着 Pod 被删除而删除，而是会持久地存放在该节点上。</p><p>使用 HostPath 非常方便，既不需要依赖外部的存储系统，也不需要复杂的配置，还能持续存储数据。但是这里我要提醒你避免滥用：</p><ol><li><p>避免通过容器恶意修改宿主机上的文件内容；</p></li><li><p>避免容器恶意占用宿主机上的存储资源而打爆宿主机；</p></li><li><p>要考虑到 Pod 自身的声明周期，而且 Pod 是会&quot;漂移&quot;重新&quot;长&quot;到别的节点上的，所以要避免过度依赖本地的存储。</p></li></ol><p>同时使用的时候也需要额外注意，因为 Hostpath 中定义的路径是宿主机上真实的绝对路径，那么就会存在同一节点上的多个 Pod 共用一个 Hostpath 的情形，比如同一工作负载的不同实例调度到同一节点上，这会造成数据混乱，读写异常。这个时候我们就需要额外设置一些调度策略，避免这种情况发生。我们会在后面的课程中，来介绍相关的调度策略。</p><p>下面是一个使用 HostPath 的例子：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Pod</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">hostpath-demo</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">demo</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx:1.19.2</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">container-demo</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/test-pd</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">hostpath-volume</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">hostpath-volume</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">hostPath</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/data</span><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 对应宿主机上的绝对路径</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">type</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Directory</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;"># 可选字段，默认是 Directory</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Pod</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">hostpath-demo</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">demo</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.19.2</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">container-demo</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/test-pd</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">hostpath-volume</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">hostpath-volume</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">hostPath</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/data</span><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 对应宿主机上的绝对路径</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">type</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Directory</span><span style="color:#24292E;"> </span><span style="color:#6A737D;"># 可选字段，默认是 Directory</span></span></code></pre></div><p>在上面的例子中，我们要注意<code>hostpath.type</code>这个可以缺省的字段。为了保证后向兼容性，默认值是 Directory。目前这个字段还支持 DirectoryOrCreate、FileOrCreate 、File 、Socket 、CharDevice 和 BlockDevice，你可以到<a href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#hostpath" target="_blank" rel="noreferrer">官方文档</a>中去了解这几个类型的具体含义。</p><p>这个 type 可以帮助你做一些预检查，比如你期望挂载的是单个文件，如果检测到挂载路径是个目录，这个时候就会报异常，这样可以有效地避免一些误配置。</p><p>上述介绍的这几款插件，目前依然能够照常使用，也是社区自身稳定支持的插件。但是对于一些云厂商和第三方的插件，社区已经不推荐继续使用内置的方式了，而是推荐你通过 CSI（Container Storage Interface，容器存储接口）来使用这些插件。</p><h3 id="为什么社区要采用-csi" tabindex="-1">为什么社区要采用 CSI <a class="header-anchor" href="#为什么社区要采用-csi" aria-label="Permalink to &quot;为什么社区要采用 CSI&quot;">​</a></h3><p>一开始，上述这些云厂商以及第三方的卷插件（volume plugin），都是直接内置在 Kubernetes 代码库中进行开发的，目前代码库中包含 20 多个插件。但这种方式带来了很多问题。</p><ol><li><p>这些插件对 Kubernetes 代码本身的稳定性以及安全性引入了很多未知的风险，一个很小的 Bug 都有可能导致集群受到攻击或者无法工作。</p></li><li><p>这些插件的维护和 Kubernetes 的正常迭代紧密耦合在一起，一起打包和编译。即便是某个单一插件出现了 Bug，都需要通过升级 Kubernetes 的版本来修复。</p></li><li><p>社区需要维护所有的 volume plugin，并且要经过完整的测试验证流程，来保证可用性，这给社区的正常迭代平添了很多麻烦。</p></li><li><p>各个卷插件依赖的包也都要算作 Kubernetes 项目的一部分，这会让 Kubernetes 的依赖变得臃肿。</p></li><li><p>开发者被迫要将这些插件代码进行开源。</p></li></ol><p>为此，社区早在 v1.2 版本就开始尝试用 FlexVolume 插件来解决，在 v1.8 版本 GA，并停止接收任何新增的内置 volume plugin 了。用户需要遵循 FlexVolume 约定的接口规范，自己开发可执行的程序，比如二进制程序、Shell脚本等，以命令行参数作为输入，并返回 JSON 格式的结果，这样 Kubelet 就可以通过 exec 的方式调用用户的插件程序了，如下图所示。这种方式方便了各个插件的开发、更新、维护和升级，同时也和 Kubernetes 进行了解耦。在使用的时候，需要用户提前将这些二进制的文件放到各个节点上指定的目录里面（默认是<code>/usr/libexec/kubernetes/kubelet-plugins/volume/exec/</code>），方便 Kubelet 可以动态发现和调用。</p>`,34),m=l('<p>（<a href="https://miro.medium.com/max/840/0" target="_blank" rel="noreferrer">https://miro.medium.com/max/840/0</a>*OlfKs7Isngbm5mhO）</p><p>但是在实际使用中，FlexVolume 还是有很多局限性的。比如:</p><ul><li><p>需要一些前置依赖包，像 ceph 就需要安装<code>ceph-common</code>等依赖包;</p></li><li><p>部署很麻烦，而且往往需要很高的执行权限，要可以访问宿主机上的根文件系统。</p></li></ul><p>为了彻底解决FlexVolume 开发过程中遇到的问题，CSI采用了容器化的方式进行部署，并基于 Kubernetes 的语义使用各种已定义的对象，比如下节课我们要讲的 PV、PVC、StorageClass，等等。各家厂商只需要按照 CSI 的规范实现各自的接口即可。大家可以通过<a href="https://kubernetes-csi.github.io/docs/drivers.html" target="_blank" rel="noreferrer">这份官方的清单列表</a>，来查看可以用于生产环境的 CSI Driver。</p><p>社区也希望用户可以尽快体会到 CSI 带来的好处，但是并不会强迫用户立马迁移并使用新的 CSI，所以社区也着手开发了<code>CSIMIgration</code>功能，来帮助用户进行&quot;无感&quot;迁移。目前<code>CSIMigration</code>在 v1.17 时已经变为了 Beta 版本。你可以根据自己使用的volume plugin 选择开启对应的功能。</p><p>CSI 为了能更通用，在设计的时候，也变得相对复杂了一些。幸好这些开发工作都由各个厂商进行开发了，我们只需要按照各家的要求进行部署即可。由于篇幅所限，我们在此不详细解释 CSI 的工作流程了。如果你想进一步了解如何开发一个 CSI driver，可以参考<a href="https://kubernetes-csi.github.io/docs/introduction.html" target="_blank" rel="noreferrer">这份官方开发文档</a>。</p><h3 id="写在最后" tabindex="-1">写在最后 <a class="header-anchor" href="#写在最后" aria-label="Permalink to &quot;写在最后&quot;">​</a></h3><p>本节课讲的 Configmap、Secret、Downward API、EmptyDir 以及 Hostpath 都是日常频繁会使用到的 volume plugin，数据都会放在 Pod 所在的宿主机上。但是对于一些云厂商或者第三方的存储系统，我建议你直接通过 CSI 来使用。</p><p>如果你需要持久化的存储，请关注我们下一节课的内容。好的，如果你对本节课有什么想法或者疑问，欢迎你在留言区留言，我们一起讨论。</p>',9);function C(h,B,g,A,b,v){const s=e("Image");return t(),c("div",null,[E,y,n(s,{alt:"Drawing 0.png",src:"https://s0.lgstatic.com/i/image/M00/55/1E/Ciqc1F9pyf-ATyKeAAA4X7loNvA990.png"}),i,n(s,{alt:"Drawing 1.png",src:"https://s0.lgstatic.com/i/image/M00/55/29/CgqCHl9pyhuAVPi9AAGYrUBxa7Y940.png"}),F,n(s,{alt:"Drawing 2.png",src:"https://s0.lgstatic.com/i/image/M00/55/1E/Ciqc1F9pyiKAUanvAACt-6jm3jw792.png"}),u,n(s,{alt:"Drawing 3.png",src:"https://s0.lgstatic.com/i/image/M00/55/29/CgqCHl9pyiyAavysAAEPwHj90U4290.png"}),p(),d,n(s,{alt:"Drawing 4.png",src:"https://s0.lgstatic.com/i/image/M00/55/29/CgqCHl9pylGAMLzrAAC5tLcwqrg002.png"}),p(),m])}const _=o(r,[["render",C]]);export{q as __pageData,_ as default};
