import{_ as s,o as a,g as n,Q as l}from"./chunks/framework.a0d18f64.js";const b=JSON.parse('{"title":"16文件存储驱动：OverlayFS文件系统原理及生产环境的最佳配置","description":"","frontmatter":{},"headers":[],"relativePath":"posts/backEnd/045_由浅入深吃透 Docker/(4587) 16  文件存储驱动：OverlayFS 文件系统原理及生产环境的最佳配置.md","filePath":"posts/backEnd/045_由浅入深吃透 Docker/(4587) 16  文件存储驱动：OverlayFS 文件系统原理及生产环境的最佳配置.md","lastUpdated":1696682708000}'),o={name:"posts/backEnd/045_由浅入深吃透 Docker/(4587) 16  文件存储驱动：OverlayFS 文件系统原理及生产环境的最佳配置.md"},p=l(`<h1 id="_16文件存储驱动-overlayfs文件系统原理及生产环境的最佳配置" tabindex="-1">16文件存储驱动：OverlayFS文件系统原理及生产环境的最佳配置 <a class="header-anchor" href="#_16文件存储驱动-overlayfs文件系统原理及生产环境的最佳配置" aria-label="Permalink to &quot;16文件存储驱动：OverlayFS文件系统原理及生产环境的最佳配置&quot;">​</a></h1><p>前面课时我分别介绍了 Docker 常见的联合文件系统解决方案： AUFS 和 Devicemapper。今天我给你介绍一个性能更好的联合文件系统解决方案------ OverlayFS。</p><p>OverlayFS 的发展分为两个阶段。2014 年，OverlayFS 第一个版本被合并到 Linux 内核 3.18 版本中，此时的 OverlayFS 在 Docker 中被称为<code>overlay</code>文件驱动。由于第一版的<code>overlay</code>文件系统存在很多弊端（例如运行一段时间后Docker 会报 &quot;too many links problem&quot; 的错误）， Linux 内核在 4.0 版本对<code>overlay</code>做了很多必要的改进，此时的 OverlayFS 被称之为<code>overlay2</code>。</p><p>因此，在 Docker 中 OverlayFS 文件驱动被分为了两种，一种是早期的<code>overlay</code>，不推荐在生产环境中使用，另一种是更新和更稳定的<code>overlay2</code>，推荐在生产环境中使用。下面的内容我们主要围绕<code>overlay2</code>展开。</p><h3 id="使用-overlay2-的先决条件" tabindex="-1">使用 overlay2 的先决条件 <a class="header-anchor" href="#使用-overlay2-的先决条件" aria-label="Permalink to &quot;使用 overlay2 的先决条件&quot;">​</a></h3><p><code>overlay2</code>虽然很好，但是它的使用是有一定条件限制的。</p><ul><li><p>要想使用<code>overlay2</code>，Docker 版本必须高于 17.06.02。</p></li><li><p>如果你的操作系统是 RHEL 或 CentOS，Linux 内核版本必须使用 3.10.0-514 或者更高版本，其他 Linux 发行版的内核版本必须高于 4.0（例如 Ubuntu 或 Debian），你可以使用<code>uname -a</code>查看当前系统的内核版本。</p></li><li><p><code>overlay2</code>最好搭配 xfs 文件系统使用，并且使用 xfs 作为底层文件系统时，d_type必须开启，可以使用以下命令验证 d_type 是否开启：</p></li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ xfs_info </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">docker </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> grep ftype</span></span>
<span class="line"><span style="color:#E1E4E8;">naming   </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">version </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">              bsize</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">4096</span><span style="color:#E1E4E8;">   ascii</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ci</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> ftype</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ xfs_info </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">docker </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> grep ftype</span></span>
<span class="line"><span style="color:#24292E;">naming   </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">version </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">              bsize</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">4096</span><span style="color:#24292E;">   ascii</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ci</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> ftype</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span></span></code></pre></div><p>当输出结果中有 ftype=1 时，表示 d_type 已经开启。如果你的输出结果为 ftype=0，则需要重新格式化磁盘目录，命令如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ sudo mkfs.xfs </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">n ftype</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">path</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">to</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">disk</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ sudo mkfs.xfs </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">n ftype</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">path</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">to</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">disk</span></span></code></pre></div><p>另外，在生产环境中，推荐挂载 /var/lib/docker 目录到单独的磁盘或者磁盘分区，这样可以避免该目录写满影响主机的文件写入，并且把挂载信息写入到 /etc/fstab，防止机器重启后挂载信息丢失。</p><p>挂载配置中推荐开启 pquota，这样可以防止某个容器写文件溢出导致整个容器目录空间被占满。写入到 /etc/fstab 中的内容如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$UUID </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">docker xfs defaults,pquota </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$UUID </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">docker xfs defaults,pquota </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span></code></pre></div><p>其中 UUID 为 /var/lib/docker 所在磁盘或者分区的 UUID 或者磁盘路径。</p><p>如果你的操作系统无法满足上面的任何一个条件，那我推荐你使用 AUFS 或者 Devicemapper 作为你的 Docker 文件系统驱动。</p><blockquote><p>通常情况下， overlay2 会比 AUFS 和 Devicemapper 性能更好，而且更加稳定，因为 overlay2 在 inode 优化上更加高效。因此在生产环境中推荐使用 overlay2 作为 Docker 的文件驱动。</p></blockquote><p>下面我通过实例来教你如何初始化 /var/lib/docker 目录，为后面配置 Docker 的<code>overlay2</code>文件驱动做准备。</p><h4 id="准备-var-lib-docker-目录" tabindex="-1">准备 /var/lib/docker 目录 <a class="header-anchor" href="#准备-var-lib-docker-目录" aria-label="Permalink to &quot;准备 /var/lib/docker 目录&quot;">​</a></h4><p>1.使用 lsblk（Linux 查看磁盘和块设备信息命令）命令查看本机磁盘信息：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ lsblk</span></span>
<span class="line"><span style="color:#E1E4E8;">NAME   MAJ</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">MIN RM  SIZE RO TYPE MOUNTPOINT</span></span>
<span class="line"><span style="color:#E1E4E8;">vda    </span><span style="color:#79B8FF;">253</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">  500G  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> disk</span></span>
<span class="line"><span style="color:#E1E4E8;">\`</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">vda1 </span><span style="color:#79B8FF;">253</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">  500G  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> part </span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">vdb    </span><span style="color:#79B8FF;">253</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">  500G  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> disk</span></span>
<span class="line"><span style="color:#E1E4E8;">\`</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">vdb1 </span><span style="color:#79B8FF;">253</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">17</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">    8G  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> part</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ lsblk</span></span>
<span class="line"><span style="color:#24292E;">NAME   MAJ</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">MIN RM  SIZE RO TYPE MOUNTPOINT</span></span>
<span class="line"><span style="color:#24292E;">vda    </span><span style="color:#005CC5;">253</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">  500G  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> disk</span></span>
<span class="line"><span style="color:#24292E;">\`</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">vda1 </span><span style="color:#005CC5;">253</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">  500G  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> part </span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">vdb    </span><span style="color:#005CC5;">253</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">  500G  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> disk</span></span>
<span class="line"><span style="color:#24292E;">\`</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">vdb1 </span><span style="color:#005CC5;">253</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">17</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">    8G  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> part</span></span></code></pre></div><p>可以看到，我的机器有两块磁盘，一块是 vda，一块是 vdb。其中 vda 已经被用来挂载系统根目录，这里我想把 /var/lib/docker 挂载到 vdb1 分区上。</p><p>2.使用 mkfs 命令格式化磁盘 vdb1：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ sudo mkfs.xfs </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">n ftype</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">dev</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">vdb1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ sudo mkfs.xfs </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">n ftype</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">dev</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">vdb1</span></span></code></pre></div><p>3.将挂载信息写入到 /etc/fstab，保证机器重启挂载目录不丢失：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ sudo echo </span><span style="color:#9ECBFF;">&quot;/dev/vdb1 /var/lib/docker xfs defaults,pquota 0 0&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">etc</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">fstab</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ sudo echo </span><span style="color:#032F62;">&quot;/dev/vdb1 /var/lib/docker xfs defaults,pquota 0 0&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">etc</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">fstab</span></span></code></pre></div><p>4.使用 mount 命令使得挂载目录生效：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ sudo mount </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">a</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ sudo mount </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">a</span></span></code></pre></div><p>5.查看挂载信息：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ lsblk</span></span>
<span class="line"><span style="color:#E1E4E8;">NAME   MAJ</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">MIN RM  SIZE RO TYPE MOUNTPOINT</span></span>
<span class="line"><span style="color:#E1E4E8;">vda    </span><span style="color:#79B8FF;">253</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">  500G  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> disk</span></span>
<span class="line"><span style="color:#E1E4E8;">\`</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">vda1 </span><span style="color:#79B8FF;">253</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">  500G  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> part </span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">vdb    </span><span style="color:#79B8FF;">253</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">  500G  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> disk</span></span>
<span class="line"><span style="color:#E1E4E8;">\`</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">vdb1 </span><span style="color:#79B8FF;">253</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">17</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">    8G  </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> part </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">docker</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ lsblk</span></span>
<span class="line"><span style="color:#24292E;">NAME   MAJ</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">MIN RM  SIZE RO TYPE MOUNTPOINT</span></span>
<span class="line"><span style="color:#24292E;">vda    </span><span style="color:#005CC5;">253</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">  500G  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> disk</span></span>
<span class="line"><span style="color:#24292E;">\`</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">vda1 </span><span style="color:#005CC5;">253</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">  500G  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> part </span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">vdb    </span><span style="color:#005CC5;">253</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">  500G  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> disk</span></span>
<span class="line"><span style="color:#24292E;">\`</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">vdb1 </span><span style="color:#005CC5;">253</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">17</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">    8G  </span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> part </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">docker</span></span></code></pre></div><p>可以看到此时 /var/lib/docker 目录已经被挂载到了 vdb1 这个磁盘分区上。我们使用 xfs_info 命令验证下 d_type 是否已经成功开启：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ xfs_info </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">docker </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> grep ftype</span></span>
<span class="line"><span style="color:#E1E4E8;">naming   </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">version </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">              bsize</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">4096</span><span style="color:#E1E4E8;">   ascii</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ci</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;"> ftype</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ xfs_info </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">docker </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> grep ftype</span></span>
<span class="line"><span style="color:#24292E;">naming   </span><span style="color:#D73A49;">=</span><span style="color:#24292E;">version </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">              bsize</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">4096</span><span style="color:#24292E;">   ascii</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ci</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">0</span><span style="color:#24292E;"> ftype</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span></span></code></pre></div><p>可以看到输出结果为 ftype=1，证明 d_type 已经被成功开启。</p><p>准备好 /var/lib/docker 目录后，我们就可以配置 Docker 的文件驱动为 overlay2，并且启动 Docker 了。</p><h3 id="如何在-docker-中配置-overlay2" tabindex="-1">如何在 Docker 中配置 overlay2？ <a class="header-anchor" href="#如何在-docker-中配置-overlay2" aria-label="Permalink to &quot;如何在 Docker 中配置 overlay2？&quot;">​</a></h3><p>当你的系统满足上面的条件后，就可以配置你的 Docker 存储驱动为 overlay2 了，具体配置步骤如下。</p><p>1.停止已经运行的 Docker：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ sudo systemctl stop docker</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ sudo systemctl stop docker</span></span></code></pre></div><p>2.备份 /var/lib/docker 目录：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ sudo cp </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">au </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">docker </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">docker.back</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ sudo cp </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">au </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">docker </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">docker.back</span></span></code></pre></div><p>3.在 /etc/docker 目录下创建 daemon.json 文件，如果该文件已经存在，则修改配置为以下内容：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">&quot;storage-driver&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;overlay2&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">&quot;storage-opts&quot;</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;overlay2.size=20G&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;overlay2.override_kernel_check=true&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  ]</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">&quot;storage-driver&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;overlay2&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">&quot;storage-opts&quot;</span><span style="color:#24292E;">: [</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;overlay2.size=20G&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;overlay2.override_kernel_check=true&quot;</span></span>
<span class="line"><span style="color:#24292E;">  ]</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>其中 storage-driver 参数指定使用 overlay2 文件驱动，overlay2.size 参数表示限制每个容器根目录大小为 20G。限制每个容器的磁盘空间大小是通过 xfs 的 pquota 特性实现，overlay2.size 可以根据不同的生产环境来设置这个值的大小。我推荐你在生产环境中开启此参数，防止某个容器写入文件过大，导致整个 Docker 目录空间溢出。</p><p>4.启动 Docker：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ sudo systemctl start docker</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ sudo systemctl start docker</span></span></code></pre></div><p>5.检查配置是否生效：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ docker info</span></span>
<span class="line"><span style="color:#E1E4E8;">Client</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;"> Debug Mode</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">Server</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;"> Containers</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  Running</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">  Paused</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">  Stopped</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;"> Images</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;"> Server Version</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">19.03</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">12</span></span>
<span class="line"><span style="color:#E1E4E8;"> Storage Driver</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> overlay2</span></span>
<span class="line"><span style="color:#E1E4E8;">  Backing Filesystem</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> xfs</span></span>
<span class="line"><span style="color:#E1E4E8;">  Supports d_type</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">  Native Overlay Diff</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;"> Logging Driver</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> json</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">file</span></span>
<span class="line"><span style="color:#E1E4E8;"> Cgroup Driver</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> cgroupfs</span></span>
<span class="line"><span style="color:#E1E4E8;"> ... 省略部分无用输出</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ docker info</span></span>
<span class="line"><span style="color:#24292E;">Client</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;"> Debug Mode</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">Server</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;"> Containers</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  Running</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  Paused</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">  Stopped</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;"> Images</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;"> Server Version</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">19.03</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">12</span></span>
<span class="line"><span style="color:#24292E;"> Storage Driver</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> overlay2</span></span>
<span class="line"><span style="color:#24292E;">  Backing Filesystem</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> xfs</span></span>
<span class="line"><span style="color:#24292E;">  Supports d_type</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">  Native Overlay Diff</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;"> Logging Driver</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> json</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">file</span></span>
<span class="line"><span style="color:#24292E;"> Cgroup Driver</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> cgroupfs</span></span>
<span class="line"><span style="color:#24292E;"> ... 省略部分无用输出</span></span></code></pre></div><p>可以看到 Storage Driver 已经变为 overlay2，并且 d_type 也是 true。至此，你的 Docker 已经配置完成。下面我们看下 overlay2 是如何工作的。</p><h3 id="overlay2-工作原理" tabindex="-1">overlay2 工作原理 <a class="header-anchor" href="#overlay2-工作原理" aria-label="Permalink to &quot;overlay2 工作原理&quot;">​</a></h3><h4 id="overlay2-是如何存储文件的" tabindex="-1">overlay2 是如何存储文件的？ <a class="header-anchor" href="#overlay2-是如何存储文件的" aria-label="Permalink to &quot;overlay2 是如何存储文件的？&quot;">​</a></h4><p>overlay2 和 AUFS 类似，它将所有目录称之为层（layer），overlay2 的目录是镜像和容器分层的基础，而把这些层统一展现到同一的目录下的过程称为联合挂载（union mount）。overlay2 把目录的下一层叫作<code>lowerdir</code>，上一层叫作<code>upperdir</code>，联合挂载后的结果叫作<code>merged</code>。</p><blockquote><p>overlay2 文件系统最多支持 128 个层数叠加，也就是说你的 Dockerfile 最多只能写 128 行，不过这在日常使用中足够了。</p></blockquote><p>下面我们通过拉取一个 Ubuntu 操作系统的镜像来看下 overlay2 是如何存放镜像文件的。</p><p>首先，我们通过以下命令拉取 Ubuntu 镜像：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ docker pull ubuntu</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16.04</span></span>
<span class="line"><span style="color:#79B8FF;">16.04</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Pulling from library</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">ubuntu</span></span>
<span class="line"><span style="color:#E1E4E8;">8e097b52bfb8</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Pull complete</span></span>
<span class="line"><span style="color:#E1E4E8;">a613a9b4553c</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Pull complete</span></span>
<span class="line"><span style="color:#E1E4E8;">acc000f01536</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Pull complete</span></span>
<span class="line"><span style="color:#E1E4E8;">73eef93b7466</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Pull complete</span></span>
<span class="line"><span style="color:#E1E4E8;">Digest</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> sha256</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">3dd44f7ca10f07f86add9d0dc611998a1641f501833692a2651c96defe8db940</span></span>
<span class="line"><span style="color:#E1E4E8;">Status</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Downloaded newer image </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> ubuntu</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16.04</span></span>
<span class="line"><span style="color:#E1E4E8;">docker.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">library</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">ubuntu</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16.04</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ docker pull ubuntu</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16.04</span></span>
<span class="line"><span style="color:#005CC5;">16.04</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Pulling from library</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">ubuntu</span></span>
<span class="line"><span style="color:#24292E;">8e097b52bfb8</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Pull complete</span></span>
<span class="line"><span style="color:#24292E;">a613a9b4553c</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Pull complete</span></span>
<span class="line"><span style="color:#24292E;">acc000f01536</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Pull complete</span></span>
<span class="line"><span style="color:#24292E;">73eef93b7466</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Pull complete</span></span>
<span class="line"><span style="color:#24292E;">Digest</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> sha256</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">3dd44f7ca10f07f86add9d0dc611998a1641f501833692a2651c96defe8db940</span></span>
<span class="line"><span style="color:#24292E;">Status</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Downloaded newer image </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> ubuntu</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16.04</span></span>
<span class="line"><span style="color:#24292E;">docker.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">library</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">ubuntu</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16.04</span></span></code></pre></div><p>可以看到镜像一共被分为四层拉取，拉取完镜像后我们查看一下 overlay2 的目录：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ sudo ls </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">l </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">docker</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">overlay2</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">total </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">drwx</span><span style="color:#F97583;">------</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">3</span><span style="color:#E1E4E8;"> root root      </span><span style="color:#79B8FF;">47</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> 01946de89606800dac8530e3480b32be9d7c66b493a1cdf558df52d7a1476d4a</span></span>
<span class="line"><span style="color:#E1E4E8;">drwx</span><span style="color:#F97583;">------</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">4</span><span style="color:#E1E4E8;"> root root      </span><span style="color:#79B8FF;">55</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> 0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb</span></span>
<span class="line"><span style="color:#E1E4E8;">drwx</span><span style="color:#F97583;">------</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">4</span><span style="color:#E1E4E8;"> root root      </span><span style="color:#79B8FF;">72</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> 94222a2fa3b2405cb00459285dd0d0ba7e6936d9b693ed18fbb0d08b93dc272f</span></span>
<span class="line"><span style="color:#E1E4E8;">drwx</span><span style="color:#F97583;">------</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">4</span><span style="color:#E1E4E8;"> root root      </span><span style="color:#79B8FF;">72</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> 9d392cf38f245d37699bdd7672daaaa76a7d702083694fa8be380087bda5e396</span></span>
<span class="line"><span style="color:#E1E4E8;">brw</span><span style="color:#F97583;">-------</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#E1E4E8;"> root root </span><span style="color:#79B8FF;">253</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">17</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;"> backingFsBlockDev</span></span>
<span class="line"><span style="color:#E1E4E8;">drwx</span><span style="color:#F97583;">------</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">2</span><span style="color:#E1E4E8;"> root root     </span><span style="color:#79B8FF;">142</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> l</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ sudo ls </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">l </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">docker</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">overlay2</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">total </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">drwx</span><span style="color:#D73A49;">------</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">3</span><span style="color:#24292E;"> root root      </span><span style="color:#005CC5;">47</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> 01946de89606800dac8530e3480b32be9d7c66b493a1cdf558df52d7a1476d4a</span></span>
<span class="line"><span style="color:#24292E;">drwx</span><span style="color:#D73A49;">------</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">4</span><span style="color:#24292E;"> root root      </span><span style="color:#005CC5;">55</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> 0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb</span></span>
<span class="line"><span style="color:#24292E;">drwx</span><span style="color:#D73A49;">------</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">4</span><span style="color:#24292E;"> root root      </span><span style="color:#005CC5;">72</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> 94222a2fa3b2405cb00459285dd0d0ba7e6936d9b693ed18fbb0d08b93dc272f</span></span>
<span class="line"><span style="color:#24292E;">drwx</span><span style="color:#D73A49;">------</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">4</span><span style="color:#24292E;"> root root      </span><span style="color:#005CC5;">72</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> 9d392cf38f245d37699bdd7672daaaa76a7d702083694fa8be380087bda5e396</span></span>
<span class="line"><span style="color:#24292E;">brw</span><span style="color:#D73A49;">-------</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#24292E;"> root root </span><span style="color:#005CC5;">253</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">17</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;"> backingFsBlockDev</span></span>
<span class="line"><span style="color:#24292E;">drwx</span><span style="color:#D73A49;">------</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">2</span><span style="color:#24292E;"> root root     </span><span style="color:#005CC5;">142</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> l</span></span></code></pre></div><p>可以看到 overlay2 目录下出现了四个镜像层目录和一个<code>l</code>目录，我们首先来查看一下<code>l</code>目录的内容：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark has-diff vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ sudo ls </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">l </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">docker</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">overlay2</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">l</span></span>
<span class="line"><span style="color:#E1E4E8;">total </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">lrwxrwxrwx. </span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#E1E4E8;"> root root </span><span style="color:#79B8FF;">72</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> FWGSYEA56RNMS53EUCKEQIKVLQ </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> ..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">9d392cf38f245d37699bdd7672daaaa76a7d702083694fa8be380087bda5e396</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">diff</span></span>
<span class="line"><span style="color:#E1E4E8;">lrwxrwxrwx. </span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#E1E4E8;"> root root </span><span style="color:#79B8FF;">72</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> RNN2FM3YISKADNAZFRONVNWTIS </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> ..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">diff</span></span>
<span class="line"><span style="color:#E1E4E8;">lrwxrwxrwx. </span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#E1E4E8;"> root root </span><span style="color:#79B8FF;">72</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> SHAQ5GYA3UZLJJVEGXEZM34KEE </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> ..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">01946de89606800dac8530e3480b32be9d7c66b493a1cdf558df52d7a1476d4a</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">diff</span></span>
<span class="line"><span style="color:#E1E4E8;">lrwxrwxrwx. </span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#E1E4E8;"> root root </span><span style="color:#79B8FF;">72</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> VQSNH735KNX4YK2TCMBAJRFTGT </span><span style="color:#F97583;">-&gt;</span><span style="color:#E1E4E8;"> ..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">94222a2fa3b2405cb00459285dd0d0ba7e6936d9b693ed18fbb0d08b93dc272f</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">diff</span></span></code></pre><pre class="shiki github-light has-diff vp-code-light"><code><span class="line"><span style="color:#24292E;">$ sudo ls </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">l </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">docker</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">overlay2</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">l</span></span>
<span class="line"><span style="color:#24292E;">total </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">lrwxrwxrwx. </span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#24292E;"> root root </span><span style="color:#005CC5;">72</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> FWGSYEA56RNMS53EUCKEQIKVLQ </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> ..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">9d392cf38f245d37699bdd7672daaaa76a7d702083694fa8be380087bda5e396</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">diff</span></span>
<span class="line"><span style="color:#24292E;">lrwxrwxrwx. </span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#24292E;"> root root </span><span style="color:#005CC5;">72</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> RNN2FM3YISKADNAZFRONVNWTIS </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> ..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">diff</span></span>
<span class="line"><span style="color:#24292E;">lrwxrwxrwx. </span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#24292E;"> root root </span><span style="color:#005CC5;">72</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> SHAQ5GYA3UZLJJVEGXEZM34KEE </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> ..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">01946de89606800dac8530e3480b32be9d7c66b493a1cdf558df52d7a1476d4a</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">diff</span></span>
<span class="line"><span style="color:#24292E;">lrwxrwxrwx. </span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#24292E;"> root root </span><span style="color:#005CC5;">72</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> VQSNH735KNX4YK2TCMBAJRFTGT </span><span style="color:#D73A49;">-&gt;</span><span style="color:#24292E;"> ..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">94222a2fa3b2405cb00459285dd0d0ba7e6936d9b693ed18fbb0d08b93dc272f</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">diff</span></span></code></pre></div><p>可以看到<code>l</code>目录是一堆软连接，把一些较短的随机串软连到镜像层的 diff 文件夹下，这样做是为了避免达到<code>mount</code>命令参数的长度限制。</p><p>下面我们查看任意一个镜像层下的文件内容：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark has-diff vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ sudo ls </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">l </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">docker</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">overlay2</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">total </span><span style="color:#79B8FF;">8</span></span>
<span class="line"><span style="color:#E1E4E8;">drwxr</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">xr</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">x. </span><span style="color:#FDAEB7;font-style:italic;">3</span><span style="color:#E1E4E8;"> root root </span><span style="color:#79B8FF;">17</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> diff</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">rw</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">r</span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">r</span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#E1E4E8;"> root root </span><span style="color:#79B8FF;">26</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> link</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">rw</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">r</span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">r</span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#E1E4E8;"> root root </span><span style="color:#79B8FF;">86</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> lower</span></span>
<span class="line"><span style="color:#E1E4E8;">drwx</span><span style="color:#F97583;">------</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">2</span><span style="color:#E1E4E8;"> root root  </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> work</span></span></code></pre><pre class="shiki github-light has-diff vp-code-light"><code><span class="line"><span style="color:#24292E;">$ sudo ls </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">l </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">docker</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">overlay2</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">total </span><span style="color:#005CC5;">8</span></span>
<span class="line"><span style="color:#24292E;">drwxr</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">xr</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">x. </span><span style="color:#B31D28;font-style:italic;">3</span><span style="color:#24292E;"> root root </span><span style="color:#005CC5;">17</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> diff</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;">rw</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">r</span><span style="color:#D73A49;">--</span><span style="color:#24292E;">r</span><span style="color:#D73A49;">--</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#24292E;"> root root </span><span style="color:#005CC5;">26</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> link</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;">rw</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">r</span><span style="color:#D73A49;">--</span><span style="color:#24292E;">r</span><span style="color:#D73A49;">--</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#24292E;"> root root </span><span style="color:#005CC5;">86</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> lower</span></span>
<span class="line"><span style="color:#24292E;">drwx</span><span style="color:#D73A49;">------</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">2</span><span style="color:#24292E;"> root root  </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> work</span></span></code></pre></div><p><strong>镜像层的 link 文件内容为该镜像层的短 ID，diff 文件夹为该镜像层的改动内容，lower 文件为该层的所有父层镜像的短 ID。</strong></p><p>我们可以通过<code>docker image inspect</code>命令来查看某个镜像的层级关系，例如我想查看刚刚下载的 Ubuntu 镜像之间的层级关系，可以使用以下命令：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark has-diff vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ docker image inspect ubuntu</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16.04</span></span>
<span class="line"><span style="color:#E1E4E8;">...省略部分输出</span></span>
<span class="line"><span style="color:#9ECBFF;">&quot;GraphDriver&quot;</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;Data&quot;</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;LowerDir&quot;</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/var/lib/docker/overlay2/9d392cf38f245d37699bdd7672daaaa76a7d702083694fa8be380087bda5e396/diff:/var/lib/docker/overlay2/94222a2fa3b2405cb00459285dd0d0ba7e6936d9b693ed18fbb0d08b93dc272f/diff:/var/lib/docker/overlay2/01946de89606800dac8530e3480b32be9d7c66b493a1cdf558df52d7a1476d4a/diff&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;MergedDir&quot;</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/var/lib/docker/overlay2/0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb/merged&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;UpperDir&quot;</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/var/lib/docker/overlay2/0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb/diff&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;WorkDir&quot;</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/var/lib/docker/overlay2/0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb/work&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            },</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;Name&quot;</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;overlay2&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        },</span></span>
<span class="line"><span style="color:#E1E4E8;">...省略部分输出</span></span></code></pre><pre class="shiki github-light has-diff vp-code-light"><code><span class="line"><span style="color:#24292E;">$ docker image inspect ubuntu</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16.04</span></span>
<span class="line"><span style="color:#24292E;">...省略部分输出</span></span>
<span class="line"><span style="color:#032F62;">&quot;GraphDriver&quot;</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;Data&quot;</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;LowerDir&quot;</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/var/lib/docker/overlay2/9d392cf38f245d37699bdd7672daaaa76a7d702083694fa8be380087bda5e396/diff:/var/lib/docker/overlay2/94222a2fa3b2405cb00459285dd0d0ba7e6936d9b693ed18fbb0d08b93dc272f/diff:/var/lib/docker/overlay2/01946de89606800dac8530e3480b32be9d7c66b493a1cdf558df52d7a1476d4a/diff&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;MergedDir&quot;</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/var/lib/docker/overlay2/0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb/merged&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;UpperDir&quot;</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/var/lib/docker/overlay2/0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb/diff&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;WorkDir&quot;</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/var/lib/docker/overlay2/0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb/work&quot;</span></span>
<span class="line"><span style="color:#24292E;">            },</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;Name&quot;</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;overlay2&quot;</span></span>
<span class="line"><span style="color:#24292E;">        },</span></span>
<span class="line"><span style="color:#24292E;">...省略部分输出</span></span></code></pre></div><p>其中 MergedDir 代表当前镜像层在 overlay2 存储下的目录，LowerDir 代表当前镜像的父层关系，使用冒号分隔，冒号最后代表该镜像的最底层。</p><p>下面我们将镜像运行起来成为容器：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ docker run </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">name</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">ubuntu </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">d ubuntu</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16.04</span><span style="color:#E1E4E8;"> sleep </span><span style="color:#79B8FF;">3600</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ docker run </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">name</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">ubuntu </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">d ubuntu</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16.04</span><span style="color:#24292E;"> sleep </span><span style="color:#005CC5;">3600</span></span></code></pre></div><p>我们使用<code>docker inspect</code>命令来查看一下容器的工作目录：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark has-diff vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ docker inspect ubuntu</span></span>
<span class="line"><span style="color:#E1E4E8;">...省略部分输出</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;GraphDriver&quot;</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;Data&quot;</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;LowerDir&quot;</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/var/lib/docker/overlay2/4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2-init/diff:/var/lib/docker/overlay2/0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb/diff:/var/lib/docker/overlay2/9d392cf38f245d37699bdd7672daaaa76a7d702083694fa8be380087bda5e396/diff:/var/lib/docker/overlay2/94222a2fa3b2405cb00459285dd0d0ba7e6936d9b693ed18fbb0d08b93dc272f/diff:/var/lib/docker/overlay2/01946de89606800dac8530e3480b32be9d7c66b493a1cdf558df52d7a1476d4a/diff&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;MergedDir&quot;</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/var/lib/docker/overlay2/4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2/merged&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;UpperDir&quot;</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/var/lib/docker/overlay2/4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2/diff&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#9ECBFF;">&quot;WorkDir&quot;</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/var/lib/docker/overlay2/4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2/work&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            },</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&quot;Name&quot;</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;overlay2&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        },</span></span>
<span class="line"><span style="color:#E1E4E8;">...省略部分输出</span></span></code></pre><pre class="shiki github-light has-diff vp-code-light"><code><span class="line"><span style="color:#24292E;">$ docker inspect ubuntu</span></span>
<span class="line"><span style="color:#24292E;">...省略部分输出</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;GraphDriver&quot;</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;Data&quot;</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;LowerDir&quot;</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/var/lib/docker/overlay2/4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2-init/diff:/var/lib/docker/overlay2/0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb/diff:/var/lib/docker/overlay2/9d392cf38f245d37699bdd7672daaaa76a7d702083694fa8be380087bda5e396/diff:/var/lib/docker/overlay2/94222a2fa3b2405cb00459285dd0d0ba7e6936d9b693ed18fbb0d08b93dc272f/diff:/var/lib/docker/overlay2/01946de89606800dac8530e3480b32be9d7c66b493a1cdf558df52d7a1476d4a/diff&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;MergedDir&quot;</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/var/lib/docker/overlay2/4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2/merged&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;UpperDir&quot;</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/var/lib/docker/overlay2/4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2/diff&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#032F62;">&quot;WorkDir&quot;</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/var/lib/docker/overlay2/4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2/work&quot;</span></span>
<span class="line"><span style="color:#24292E;">            },</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&quot;Name&quot;</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;overlay2&quot;</span></span>
<span class="line"><span style="color:#24292E;">        },</span></span>
<span class="line"><span style="color:#24292E;">...省略部分输出</span></span></code></pre></div><p><strong>MergedDir 后面的内容即为容器层的工作目录，LowerDir 为容器所依赖的镜像层目录。</strong> 然后我们查看下 overlay2 目录下的内容：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ sudo ls </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">l </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">docker</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">overlay2</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">total </span><span style="color:#79B8FF;">0</span></span>
<span class="line"><span style="color:#E1E4E8;">drwx</span><span style="color:#F97583;">------</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">3</span><span style="color:#E1E4E8;"> root root      </span><span style="color:#79B8FF;">47</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> 01946de89606800dac8530e3480b32be9d7c66b493a1cdf558df52d7a1476d4a</span></span>
<span class="line"><span style="color:#E1E4E8;">drwx</span><span style="color:#F97583;">------</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">4</span><span style="color:#E1E4E8;"> root root      </span><span style="color:#79B8FF;">72</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">47</span><span style="color:#E1E4E8;"> 0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb</span></span>
<span class="line"><span style="color:#E1E4E8;">drwx</span><span style="color:#F97583;">------</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">5</span><span style="color:#E1E4E8;"> root root      </span><span style="color:#79B8FF;">69</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">47</span><span style="color:#E1E4E8;"> 4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2</span></span>
<span class="line"><span style="color:#E1E4E8;">drwx</span><span style="color:#F97583;">------</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">4</span><span style="color:#E1E4E8;"> root root      </span><span style="color:#79B8FF;">72</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">47</span><span style="color:#E1E4E8;"> 4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">init</span></span>
<span class="line"><span style="color:#E1E4E8;">drwx</span><span style="color:#F97583;">------</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">4</span><span style="color:#E1E4E8;"> root root      </span><span style="color:#79B8FF;">72</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> 94222a2fa3b2405cb00459285dd0d0ba7e6936d9b693ed18fbb0d08b93dc272f</span></span>
<span class="line"><span style="color:#E1E4E8;">drwx</span><span style="color:#F97583;">------</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">4</span><span style="color:#E1E4E8;"> root root      </span><span style="color:#79B8FF;">72</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">16</span><span style="color:#E1E4E8;"> 9d392cf38f245d37699bdd7672daaaa76a7d702083694fa8be380087bda5e396</span></span>
<span class="line"><span style="color:#E1E4E8;">brw</span><span style="color:#F97583;">-------</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#E1E4E8;"> root root </span><span style="color:#79B8FF;">253</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">17</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">14</span><span style="color:#E1E4E8;"> backingFsBlockDev</span></span>
<span class="line"><span style="color:#E1E4E8;">drwx</span><span style="color:#F97583;">------</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">2</span><span style="color:#E1E4E8;"> root root     </span><span style="color:#79B8FF;">210</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">47</span><span style="color:#E1E4E8;"> l</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ sudo ls </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">l </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">docker</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">overlay2</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">total </span><span style="color:#005CC5;">0</span></span>
<span class="line"><span style="color:#24292E;">drwx</span><span style="color:#D73A49;">------</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">3</span><span style="color:#24292E;"> root root      </span><span style="color:#005CC5;">47</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> 01946de89606800dac8530e3480b32be9d7c66b493a1cdf558df52d7a1476d4a</span></span>
<span class="line"><span style="color:#24292E;">drwx</span><span style="color:#D73A49;">------</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">4</span><span style="color:#24292E;"> root root      </span><span style="color:#005CC5;">72</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">47</span><span style="color:#24292E;"> 0849daa41598a333101f6a411755907d182a7fcef780c7f048f15d335b774deb</span></span>
<span class="line"><span style="color:#24292E;">drwx</span><span style="color:#D73A49;">------</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">5</span><span style="color:#24292E;"> root root      </span><span style="color:#005CC5;">69</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">47</span><span style="color:#24292E;"> 4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2</span></span>
<span class="line"><span style="color:#24292E;">drwx</span><span style="color:#D73A49;">------</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">4</span><span style="color:#24292E;"> root root      </span><span style="color:#005CC5;">72</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">47</span><span style="color:#24292E;"> 4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">init</span></span>
<span class="line"><span style="color:#24292E;">drwx</span><span style="color:#D73A49;">------</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">4</span><span style="color:#24292E;"> root root      </span><span style="color:#005CC5;">72</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> 94222a2fa3b2405cb00459285dd0d0ba7e6936d9b693ed18fbb0d08b93dc272f</span></span>
<span class="line"><span style="color:#24292E;">drwx</span><span style="color:#D73A49;">------</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">4</span><span style="color:#24292E;"> root root      </span><span style="color:#005CC5;">72</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">16</span><span style="color:#24292E;"> 9d392cf38f245d37699bdd7672daaaa76a7d702083694fa8be380087bda5e396</span></span>
<span class="line"><span style="color:#24292E;">brw</span><span style="color:#D73A49;">-------</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#24292E;"> root root </span><span style="color:#005CC5;">253</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">17</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">14</span><span style="color:#24292E;"> backingFsBlockDev</span></span>
<span class="line"><span style="color:#24292E;">drwx</span><span style="color:#D73A49;">------</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">2</span><span style="color:#24292E;"> root root     </span><span style="color:#005CC5;">210</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">47</span><span style="color:#24292E;"> l</span></span></code></pre></div><p>可以看到 overlay2 目录下增加了容器层相关的目录，我们再来查看一下容器层下的内容：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark has-diff vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ sudo ls </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">l </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">var</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">lib</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">docker</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">overlay2</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2</span></span>
<span class="line"><span style="color:#E1E4E8;">total </span><span style="color:#79B8FF;">8</span></span>
<span class="line"><span style="color:#E1E4E8;">drwxr</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">xr</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">x. </span><span style="color:#FDAEB7;font-style:italic;">2</span><span style="color:#E1E4E8;"> root root   </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">47</span><span style="color:#E1E4E8;"> diff</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">rw</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">r</span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">r</span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#E1E4E8;"> root root  </span><span style="color:#79B8FF;">26</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">47</span><span style="color:#E1E4E8;"> link</span></span>
<span class="line"><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">rw</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">r</span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">r</span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#E1E4E8;"> root root </span><span style="color:#79B8FF;">144</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">47</span><span style="color:#E1E4E8;"> lower</span></span>
<span class="line"><span style="color:#E1E4E8;">drwxr</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">xr</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">x. </span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#E1E4E8;"> root root   </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">47</span><span style="color:#E1E4E8;"> merged</span></span>
<span class="line"><span style="color:#E1E4E8;">drwx</span><span style="color:#F97583;">------</span><span style="color:#E1E4E8;">. </span><span style="color:#FDAEB7;font-style:italic;">3</span><span style="color:#E1E4E8;"> root root  </span><span style="color:#79B8FF;">18</span><span style="color:#E1E4E8;"> Sep </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> 08</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">47</span><span style="color:#E1E4E8;"> work</span></span></code></pre><pre class="shiki github-light has-diff vp-code-light"><code><span class="line"><span style="color:#24292E;">$ sudo ls </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">l </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">var</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">lib</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">docker</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">overlay2</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">4753c2aa5bdb20c97cddd6978ee3b1d07ef149e3cc2bbdbd4d11da60685fe9b2</span></span>
<span class="line"><span style="color:#24292E;">total </span><span style="color:#005CC5;">8</span></span>
<span class="line"><span style="color:#24292E;">drwxr</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">xr</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">x. </span><span style="color:#B31D28;font-style:italic;">2</span><span style="color:#24292E;"> root root   </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">47</span><span style="color:#24292E;"> diff</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;">rw</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">r</span><span style="color:#D73A49;">--</span><span style="color:#24292E;">r</span><span style="color:#D73A49;">--</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#24292E;"> root root  </span><span style="color:#005CC5;">26</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">47</span><span style="color:#24292E;"> link</span></span>
<span class="line"><span style="color:#D73A49;">-</span><span style="color:#24292E;">rw</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">r</span><span style="color:#D73A49;">--</span><span style="color:#24292E;">r</span><span style="color:#D73A49;">--</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#24292E;"> root root </span><span style="color:#005CC5;">144</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">47</span><span style="color:#24292E;"> lower</span></span>
<span class="line"><span style="color:#24292E;">drwxr</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">xr</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">x. </span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#24292E;"> root root   </span><span style="color:#005CC5;">6</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">47</span><span style="color:#24292E;"> merged</span></span>
<span class="line"><span style="color:#24292E;">drwx</span><span style="color:#D73A49;">------</span><span style="color:#24292E;">. </span><span style="color:#B31D28;font-style:italic;">3</span><span style="color:#24292E;"> root root  </span><span style="color:#005CC5;">18</span><span style="color:#24292E;"> Sep </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> 08</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">47</span><span style="color:#24292E;"> work</span></span></code></pre></div><p>link 和 lower 文件与镜像层的功能一致，****link 文件内容为该容器层的短 ID，lower 文件为该层的所有父层镜像的短 ID 。<strong>diff 目录为容器的读写层，容器内修改的文件都会在 diff 中出现，merged 目录为分层文件联合挂载后的结果，也是容器内的工作目录。</strong></p><p>总体来说，overlay2 是这样储存文件的：<code>overlay2</code>将镜像层和容器层都放在单独的目录，并且有唯一 ID，每一层仅存储发生变化的文件，最终使用联合挂载技术将容器层和镜像层的所有文件统一挂载到容器中，使得容器中看到完整的系统文件。</p><h4 id="overlay2-如何读取、修改文件" tabindex="-1">overlay2 如何读取、修改文件？ <a class="header-anchor" href="#overlay2-如何读取、修改文件" aria-label="Permalink to &quot;overlay2 如何读取、修改文件？&quot;">​</a></h4><p>overlay2 的工作过程中对文件的操作分为读取文件和修改文件。</p><p><strong>读取文件</strong></p><p>容器内进程读取文件分为以下三种情况。</p><ul><li><p>文件在容器层中存在：当文件存在于容器层并且不存在于镜像层时，直接从容器层读取文件；</p></li><li><p>当文件在容器层中不存在：当容器中的进程需要读取某个文件时，如果容器层中不存在该文件，则从镜像层查找该文件，然后读取文件内容；</p></li><li><p>文件既存在于镜像层，又存在于容器层：当我们读取的文件既存在于镜像层，又存在于容器层时，将会从容器层读取该文件。</p></li></ul><p><strong>修改文件或目录</strong></p><p>overlay2 对文件的修改采用的是写时复制的工作机制，这种工作机制可以最大程度节省存储空间。具体的文件操作机制如下。</p><ul><li>第一次修改文件：当我们第一次在容器中修改某个文件时，overlay2 会触发写时复制操作，overlay2 首先从镜像层复制文件到容器层，然后在容器层执行对应的文件修改操作。</li></ul><blockquote><p>overlay2 写时复制的操作将会复制整个文件，如果文件过大，将会大大降低文件系统的性能，因此当我们有大量文件需要被修改时，overlay2 可能会出现明显的延迟。好在，写时复制操作只在第一次修改文件时触发，对日常使用没有太大影响。</p></blockquote><ul><li>删除文件或目录：当文件或目录被删除时，overlay2 并不会真正从镜像中删除它，因为镜像层是只读的，overlay2 会创建一个特殊的文件或目录，这种特殊的文件或目录会阻止容器的访问。</li></ul><h3 id="结语" tabindex="-1">结语 <a class="header-anchor" href="#结语" aria-label="Permalink to &quot;结语&quot;">​</a></h3><p>overlay2 目前已经是 Docker 官方推荐的文件系统了，也是目前安装 Docker 时默认的文件系统，因为 overlay2 在生产环境中不仅有着较高的性能，它的稳定性也极其突出。但是 overlay2 的使用还是有一些限制条件的，例如要求 Docker 版本必须高于 17.06.02，内核版本必须高于 4.0 等。因此，在生产环境中，如果你的环境满足使用 overlay2 的条件，请尽量使用 overlay2 作为 Docker 的联合文件系统。</p><p>那么你知道除了我介绍的这三种联合文件系统外，Docker 还可以使用哪些联合文件系统吗？ 思考后，可以把你的想法写在留言区。</p><p>下一课时，我将带你进入 Docker 原理实践，自己动手使用 Golang 开发 Docker。</p>`,89),e=[p];function c(t,r,y,E,d,i){return a(),n("div",null,e)}const f=s(o,[["render",c]]);export{b as __pageData,f as default};
