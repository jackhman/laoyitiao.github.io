import{_ as o,j as e,o as t,g as c,k as a,h as p,Q as l,s}from"./chunks/framework.b3d8e22e.js";const S=JSON.parse('{"title":"Kubernetes 中的金丝雀发布 ","description":"","frontmatter":{},"headers":[],"relativePath":"posts/backEnd/微服务Service Mesh原理与实战_文档/(6010) 17  金丝雀发布：金丝雀部署和版本控制.md","filePath":"posts/backEnd/微服务Service Mesh原理与实战_文档/(6010) 17  金丝雀发布：金丝雀部署和版本控制.md","lastUpdated":1696417798000}'),r={name:"posts/backEnd/微服务Service Mesh原理与实战_文档/(6010) 17  金丝雀发布：金丝雀部署和版本控制.md"},E=l(`<p>我们先来回顾一下什么叫作金丝雀发布。</p><p>金丝雀发布也被称为灰度发布，实际上就是将少量的生产流量路由到线上服务的新版本中，以验证新版本的准确性和稳定性。</p><blockquote><p>为什么叫金丝雀发布呢，是因为金丝雀对矿场中的毒气比较敏感，所以在矿场开工前工人们会放一只金丝雀进去，以验证矿场是否存在毒气。</p></blockquote><p>在学习 Istio 如何完成金丝雀发布前，我们先来看一下 Kubernetes 是如何完成金丝雀发布的。</p><h3 id="kubernetes-中的金丝雀发布" tabindex="-1">Kubernetes 中的金丝雀发布 <a class="header-anchor" href="#kubernetes-中的金丝雀发布" aria-label="Permalink to &quot;Kubernetes 中的金丝雀发布&quot;">​</a></h3><p>我们先来看看如何在 Kubernetes 中进行版本更新。</p><p>首先启动 Minikube 环境：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">minikube start </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">kubernetes</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">version</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">v1.</span><span style="color:#FDAEB7;font-style:italic;">19</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">driver</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">docker</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">minikube start </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">kubernetes</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">version</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">v1.</span><span style="color:#B31D28;font-style:italic;">19</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">2</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">driver</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">docker</span></span></code></pre></div><p>创建 controllers/nginx-deployment.yaml 的配置文件：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx-deployment</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">nginx:1.14.2</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">ports</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">containerPort</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Deployment</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx-deployment</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">replicas</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">nginx:1.14.2</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">ports</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">containerPort</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">80</span></span></code></pre></div><p>可以看到：我们创建了 3 个副本数量的 Nginx，版本号为 1.14.2。</p><p>通过下面的命令创建 Deployment：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl apply </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f https</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//k8s.io/examples/controllers/nginx-deployment.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl apply </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f https</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//k8s.io/examples/controllers/nginx-deployment.yaml</span></span></code></pre></div><p>通过命令查看 Pod 的运行状态：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl get pods </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">show</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">labels  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">o wide</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl get pods </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">show</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">labels  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">o wide</span></span></code></pre></div><p>可以得到如下结果：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">NAME                                READY   STATUS    RESTARTS   AGE    IP           NODE       NOMINATED NODE   READINESS GATES   LABELS</span></span>
<span class="line"><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">66b6c48dd5</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">b92bv   </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          2m5s   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">3</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">            app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx,pod</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">template</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hash</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">66b6c48dd5</span></span>
<span class="line"><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">66b6c48dd5</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hshnm   </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          2m5s   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">4</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">            app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx,pod</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">template</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hash</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">66b6c48dd5</span></span>
<span class="line"><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">66b6c48dd5</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">tfwfc   </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          2m5s   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">5</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">            app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx,pod</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">template</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hash</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">66b6c48dd5</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">NAME                                READY   STATUS    RESTARTS   AGE    IP           NODE       NOMINATED NODE   READINESS GATES   LABELS</span></span>
<span class="line"><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">66b6c48dd5</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">b92bv   </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          2m5s   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">3</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">            app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx,pod</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">template</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hash</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">66b6c48dd5</span></span>
<span class="line"><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">66b6c48dd5</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hshnm   </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          2m5s   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">4</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">            app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx,pod</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">template</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hash</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">66b6c48dd5</span></span>
<span class="line"><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">66b6c48dd5</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">tfwfc   </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          2m5s   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">5</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">            app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx,pod</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">template</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hash</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">66b6c48dd5</span></span></code></pre></div><p>下一步，我们使用命令查看 Deployment详细信息：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl describe deployments</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl describe deployments</span></span></code></pre></div><p>可以看到 Nginx 的版本为 1.14.2：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">Pod Template</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  Labels</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">  app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  Containers</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">   nginx</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    Image</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">        nginx</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">1.14</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">    Port</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">80</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    Host Port</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    Environment</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    Mounts</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  Volumes</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">Pod Template</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  Labels</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">  app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  Containers</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">   nginx</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    Image</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">        nginx</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">1.14</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">2</span></span>
<span class="line"><span style="color:#24292E;">    Port</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">80</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP</span></span>
<span class="line"><span style="color:#24292E;">    Host Port</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP</span></span>
<span class="line"><span style="color:#24292E;">    Environment</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    Mounts</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">  Volumes</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><p>下面我们尝试修改 Deployment，来更新 Nginx 的版本：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl edit deployment.v1.apps</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl edit deployment.v1.apps</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment</span></span></code></pre></div><p>修改 .spec.template.spec.containers[0].image 字段，从 nginx:1.14.2 改成 nginx:1.16.1，输出如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">deployment.apps</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment edited</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">deployment.apps</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment edited</span></span></code></pre></div><p>查看滚动升级状态：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl rollout status deployment</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment</span></span>
<span class="line"><span style="color:#E1E4E8;">Waiting </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> deployment </span><span style="color:#9ECBFF;">&quot;nginx-deployment&quot;</span><span style="color:#E1E4E8;"> rollout to finish</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> out of </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> replicas have been updated...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl rollout status deployment</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment</span></span>
<span class="line"><span style="color:#24292E;">Waiting </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> deployment </span><span style="color:#032F62;">&quot;nginx-deployment&quot;</span><span style="color:#24292E;"> rollout to finish</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> out of </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> replicas have been updated...</span></span></code></pre></div><p>查看 Pod 的状态，你可以看到新的副本已经启动成功，旧版本的副本已经停止：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"> kubectl get pods </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">show</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">labels </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">o wide</span></span>
<span class="line"><span style="color:#E1E4E8;">NAME                                READY   STATUS        RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES   LABELS</span></span>
<span class="line"><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">559d658b74</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">8w29d   </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running       </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          2s    </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">3</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">            app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx,pod</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">template</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hash</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">559d658b74</span></span>
<span class="line"><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">559d658b74</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">df9rv   </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running       </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          77s   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">6</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">            app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx,pod</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">template</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hash</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">559d658b74</span></span>
<span class="line"><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">559d658b74</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ktzsh   </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running       </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          4s    </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">5</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">            app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx,pod</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">template</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hash</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">559d658b74</span></span>
<span class="line"><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">66b6c48dd5</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">b92bv   </span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Terminating   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          27m   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">3</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">            app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx,pod</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">template</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hash</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">66b6c48dd5</span></span>
<span class="line"><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">66b6c48dd5</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hshnm   </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Terminating   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          27m   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">4</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">            app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx,pod</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">template</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hash</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">66b6c48dd5</span></span>
<span class="line"><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">66b6c48dd5</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">tfwfc   </span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Terminating   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          27m   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">5</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">            app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx,pod</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">template</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hash</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">66b6c48dd5</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"> kubectl get pods </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">show</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">labels </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">o wide</span></span>
<span class="line"><span style="color:#24292E;">NAME                                READY   STATUS        RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES   LABELS</span></span>
<span class="line"><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">559d658b74</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">8w29d   </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running       </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          2s    </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">3</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">            app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx,pod</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">template</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hash</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">559d658b74</span></span>
<span class="line"><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">559d658b74</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">df9rv   </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running       </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          77s   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">6</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">            app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx,pod</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">template</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hash</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">559d658b74</span></span>
<span class="line"><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">559d658b74</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ktzsh   </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running       </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          4s    </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">5</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">            app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx,pod</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">template</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hash</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">559d658b74</span></span>
<span class="line"><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">66b6c48dd5</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">b92bv   </span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Terminating   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          27m   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">3</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">            app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx,pod</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">template</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hash</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">66b6c48dd5</span></span>
<span class="line"><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">66b6c48dd5</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hshnm   </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Terminating   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          27m   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">4</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">            app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx,pod</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">template</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hash</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">66b6c48dd5</span></span>
<span class="line"><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">66b6c48dd5</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">tfwfc   </span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Terminating   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          27m   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">5</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">            app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx,pod</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">template</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hash</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">66b6c48dd5</span></span></code></pre></div><p>我们再来看一下 Nginx 的版本信息，查看是否更新成功：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">Pod Template</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  Labels</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">  app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  Containers</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">   nginx</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    Image</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">        nginx</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">1.16</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">    Port</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">         </span><span style="color:#79B8FF;">80</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    Host Port</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">TCP</span></span>
<span class="line"><span style="color:#E1E4E8;">    Environment</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    Mounts</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  Volumes</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">Pod Template</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  Labels</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">  app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  Containers</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">   nginx</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    Image</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">        nginx</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">1.16</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span></span>
<span class="line"><span style="color:#24292E;">    Port</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">         </span><span style="color:#005CC5;">80</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP</span></span>
<span class="line"><span style="color:#24292E;">    Host Port</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">    </span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">TCP</span></span>
<span class="line"><span style="color:#24292E;">    Environment</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">    Mounts</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">  Volumes</span><span style="color:#D73A49;">:</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span></span></code></pre></div><p>最后删除 Deployment 资源，确保下面的示例可以正常运行：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl delete deployment.v1.apps</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl delete deployment.v1.apps</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment</span></span></code></pre></div><p>至此，Kubernetes 中的版本更新已经完成了，通过<strong>滚动升级</strong>的方式，可以非常方便地进行版本更新。但是这个过程中，并没有灰度功能，这就相当于直接进行新版本全量发布了，很显然不符合生产环境的要求，下面我们就来学习如何在 Kubernetes 中结合版本更新做到金丝雀发布。</p><p>首先创建 Nginx 的应用，并部署：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v1</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Service</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> my</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">svc</span></span>
<span class="line"><span style="color:#E1E4E8;">  labels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  type</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> LoadBalancer</span></span>
<span class="line"><span style="color:#E1E4E8;">  ports</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> port</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span></span>
<span class="line"><span style="color:#E1E4E8;">  selector</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> nginx</span></span>
<span class="line"><span style="color:#F97583;">---</span></span>
<span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> apps</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Deployment</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> my</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  labels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  replicas</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span></span>
<span class="line"><span style="color:#E1E4E8;">  selector</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    matchLabels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">  template</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      labels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">    spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      containers</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> nginx</span></span>
<span class="line"><span style="color:#E1E4E8;">        image</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> nginx</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">1.14</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">        ports</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> containerPort</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">80</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v1</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Service</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> my</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">svc</span></span>
<span class="line"><span style="color:#24292E;">  labels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> nginx</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  type</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> LoadBalancer</span></span>
<span class="line"><span style="color:#24292E;">  ports</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> port</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span></span>
<span class="line"><span style="color:#24292E;">  selector</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> nginx</span></span>
<span class="line"><span style="color:#D73A49;">---</span></span>
<span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> apps</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Deployment</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> my</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">nginx</span></span>
<span class="line"><span style="color:#24292E;">  labels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> nginx</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  replicas</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span></span>
<span class="line"><span style="color:#24292E;">  selector</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    matchLabels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> nginx</span></span>
<span class="line"><span style="color:#24292E;">  template</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      labels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> nginx</span></span>
<span class="line"><span style="color:#24292E;">    spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      containers</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> nginx</span></span>
<span class="line"><span style="color:#24292E;">        image</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> nginx</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">1.14</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">2</span></span>
<span class="line"><span style="color:#24292E;">        ports</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> containerPort</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">80</span></span></code></pre></div><p>创建多个资源类型：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl apply </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f https</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//k8s.io/examples/application/nginx-app.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl apply </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f https</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//k8s.io/examples/application/nginx-app.yaml</span></span></code></pre></div><p>启动 Minikube 隧道，打通网络：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">minikube tunnel</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">minikube tunnel</span></span></code></pre></div><p>通过浏览器或者 curl 命令访问 minikube ip 获取 IP，可以得到如下结果：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">curl </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">i http</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//127.0.0.1</span></span>
<span class="line"><span style="color:#E1E4E8;">HTTP</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1.1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> OK</span></span>
<span class="line"><span style="color:#E1E4E8;">Server</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> nginx</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1.14</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">Date</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Fri, </span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;"> Feb </span><span style="color:#79B8FF;">2021</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">07</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">28</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">56</span><span style="color:#E1E4E8;"> GMT</span></span>
<span class="line"><span style="color:#E1E4E8;">Content</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Type</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> text</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">html</span></span>
<span class="line"><span style="color:#E1E4E8;">Content</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Length</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">612</span></span>
<span class="line"><span style="color:#E1E4E8;">Last</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Modified</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Tue, </span><span style="color:#79B8FF;">04</span><span style="color:#E1E4E8;"> Dec </span><span style="color:#79B8FF;">2018</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">14</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">44</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">49</span><span style="color:#E1E4E8;"> GMT</span></span>
<span class="line"><span style="color:#E1E4E8;">Connection</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> keep</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">alive</span></span>
<span class="line"><span style="color:#E1E4E8;">ETag</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;5c0692e1-264&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">Accept</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Ranges</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> bytes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">curl </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">i http</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//127.0.0.1</span></span>
<span class="line"><span style="color:#24292E;">HTTP</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1.1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> OK</span></span>
<span class="line"><span style="color:#24292E;">Server</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> nginx</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1.14</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">2</span></span>
<span class="line"><span style="color:#24292E;">Date</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Fri, </span><span style="color:#005CC5;">12</span><span style="color:#24292E;"> Feb </span><span style="color:#005CC5;">2021</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">07</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">28</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">56</span><span style="color:#24292E;"> GMT</span></span>
<span class="line"><span style="color:#24292E;">Content</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Type</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> text</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">html</span></span>
<span class="line"><span style="color:#24292E;">Content</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Length</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">612</span></span>
<span class="line"><span style="color:#24292E;">Last</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Modified</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Tue, </span><span style="color:#005CC5;">04</span><span style="color:#24292E;"> Dec </span><span style="color:#005CC5;">2018</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">14</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">44</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">49</span><span style="color:#24292E;"> GMT</span></span>
<span class="line"><span style="color:#24292E;">Connection</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> keep</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">alive</span></span>
<span class="line"><span style="color:#24292E;">ETag</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;5c0692e1-264&quot;</span></span>
<span class="line"><span style="color:#24292E;">Accept</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Ranges</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> bytes</span></span></code></pre></div><p>可以看到，Nginx是可以正常访问的，从返回的 header 中，你可以看到 Nginx 版本号。</p><p>接下来，我们重复上面的 Kubernetes 版本更新时的步骤，部署一个新的版本：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl apply </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f https</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//k8s.io/examples/controllers/nginx-deployment.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl apply </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f https</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//k8s.io/examples/controllers/nginx-deployment.yaml</span></span></code></pre></div><p>修改 nginx-deployment 中 Nginx 的版本号，并为其增加新的标签 track:canary，具体路径为 .spec.template.metadata.lables.track:canary：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl edit deployment.v1.apps</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl edit deployment.v1.apps</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment</span></span></code></pre></div><p>继续查看 Pod，可以发现此时<strong>同时启动了两个版本</strong>，新启动的版本带有 track=canary 的标签：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl get pods </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">show</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">labels </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">o wide</span></span>
<span class="line"><span style="color:#E1E4E8;">NAME                               READY   STATUS    RESTARTS   AGE    IP           NODE       NOMINATED NODE   READINESS GATES   LABELS</span></span>
<span class="line"><span style="color:#E1E4E8;">my</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">66b6c48dd5</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">82v69          </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          38m    </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">8</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">            app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx,pod</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">template</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hash</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">66b6c48dd5</span></span>
<span class="line"><span style="color:#E1E4E8;">my</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">66b6c48dd5</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">clzgn          </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          38m    </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">7</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">            app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx,pod</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">template</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hash</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">66b6c48dd5</span></span>
<span class="line"><span style="color:#E1E4E8;">my</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">66b6c48dd5</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ngbql          </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          38m    </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">4</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">            app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx,pod</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">template</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hash</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">66b6c48dd5</span></span>
<span class="line"><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">975fd467c</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">7ghzx   </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          100s   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">6</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">            app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx,pod</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">template</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hash</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">975fd467c,track</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">canary</span></span>
<span class="line"><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">975fd467c</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">lx5sz   </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          104s   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">5</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">            app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx,pod</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">template</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hash</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">975fd467c,track</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">canary</span></span>
<span class="line"><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">deployment</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">975fd467c</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">vqm4m   </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">     Running   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          102s   </span><span style="color:#79B8FF;">172.18</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">3</span><span style="color:#E1E4E8;">   minikube   </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">           </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">none</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">            app</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">nginx,pod</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">template</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hash</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">975fd467c,track</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">canary</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl get pods </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">show</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">labels </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">o wide</span></span>
<span class="line"><span style="color:#24292E;">NAME                               READY   STATUS    RESTARTS   AGE    IP           NODE       NOMINATED NODE   READINESS GATES   LABELS</span></span>
<span class="line"><span style="color:#24292E;">my</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">66b6c48dd5</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">82v69          </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          38m    </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">8</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">            app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx,pod</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">template</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hash</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">66b6c48dd5</span></span>
<span class="line"><span style="color:#24292E;">my</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">66b6c48dd5</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">clzgn          </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          38m    </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">7</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">            app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx,pod</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">template</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hash</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">66b6c48dd5</span></span>
<span class="line"><span style="color:#24292E;">my</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">66b6c48dd5</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ngbql          </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          38m    </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">4</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">            app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx,pod</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">template</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hash</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">66b6c48dd5</span></span>
<span class="line"><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">975fd467c</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">7ghzx   </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          100s   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">6</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">            app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx,pod</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">template</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hash</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">975fd467c,track</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">canary</span></span>
<span class="line"><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">975fd467c</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">lx5sz   </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          104s   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">5</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">            app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx,pod</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">template</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hash</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">975fd467c,track</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">canary</span></span>
<span class="line"><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">deployment</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">975fd467c</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">vqm4m   </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">     Running   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          102s   </span><span style="color:#005CC5;">172.18</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">3</span><span style="color:#24292E;">   minikube   </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">           </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">none</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">            app</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">nginx,pod</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">template</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hash</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">975fd467c,track</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">canary</span></span></code></pre></div><p>实际上，此时 Nginx 同时运行了两个版本，我们新发布的版本是 Nginx1.16.1，可以通过 curl -i 的命令查看：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">curl </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">i http</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//127.0.0.1</span></span>
<span class="line"><span style="color:#E1E4E8;">HTTP</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1.1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> OK</span></span>
<span class="line"><span style="color:#E1E4E8;">Server</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> nginx</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">1.16</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">Date</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Fri, </span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;"> Feb </span><span style="color:#79B8FF;">2021</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">07</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">57</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> GMT</span></span>
<span class="line"><span style="color:#E1E4E8;">Content</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Type</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> text</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">html</span></span>
<span class="line"><span style="color:#E1E4E8;">Content</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Length</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">612</span></span>
<span class="line"><span style="color:#E1E4E8;">Last</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Modified</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Tue, </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> Aug </span><span style="color:#79B8FF;">2019</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">05</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">00</span><span style="color:#E1E4E8;"> GMT</span></span>
<span class="line"><span style="color:#E1E4E8;">Connection</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> keep</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">alive</span></span>
<span class="line"><span style="color:#E1E4E8;">ETag</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;5d528b4c-264&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">Accept</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">Ranges</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> bytes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">curl </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">i http</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//127.0.0.1</span></span>
<span class="line"><span style="color:#24292E;">HTTP</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1.1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> OK</span></span>
<span class="line"><span style="color:#24292E;">Server</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> nginx</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">1.16</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span></span>
<span class="line"><span style="color:#24292E;">Date</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Fri, </span><span style="color:#005CC5;">12</span><span style="color:#24292E;"> Feb </span><span style="color:#005CC5;">2021</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">07</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">57</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> GMT</span></span>
<span class="line"><span style="color:#24292E;">Content</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Type</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> text</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">html</span></span>
<span class="line"><span style="color:#24292E;">Content</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Length</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">612</span></span>
<span class="line"><span style="color:#24292E;">Last</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Modified</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Tue, </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> Aug </span><span style="color:#005CC5;">2019</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">05</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">00</span><span style="color:#24292E;"> GMT</span></span>
<span class="line"><span style="color:#24292E;">Connection</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> keep</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">alive</span></span>
<span class="line"><span style="color:#24292E;">ETag</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;5d528b4c-264&quot;</span></span>
<span class="line"><span style="color:#24292E;">Accept</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">Ranges</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> bytes</span></span></code></pre></div><p>多次运行 curl -i 命令查看结果，你可以发现，返回的 header 中同时存在 1.16.1 和 1.14.2 两个 Nginx 版本。通过这样滚动升级的方式，Kubernetes 可以做到简单的金丝雀发布，这样的方式已经可以满足一些简单的场景，但是流量比例只能通过灰度单个 Pod 的方式控制。</p><p>如果线上存在两个 Pod，我们新发布一个灰度的 Pod，这样的比例也仅仅是 33%，对于线上的大流量应用来说，这个比例还是过大了。当然，我们还可以通过<strong>增加线上运行 Pod</strong>的方式进一步降低灰度的比例，但这样的方式依然达不到精准控制的目的。</p><p>这时候就需要借助 Service Mesh 中的解决方案了，下面我们来看看在 Istio 中如何做精准流量的金丝雀发布。</p><h3 id="istio-中的金丝雀发布" tabindex="-1">Istio 中的金丝雀发布 <a class="header-anchor" href="#istio-中的金丝雀发布" aria-label="Permalink to &quot;Istio 中的金丝雀发布&quot;">​</a></h3><p>Istio和 Kubernetes 实现金丝雀发布的方式不太一样，Istio 通过 Envoy 强大的路由规则管理能力，可以灵活地<strong>控制对应版本的流量百分比</strong>。当然，你也可以通过创建其他的路由规则实现灰度，比如根据 header 中标记的特定用户进行流量路由。下面我们来看一个简单的例子，这里默认你已经安装了 Istio。</p><p>在<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=586#/detail/pc?id=6007" target="_blank" rel="noreferrer">第14讲&quot;Istio 入门：基于最新 1.7 版本的环境搭建和介绍&quot;</a>中，我们已经部署过 Bookinfo 的例子，下面我们继续用这个例子做讲解。部署相关的部分你可以参考前面的章节。</p><p>具体的示意图如下，用户访问 productpage 的请求，内部流量会分别路由到 reviews-v1 和 v2 两个版本。</p>`,58),y=l(`<p>金丝雀发布流量路由图</p><p>我们查看 Pod，也可以看到 reviews 这个服务一共启动了三个版本：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl get pods</span></span>
<span class="line"><span style="color:#E1E4E8;">NAME                               READY   STATUS            RESTARTS   AGE</span></span>
<span class="line"><span style="color:#E1E4E8;">details</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v1</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">b87bfc85d</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">nd8v7         </span><span style="color:#79B8FF;">2</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">     Running           </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          2m12s</span></span>
<span class="line"><span style="color:#E1E4E8;">productpage</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v1</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">65576bb7bf</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">hj6mw    </span><span style="color:#79B8FF;">1</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">     Running           </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          2m11s</span></span>
<span class="line"><span style="color:#E1E4E8;">ratings</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v1</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">645b477958</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">gtrqd        </span><span style="color:#79B8FF;">0</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">     PodInitializing   </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          2m12s</span></span>
<span class="line"><span style="color:#E1E4E8;">reviews</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v1</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">987d495c</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">2x5rh          </span><span style="color:#79B8FF;">2</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">     Running           </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          2m12s</span></span>
<span class="line"><span style="color:#E1E4E8;">reviews</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v2</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">6c5bf657cf</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">t66hz        </span><span style="color:#79B8FF;">2</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">     Running           </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          2m12s</span></span>
<span class="line"><span style="color:#E1E4E8;">reviews</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v3</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">5f7b9f4f77</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">gcrsj        </span><span style="color:#79B8FF;">2</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">     Running           </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">          2m12s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl get pods</span></span>
<span class="line"><span style="color:#24292E;">NAME                               READY   STATUS            RESTARTS   AGE</span></span>
<span class="line"><span style="color:#24292E;">details</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v1</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">b87bfc85d</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">nd8v7         </span><span style="color:#005CC5;">2</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">     Running           </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          2m12s</span></span>
<span class="line"><span style="color:#24292E;">productpage</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v1</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">65576bb7bf</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">hj6mw    </span><span style="color:#005CC5;">1</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">     Running           </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          2m11s</span></span>
<span class="line"><span style="color:#24292E;">ratings</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v1</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">645b477958</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">gtrqd        </span><span style="color:#005CC5;">0</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">     PodInitializing   </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          2m12s</span></span>
<span class="line"><span style="color:#24292E;">reviews</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v1</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">987d495c</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">2x5rh          </span><span style="color:#005CC5;">2</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">     Running           </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          2m12s</span></span>
<span class="line"><span style="color:#24292E;">reviews</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v2</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">6c5bf657cf</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">t66hz        </span><span style="color:#005CC5;">2</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">     Running           </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          2m12s</span></span>
<span class="line"><span style="color:#24292E;">reviews</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v3</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">5f7b9f4f77</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">gcrsj        </span><span style="color:#005CC5;">2</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">     Running           </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">          2m12s</span></span></code></pre></div><p>通过查看 samples/bookinfo/platform/kube/bookinfo.yaml 的部署配置文件，可以看到：有三个 reviews 服务的部署类型资源。通过前面 Kubernetes 灰度发布的内容我们可以知道，通过配置不同的 labels，可以让同一个服务的三个部署资源同时存在。</p><p>这三个部署资源的服务镜像指向了三个不同的地址，分别是 examples-bookinfo-reviews-v1:1.16.2、examples-bookinfo-reviews-v2:1.16.2 和 examples-bookinfo-reviews-v3:1.16.2：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">---</span></span>
<span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> apps</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Deployment</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v1</span></span>
<span class="line"><span style="color:#E1E4E8;">  labels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">    version</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v1</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  replicas</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  selector</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    matchLabels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">      version</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v1</span></span>
<span class="line"><span style="color:#E1E4E8;">  template</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      labels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">        version</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v1</span></span>
<span class="line"><span style="color:#E1E4E8;">    spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      serviceAccountName</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> bookinfo</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">      containers</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">        image</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> docker.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">istio</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">examples</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">bookinfo</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">reviews</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v1</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">1.16</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">        imagePullPolicy</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">        env</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> LOG_DIR</span></span>
<span class="line"><span style="color:#E1E4E8;">          value</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/tmp/logs&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        ports</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> containerPort</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">9080</span></span>
<span class="line"><span style="color:#E1E4E8;">        volumeMounts</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> tmp</span></span>
<span class="line"><span style="color:#E1E4E8;">          mountPath</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">tmp</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> wlp</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">output</span></span>
<span class="line"><span style="color:#E1E4E8;">          mountPath</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">opt</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">ibm</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">wlp</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">output</span></span>
<span class="line"><span style="color:#E1E4E8;">      volumes</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> wlp</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">output</span></span>
<span class="line"><span style="color:#E1E4E8;">        emptyDir</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> tmp</span></span>
<span class="line"><span style="color:#E1E4E8;">        emptyDir</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#F97583;">---</span></span>
<span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> apps</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Deployment</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v2</span></span>
<span class="line"><span style="color:#E1E4E8;">  labels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">    version</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v2</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  replicas</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  selector</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    matchLabels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">      version</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v2</span></span>
<span class="line"><span style="color:#E1E4E8;">  template</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      labels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">        version</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v2</span></span>
<span class="line"><span style="color:#E1E4E8;">    spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      serviceAccountName</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> bookinfo</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">      containers</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">        image</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> docker.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">istio</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">examples</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">bookinfo</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">reviews</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v2</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">1.16</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">        imagePullPolicy</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">        env</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> LOG_DIR</span></span>
<span class="line"><span style="color:#E1E4E8;">          value</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/tmp/logs&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        ports</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> containerPort</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">9080</span></span>
<span class="line"><span style="color:#E1E4E8;">        volumeMounts</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> tmp</span></span>
<span class="line"><span style="color:#E1E4E8;">          mountPath</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">tmp</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> wlp</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">output</span></span>
<span class="line"><span style="color:#E1E4E8;">          mountPath</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">opt</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">ibm</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">wlp</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">output</span></span>
<span class="line"><span style="color:#E1E4E8;">      volumes</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> wlp</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">output</span></span>
<span class="line"><span style="color:#E1E4E8;">        emptyDir</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> tmp</span></span>
<span class="line"><span style="color:#E1E4E8;">        emptyDir</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#F97583;">---</span></span>
<span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> apps</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> Deployment</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v3</span></span>
<span class="line"><span style="color:#E1E4E8;">  labels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">    version</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v3</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  replicas</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  selector</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    matchLabels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">      version</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v3</span></span>
<span class="line"><span style="color:#E1E4E8;">  template</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      labels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        app</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">        version</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v3</span></span>
<span class="line"><span style="color:#E1E4E8;">    spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      serviceAccountName</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> bookinfo</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">      containers</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">        image</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> docker.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">istio</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">examples</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">bookinfo</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">reviews</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v3</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">1.16</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">        imagePullPolicy</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> IfNotPresent</span></span>
<span class="line"><span style="color:#E1E4E8;">        env</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> LOG_DIR</span></span>
<span class="line"><span style="color:#E1E4E8;">          value</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;/tmp/logs&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">        ports</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> containerPort</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">9080</span></span>
<span class="line"><span style="color:#E1E4E8;">        volumeMounts</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> tmp</span></span>
<span class="line"><span style="color:#E1E4E8;">          mountPath</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">tmp</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> wlp</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">output</span></span>
<span class="line"><span style="color:#E1E4E8;">          mountPath</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">opt</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">ibm</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">wlp</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">output</span></span>
<span class="line"><span style="color:#E1E4E8;">      volumes</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> wlp</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">output</span></span>
<span class="line"><span style="color:#E1E4E8;">        emptyDir</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> tmp</span></span>
<span class="line"><span style="color:#E1E4E8;">        emptyDir</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> {}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">---</span></span>
<span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> apps</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Deployment</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v1</span></span>
<span class="line"><span style="color:#24292E;">  labels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">    version</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v1</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  replicas</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  selector</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    matchLabels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">      version</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v1</span></span>
<span class="line"><span style="color:#24292E;">  template</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      labels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">        version</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v1</span></span>
<span class="line"><span style="color:#24292E;">    spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      serviceAccountName</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> bookinfo</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">reviews</span></span>
<span class="line"><span style="color:#24292E;">      containers</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">        image</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> docker.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">istio</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">examples</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">bookinfo</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">reviews</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v1</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">1.16</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">2</span></span>
<span class="line"><span style="color:#24292E;">        imagePullPolicy</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">        env</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> LOG_DIR</span></span>
<span class="line"><span style="color:#24292E;">          value</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/tmp/logs&quot;</span></span>
<span class="line"><span style="color:#24292E;">        ports</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> containerPort</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9080</span></span>
<span class="line"><span style="color:#24292E;">        volumeMounts</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> tmp</span></span>
<span class="line"><span style="color:#24292E;">          mountPath</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">tmp</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> wlp</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">output</span></span>
<span class="line"><span style="color:#24292E;">          mountPath</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">opt</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">ibm</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">wlp</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">output</span></span>
<span class="line"><span style="color:#24292E;">      volumes</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> wlp</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">output</span></span>
<span class="line"><span style="color:#24292E;">        emptyDir</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> tmp</span></span>
<span class="line"><span style="color:#24292E;">        emptyDir</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#D73A49;">---</span></span>
<span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> apps</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Deployment</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v2</span></span>
<span class="line"><span style="color:#24292E;">  labels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">    version</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v2</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  replicas</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  selector</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    matchLabels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">      version</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v2</span></span>
<span class="line"><span style="color:#24292E;">  template</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      labels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">        version</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v2</span></span>
<span class="line"><span style="color:#24292E;">    spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      serviceAccountName</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> bookinfo</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">reviews</span></span>
<span class="line"><span style="color:#24292E;">      containers</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">        image</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> docker.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">istio</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">examples</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">bookinfo</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">reviews</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v2</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">1.16</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">2</span></span>
<span class="line"><span style="color:#24292E;">        imagePullPolicy</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">        env</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> LOG_DIR</span></span>
<span class="line"><span style="color:#24292E;">          value</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/tmp/logs&quot;</span></span>
<span class="line"><span style="color:#24292E;">        ports</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> containerPort</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9080</span></span>
<span class="line"><span style="color:#24292E;">        volumeMounts</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> tmp</span></span>
<span class="line"><span style="color:#24292E;">          mountPath</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">tmp</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> wlp</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">output</span></span>
<span class="line"><span style="color:#24292E;">          mountPath</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">opt</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">ibm</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">wlp</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">output</span></span>
<span class="line"><span style="color:#24292E;">      volumes</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> wlp</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">output</span></span>
<span class="line"><span style="color:#24292E;">        emptyDir</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> tmp</span></span>
<span class="line"><span style="color:#24292E;">        emptyDir</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#D73A49;">---</span></span>
<span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> apps</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> Deployment</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v3</span></span>
<span class="line"><span style="color:#24292E;">  labels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">    version</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v3</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  replicas</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  selector</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    matchLabels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">      version</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v3</span></span>
<span class="line"><span style="color:#24292E;">  template</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      labels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">        version</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v3</span></span>
<span class="line"><span style="color:#24292E;">    spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      serviceAccountName</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> bookinfo</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">reviews</span></span>
<span class="line"><span style="color:#24292E;">      containers</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">        image</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> docker.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">istio</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">examples</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">bookinfo</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">reviews</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v3</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">1.16</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">2</span></span>
<span class="line"><span style="color:#24292E;">        imagePullPolicy</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> IfNotPresent</span></span>
<span class="line"><span style="color:#24292E;">        env</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> LOG_DIR</span></span>
<span class="line"><span style="color:#24292E;">          value</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;/tmp/logs&quot;</span></span>
<span class="line"><span style="color:#24292E;">        ports</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> containerPort</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9080</span></span>
<span class="line"><span style="color:#24292E;">        volumeMounts</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> tmp</span></span>
<span class="line"><span style="color:#24292E;">          mountPath</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">tmp</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> wlp</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">output</span></span>
<span class="line"><span style="color:#24292E;">          mountPath</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">opt</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">ibm</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">wlp</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">output</span></span>
<span class="line"><span style="color:#24292E;">      volumes</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> wlp</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">output</span></span>
<span class="line"><span style="color:#24292E;">        emptyDir</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> {}</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> tmp</span></span>
<span class="line"><span style="color:#24292E;">        emptyDir</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> {}</span></span></code></pre></div><p>我们在页面中，反复刷新<a href="http://127.0.0.1/productpage" target="_blank" rel="noreferrer">http://127.0.0.1/productpage</a>页面，可以看到不同的三种 reviews 的显示。</p>`,7),i=s("p",null,"reivews v1 示例图",-1),F=s("p",null,"reviews v2 示例图",-1),D=l(`<p>reviews v3 示例图</p><p>通过上面的请求结果，我们可以看到，Istio 确实将流量路由到了不同的 reviews 版本上，但是这里我们还没有对 Istio 的路由规则做特殊配置，所以<strong>这里的流量是均分的</strong>，你也可以理解为和 Kubernetes 的版本灰度策略是一致的。</p><p>下面我们创建一个 reviews 的路由规则，为了方便验证，这个配置将所有流量指向 reviews 的 v1 版本：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl apply </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#E1E4E8;">EOF</span></span>
<span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> networking.istio.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1alpha3</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> VirtualService</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reivews</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  hosts</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">  http</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> route</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> destination</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        host</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">        subset</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v1</span></span>
<span class="line"><span style="color:#F97583;">---</span></span>
<span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> networking.istio.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1alpha3</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> DestinationRule</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  host</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">  subsets</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v1</span></span>
<span class="line"><span style="color:#E1E4E8;">    labels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      version</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v1</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v2</span></span>
<span class="line"><span style="color:#E1E4E8;">    labels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      version</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v2</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v3</span></span>
<span class="line"><span style="color:#E1E4E8;">    labels</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      version</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v3</span></span>
<span class="line"><span style="color:#E1E4E8;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl apply </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#24292E;">EOF</span></span>
<span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> networking.istio.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1alpha3</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> VirtualService</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reivews</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  hosts</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">  http</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> route</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> destination</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        host</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">        subset</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v1</span></span>
<span class="line"><span style="color:#D73A49;">---</span></span>
<span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> networking.istio.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1alpha3</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> DestinationRule</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  host</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">  subsets</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v1</span></span>
<span class="line"><span style="color:#24292E;">    labels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      version</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v1</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v2</span></span>
<span class="line"><span style="color:#24292E;">    labels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      version</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v2</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v3</span></span>
<span class="line"><span style="color:#24292E;">    labels</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">      version</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v3</span></span>
<span class="line"><span style="color:#24292E;">EOF</span></span></code></pre></div><p>此时，我们无论如何刷新页面，都会发现页面的显示内容，总是停留在 reviews 的 v1 版本。</p>`,5),A=l(`<p>reviews v1 示例图</p><p>这和我们的预期一致。</p><p>下面我们再做出一些改动，修改 Istio 路由配置，将 90% 的流量指向 v1 版本，10% 的流量指向 v2 版本，以达到我们最开始的需求------精准流量的金丝雀发布：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">$ kubectl apply -f - &lt;&lt;EOF</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">networking.istio.io/v1alpha3</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">VirtualService</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">reivews</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">hosts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#9ECBFF;">reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">http</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  - </span><span style="color:#85E89D;">route</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">destination</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">subset</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v1</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">weight</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">90</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">destination</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">host</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">subset</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">v2</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">weight</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#9ECBFF;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">$ kubectl apply -f - &lt;&lt;EOF</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">networking.istio.io/v1alpha3</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">VirtualService</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">reivews</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">hosts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#032F62;">reviews</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">http</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  - </span><span style="color:#22863A;">route</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">destination</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">reviews</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">subset</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v1</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">weight</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">90</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">destination</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">host</span><span style="color:#24292E;">: </span><span style="color:#032F62;">reviews</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">subset</span><span style="color:#24292E;">: </span><span style="color:#032F62;">v2</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">weight</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#032F62;">EOF</span></span></code></pre></div><p>成功执行上述命令，我们反复刷新 productpage 页面，可以发现大概有 10% 的流量被路由到了新的 reviews v2 版本。</p>`,5),d=l(`<p>reviews v2 版本示例图</p><p>至此，我们就掌握了 Istio 做金丝雀发布的原理。在现实场景中，我们可以根据需求灵活地设置 reviews v1 版本和 v2 版本的流量比例，比如设置 v2 版本流量比例为 1%，用于金丝雀发布，这样的方式相较于 Kubernetes 启动 100 个 pod 进行金丝雀发布，要灵活得多。</p><p>在金丝雀发布的过程中，通过<strong>不断增加 v2 的流量比例</strong>达到精准流量灰度发布的目的，配合 Metrics 监控指标，可以随时自动调整 v2 的比例，以减少新版本出问题时对生产环境的影响。随着 v2 版本的流量不断增大，最终彻底替代 v1 版本成为线上正式版本，整个金丝雀发布也就结束了。</p><p>当然需要注意的是，在整个过程中你应该灵活调整 v1 和 v2 版本的 Kubernetes 副本数量，或者配合 Kubernetes 的 HPA，以达到<strong>自动扩缩容</strong>的目的：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ kubectl autoscale deployment reviews</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v1 </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">cpu</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">percent</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">min</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">max</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">$ kubectl autoscale deployment reviews</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">v2 </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">cpu</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">percent</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">50</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">min</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">max</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">10</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ kubectl autoscale deployment reviews</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v1 </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">cpu</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">percent</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">min</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">max</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">$ kubectl autoscale deployment reviews</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">v2 </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">cpu</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">percent</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">50</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">min</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">max</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">10</span></span></code></pre></div><p>至此，Istio 中的金丝雀发布就讲完了，下面我们来看一下 Istio 中另一个强大的功能：<strong>针对 header 设置路由策略，以达到金丝雀测试的目的</strong>。简单来说，就是针对不同用户或不同的客户端版本（针对测试人员单独发布的测试版本），进行精准的流量路由。</p><h3 id="istio-金丝雀测试" tabindex="-1">Istio 金丝雀测试 <a class="header-anchor" href="#istio-金丝雀测试" aria-label="Permalink to &quot;Istio 金丝雀测试&quot;">​</a></h3><p>首先我们创建一个 VirtualService 配置，将登录用户名为 testuser 的用户指向测试版本 v2 和 v3，其中 v3 流量占比 90%，v2 流量占比 10%。这个版本专门用于 testuser 的测试人员进行新版本的测试，其他登录用户全部路由到 v1 版本：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kubectl apply </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;&lt;</span><span style="color:#E1E4E8;">EOF</span></span>
<span class="line"><span style="color:#E1E4E8;">apiVersion</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> networking.istio.io</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">v1alpha3</span></span>
<span class="line"><span style="color:#E1E4E8;">kind</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> VirtualService</span></span>
<span class="line"><span style="color:#E1E4E8;">metadata</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  name</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">spec</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  hosts</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">  http</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> match</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> headers</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        end</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">user</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          exact</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> testuser</span></span>
<span class="line"><span style="color:#E1E4E8;">    route</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> destination</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        host</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">        subset</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v2</span></span>
<span class="line"><span style="color:#E1E4E8;">      weight</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> destination</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        host</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">        subset</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v3</span></span>
<span class="line"><span style="color:#E1E4E8;">      weight</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">90</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> route</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> destination</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        host</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> reviews</span></span>
<span class="line"><span style="color:#E1E4E8;">        subset</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> v1</span></span>
<span class="line"><span style="color:#E1E4E8;">EOF</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kubectl apply </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;&lt;</span><span style="color:#24292E;">EOF</span></span>
<span class="line"><span style="color:#24292E;">apiVersion</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> networking.istio.io</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">v1alpha3</span></span>
<span class="line"><span style="color:#24292E;">kind</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> VirtualService</span></span>
<span class="line"><span style="color:#24292E;">metadata</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  name</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">spec</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  hosts</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">  http</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> match</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> headers</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        end</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">user</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">          exact</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> testuser</span></span>
<span class="line"><span style="color:#24292E;">    route</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> destination</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        host</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">        subset</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v2</span></span>
<span class="line"><span style="color:#24292E;">      weight</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> destination</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        host</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">        subset</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v3</span></span>
<span class="line"><span style="color:#24292E;">      weight</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">90</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> route</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> destination</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">        host</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> reviews</span></span>
<span class="line"><span style="color:#24292E;">        subset</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> v1</span></span>
<span class="line"><span style="color:#24292E;">EOF</span></span></code></pre></div><p>执行成功后，我们反复访问 productpage 页面，发现流量大部分都路由到了 v3 版本，少量流量路由到了 v2 版本。</p>`,10),g=s("p",null,"reviews v3 示例图",-1),v=s("p",null,"至此，我们就完成了 Istio 的金丝雀测试。",-1),m=s("h3",{id:"总结",tabindex:"-1"},[p("总结 "),s("a",{class:"header-anchor",href:"#总结","aria-label":'Permalink to "总结"'},"​")],-1),u=s("p",null,"这一讲我主要介绍了 Kubernetes 和 Istio 中的版本控制和金丝雀发布。通过今天的学习，相信你已经体会到了 Istio 的金丝雀发布相较于 Kubernetes 的强大之处。",-1),h=s("p",null,"本讲内容总结如下：",-1),C=s("p",null,"利用 Envoy 强大的路由功能，我们可以实现精准流量的金丝雀发布和测试。在你的经历中，除了今天提到的内容，我们还能利用 Envoy 强大的路由规则实现哪些功能呢? 欢迎在留言区和我分享你的观点。",-1),b=s("p",null,"今天内容到这里就结束了，下一讲我将和你分享如何在 Istio 中实现微服务的可观测性，这部分内容包括 Trace、Metrics 和 Log 的落地实战。我们下一讲再见。",-1);function k(B,f,x,w,_,T){const n=e("Image");return t(),c("div",null,[E,a(n,{alt:"图片1.png",src:"https://s0.lgstatic.com/i/image6/M01/04/59/CioPOWAqLz-AP4aFAACYJ4vDHDg336.png"}),p(),y,a(n,{alt:"Drawing 1.png",src:"https://s0.lgstatic.com/i/image6/M00/04/4C/CioPOWAotneATlvKAAC3V8uQuCk887.png"}),p(),i,a(n,{alt:"Drawing 2.png",src:"https://s0.lgstatic.com/i/image6/M00/04/50/Cgp9HWAotn2AAzKyAADUCZzLAZs120.png"}),p(),F,a(n,{alt:"Drawing 3.png",src:"https://s0.lgstatic.com/i/image6/M00/04/50/Cgp9HWAotoSAX4gBAADOeH5BVmY833.png"}),p(),D,a(n,{alt:"Drawing 4.png",src:"https://s0.lgstatic.com/i/image6/M00/04/4C/CioPOWAotoyAVJRTAAC_osCoHRA703.png"}),p(),A,a(n,{alt:"Drawing 5.png",src:"https://s0.lgstatic.com/i/image6/M00/04/4C/CioPOWAotpSASKD-AADXP-5HVXE811.png"}),p(),d,a(n,{alt:"Drawing 6.png",src:"https://s0.lgstatic.com/i/image6/M00/04/50/Cgp9HWAotp6ADnopAADPrvDXjnY160.png"}),p(),g,v,m,u,h,a(n,{alt:"Drawing 7.png",src:"https://s0.lgstatic.com/i/image6/M00/04/4C/CioPOWAotqWAP4syAAGjh_cvuPM271.png"}),C,b])}const R=o(r,[["render",k]]);export{S as __pageData,R as default};
