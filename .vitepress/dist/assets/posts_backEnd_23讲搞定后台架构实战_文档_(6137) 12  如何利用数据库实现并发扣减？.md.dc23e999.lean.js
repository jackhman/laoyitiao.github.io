import{_ as o,j as e,o as n,g as i,k as t,h as a,Q as s,s as p}from"./chunks/framework.a0d18f64.js";const V=JSON.parse('{"title":"12 如何利用数据库实现并发扣减？","description":"","frontmatter":{},"headers":[],"relativePath":"posts/backEnd/23讲搞定后台架构实战_文档/(6137) 12  如何利用数据库实现并发扣减？.md","filePath":"posts/backEnd/23讲搞定后台架构实战_文档/(6137) 12  如何利用数据库实现并发扣减？.md","lastUpdated":1696682708000}'),r={name:"posts/backEnd/23讲搞定后台架构实战_文档/(6137) 12  如何利用数据库实现并发扣减？.md"},c=s("",25),_=p("p",null,"图 1：纯数据库扣减架构图",-1),d=p("blockquote",null,[p("p",null,"注意，扣减服务是一个后端服务，因本课程是介绍后台架构，对于扣减中涉及的前端技术不进行赘述，后续再提到的各种服务可直接默认为提供 RPC 接口的后端应用。")],-1),h=p("p",null,[a("数量数据库存储扣减中的所有数据，主要包含两张表：扣减剩余数量表和流水表。扣减剩余数量表是最主要的表，包含实时的剩余数量。主要结构如下表 1 所示："),p("br"),a(" 表 1：扣减剩余数量表")],-1),u=p("p",null,"如上表所示，对于当前剩余可购买的数量，当用户进行取消订单、售后等场景时，都需要把数量加回到此字段。同时，当商家补齐库存时，也需要把数量加回。",-1),g=p("p",null,[a("从完成业务功能的角度看，只要扣减剩余数量表即可。但在实际场景中，会需要查看明细进行对账、盘货、排查问题等需求。其次，在扣减后需要进行返还时是非常依赖流水的。因为只能返还有扣减记录的库存数量。最后，在技术上的幂等性，也非常依赖流水表。下面我们来看一下流水表的主要结构，如下表 2 所示："),p("br"),a(" 表 2：扣减流水表")],-1),A=p("h4",{id:"_1-扣减接口实现",tabindex:"-1"},[a("1. 扣减接口实现 "),p("a",{class:"header-anchor",href:"#_1-扣减接口实现","aria-label":'Permalink to "1. 扣减接口实现"'},"​")],-1),m=p("p",null,"完成了存储的数据结构设计后，咱们再来学习一下扣减服务提供的扣减接口的实现。扣减接口接受用户提交的扣减请求，包含用户账号、一批商品及对应的购买数量，大致实现逻辑如下图 2 所示：",-1),b=s("",14),E=p("p",null,"图 3：读写分离的扣减架构图",-1),q=p("p",null,"整体的升级策略采用了读写分离的方式，另外主从复制直接使用了 MySQL 等数据库已有功能，改动上非常小，只要在扣减服务里配置两个数据源。当客户查询剩余库存数量、扣减服务中的前置校验时，读取从数据库即可。而真正的数据扣减还是使用主数据库。",-1),P=p("p",null,"读写分离之后，根据二八原则，80% 的均为读流量，主库的压力降低了 80%。但采用了读写分离也会导致读取的数据不准确的问题，不过库存数量本身就在实时变化，短暂的差异业务上是可以容忍的，最终的实际扣减会保证数据的准确性。",-1),k=p("p",null,"不过，在上面提到的因为在扣减前，为了降低数据库的压力，增加的前置校验导致的性能下降问题，并没有得到太多实质性的升级解决。那么，接下来我们该从什么方向上解决这个问题呢？",-1),C=p("h4",{id:"_3-扣减接口实现再升级",tabindex:"-1"},[a("3. 扣减接口实现再升级 "),p("a",{class:"header-anchor",href:"#_3-扣减接口实现再升级","aria-label":'Permalink to "3. 扣减接口实现再升级"'},"​")],-1),S=p("p",null,[a('在基于数据库的主从复制降低了主库流量压力之后，还需要升级的就是读取的性能了。这里用到了我们在"'),p("strong",null,"模块二：构建高性能读服务"),a('"里学习到的：使用 Binlog 实现简单、可靠的异构数据同步的技能，应用此方案后整体的架构如下图 4 所示：')],-1),y=s("",23);function T(f,v,x,D,F,U){const l=e("Image");return n(),i("div",null,[c,t(l,{alt:"图片1.png",src:"https://s0.lgstatic.com/i/image6/M00/04/56/Cgp9HWApcLGAA14FAAEV09SPPKc433.png"}),a(),_,d,h,t(l,{alt:"图片2.png",src:"https://s0.lgstatic.com/i/image6/M00/04/53/CioPOWApcMKAFTDqAAC_Cy-JUZw200.png"}),a(),u,g,t(l,{alt:"图片3.png",src:"https://s0.lgstatic.com/i/image6/M00/04/53/CioPOWApcNCADIF0AADDNJfiBc4396.png"}),a(),A,m,t(l,{alt:"图片4.png",src:"https://s0.lgstatic.com/i/image6/M00/04/56/Cgp9HWApcOmAJUgzAAFb9E3dPqI312.png"}),a(),b,t(l,{alt:"图片5.png",src:"https://s0.lgstatic.com/i/image6/M00/04/56/Cgp9HWApcPuAcMC5AAFXGYoBi64806.png"}),a(),E,q,P,k,C,S,t(l,{alt:"图片6.png",src:"https://s0.lgstatic.com/i/image6/M00/04/53/CioPOWApcQ6AUK4xAAHzcrHHvOU268.png"}),a(),y])}const N=o(r,[["render",T]]);export{V as __pageData,N as default};
