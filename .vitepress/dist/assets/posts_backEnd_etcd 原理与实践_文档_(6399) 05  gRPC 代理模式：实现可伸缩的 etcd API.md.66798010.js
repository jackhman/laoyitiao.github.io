import{_ as p,j as t,o as e,g as c,k as n,h as o,s,Q as l}from"./chunks/framework.4e7d56ce.js";const w=JSON.parse('{"title":"05gRPC代理模式：实现可伸缩的etcdAPI","description":"","frontmatter":{},"headers":[],"relativePath":"posts/backEnd/etcd 原理与实践_文档/(6399) 05  gRPC 代理模式：实现可伸缩的 etcd API.md","filePath":"posts/backEnd/etcd 原理与实践_文档/(6399) 05  gRPC 代理模式：实现可伸缩的 etcd API.md","lastUpdated":1696417798000}'),r={name:"posts/backEnd/etcd 原理与实践_文档/(6399) 05  gRPC 代理模式：实现可伸缩的 etcd API.md"},y=s("h1",{id:"_05grpc代理模式-实现可伸缩的etcdapi",tabindex:"-1"},[o("05gRPC代理模式：实现可伸缩的etcdAPI "),s("a",{class:"header-anchor",href:"#_05grpc代理模式-实现可伸缩的etcdapi","aria-label":'Permalink to "05gRPC代理模式：实现可伸缩的etcdAPI"'},"​")],-1),E=s("p",null,[o("gRPC proxy 是在 gRPC 层（L7）运行的无状态 etcd 反向代理，旨在"),s("strong",null,"减少核心 etcd 集群上的总处理负载"),o("。gRPC proxy 合并了监视和 Lease API 请求，实现了水平可伸缩性。同时，为了保护集群免受滥用客户端的侵害，gRPC proxy 实现了键值对的读请求缓存。")],-1),i=s("p",null,"下面我们将围绕 gRPC proxy 基本应用、客户端端点同步、可伸缩的 API、命名空间的实现和其他扩展功能展开介绍。",-1),F=s("h3",{id:"grpc-proxy-基本应用",tabindex:"-1"},[o("gRPC proxy 基本应用 "),s("a",{class:"header-anchor",href:"#grpc-proxy-基本应用","aria-label":'Permalink to "gRPC proxy 基本应用"'},"​")],-1),u=s("p",null,"首先我们来配置 etcd 集群，集群中拥有如下的静态成员信息：",-1),d=l(`<p>使用<code>etcd grpc-proxy start</code>的命令开启 etcd 的 gRPC proxy 模式，包含上表中的静态成员：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ etcd grpc</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">proxy start </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">http</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//192.168.10.7:2379,http://192.168.10.8:2379,http://192.168.10.9:2379 --listen-addr=192.168.10.7:12379</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#9ECBFF;">&quot;level&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;info&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;ts&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;2020-12-13T01:41:57.561+0800&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;caller&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;etcdmain/grpc_proxy.go:320&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;msg&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;listening for gRPC proxy client requests&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;address&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;192.168.10.7:12379&quot;</span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#9ECBFF;">&quot;level&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;info&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;ts&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;2020-12-13T01:41:57.561+0800&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;caller&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;etcdmain/grpc_proxy.go:218&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;msg&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;started gRPC proxy&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;address&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;192.168.10.7:12379&quot;</span><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ etcd grpc</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">proxy start </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">http</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//192.168.10.7:2379,http://192.168.10.8:2379,http://192.168.10.9:2379 --listen-addr=192.168.10.7:12379</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#032F62;">&quot;level&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;info&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;ts&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;2020-12-13T01:41:57.561+0800&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;caller&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;etcdmain/grpc_proxy.go:320&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;msg&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;listening for gRPC proxy client requests&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;address&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;192.168.10.7:12379&quot;</span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#032F62;">&quot;level&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;info&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;ts&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;2020-12-13T01:41:57.561+0800&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;caller&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;etcdmain/grpc_proxy.go:218&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;msg&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;started gRPC proxy&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;address&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;192.168.10.7:12379&quot;</span><span style="color:#24292E;">}</span></span></code></pre></div><p>可以看到，etcd gRPC proxy 启动后在<code>192.168.10.7:12379</code>监听，并将客户端的请求转发到上述三个成员其中的一个。通过下述客户端读写命令，经过 proxy 发送请求：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> etcdctl </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">192.168</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">10</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">7</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">12379</span><span style="color:#E1E4E8;"> put foo bar</span></span>
<span class="line"><span style="color:#E1E4E8;">OK</span></span>
<span class="line"><span style="color:#E1E4E8;">$ ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> etcdctl </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">192.168</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">10</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">7</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">12379</span><span style="color:#E1E4E8;"> get foo</span></span>
<span class="line"><span style="color:#E1E4E8;">foo</span></span>
<span class="line"><span style="color:#E1E4E8;">bar</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> etcdctl </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">192.168</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">10</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">7</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">12379</span><span style="color:#24292E;"> put foo bar</span></span>
<span class="line"><span style="color:#24292E;">OK</span></span>
<span class="line"><span style="color:#24292E;">$ ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> etcdctl </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">192.168</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">10</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">7</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">12379</span><span style="color:#24292E;"> get foo</span></span>
<span class="line"><span style="color:#24292E;">foo</span></span>
<span class="line"><span style="color:#24292E;">bar</span></span></code></pre></div><p>我们通过 grpc-proxy 提供的客户端地址进行访问，proxy 执行的结果符合预期，在使用方法上和普通的方式完全相同。</p><h3 id="客户端端点同步" tabindex="-1">客户端端点同步 <a class="header-anchor" href="#客户端端点同步" aria-label="Permalink to &quot;客户端端点同步&quot;">​</a></h3><p>gRPC 代理是 gRPC 命名的提供者，支持<strong>在启动时通过写入相同的前缀端点名称</strong>进行注册。这样可以使客户端将其端点与具有一组相同前缀端点名的代理端点同步，进而实现高可用性。</p><p>下面我们来启动两个 gRPC 代理，在启动时指定自定义的前缀<code>___grpc_proxy_endpoint</code>来注册 gRPC 代理：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ etcd grpc</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">proxy start </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">localhost</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">12379</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">listen</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">addr</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">23790</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">advertise</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">client</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">url</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">23790</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">resolver</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">prefix</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;___grpc_proxy_endpoint&quot;</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">resolver</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ttl</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">60</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#9ECBFF;">&quot;level&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;info&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;ts&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;2020-12-13T01:46:04.885+0800&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;caller&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;etcdmain/grpc_proxy.go:320&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;msg&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;listening for gRPC proxy client requests&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;address&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;127.0.0.1:23790&quot;</span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#9ECBFF;">&quot;level&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;info&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;ts&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;2020-12-13T01:46:04.885+0800&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;caller&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;etcdmain/grpc_proxy.go:218&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;msg&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;started gRPC proxy&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;address&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;127.0.0.1:23790&quot;</span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#79B8FF;">2020</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">12</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">01</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">46</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">04</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">892061</span><span style="color:#E1E4E8;"> I </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> grpcproxy</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> registered </span><span style="color:#9ECBFF;">&quot;127.0.0.1:23790&quot;</span><span style="color:#E1E4E8;"> with </span><span style="color:#79B8FF;">60</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">second lease</span></span>
<span class="line"><span style="color:#E1E4E8;">$ etcd grpc</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">proxy start </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">localhost</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">12379</span><span style="color:#E1E4E8;"> \\</span></span>
<span class="line"><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">listen</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">addr</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">23791</span><span style="color:#E1E4E8;"> \\</span></span>
<span class="line"><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">advertise</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">client</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">url</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">23791</span><span style="color:#E1E4E8;"> \\</span></span>
<span class="line"><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">resolver</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">prefix</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;___grpc_proxy_endpoint&quot;</span><span style="color:#E1E4E8;"> \\</span></span>
<span class="line"><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">resolver</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ttl</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">60</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#9ECBFF;">&quot;level&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;info&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;ts&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;2020-12-13T01:46:43.616+0800&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;caller&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;etcdmain/grpc_proxy.go:320&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;msg&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;listening for gRPC proxy client requests&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;address&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;127.0.0.1:23791&quot;</span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#9ECBFF;">&quot;level&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;info&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;ts&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;2020-12-13T01:46:43.616+0800&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;caller&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;etcdmain/grpc_proxy.go:218&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;msg&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;started gRPC proxy&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;address&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;127.0.0.1:23791&quot;</span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#79B8FF;">2020</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">12</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">01</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">46</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">43.622249</span><span style="color:#E1E4E8;"> I </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> grpcproxy</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> registered </span><span style="color:#9ECBFF;">&quot;127.0.0.1:23791&quot;</span><span style="color:#E1E4E8;"> with </span><span style="color:#79B8FF;">60</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">second lease</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ etcd grpc</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">proxy start </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">localhost</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">12379</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">listen</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">addr</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">23790</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">advertise</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">client</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">url</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">23790</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">resolver</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">prefix</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;___grpc_proxy_endpoint&quot;</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">resolver</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ttl</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">60</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#032F62;">&quot;level&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;info&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;ts&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;2020-12-13T01:46:04.885+0800&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;caller&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;etcdmain/grpc_proxy.go:320&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;msg&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;listening for gRPC proxy client requests&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;address&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;127.0.0.1:23790&quot;</span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#032F62;">&quot;level&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;info&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;ts&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;2020-12-13T01:46:04.885+0800&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;caller&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;etcdmain/grpc_proxy.go:218&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;msg&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;started gRPC proxy&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;address&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;127.0.0.1:23790&quot;</span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#005CC5;">2020</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">12</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">01</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">46</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">04</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">892061</span><span style="color:#24292E;"> I </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> grpcproxy</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> registered </span><span style="color:#032F62;">&quot;127.0.0.1:23790&quot;</span><span style="color:#24292E;"> with </span><span style="color:#005CC5;">60</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">second lease</span></span>
<span class="line"><span style="color:#24292E;">$ etcd grpc</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">proxy start </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">localhost</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">12379</span><span style="color:#24292E;"> \\</span></span>
<span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">listen</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">addr</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">23791</span><span style="color:#24292E;"> \\</span></span>
<span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">advertise</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">client</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">url</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">23791</span><span style="color:#24292E;"> \\</span></span>
<span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">resolver</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">prefix</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;___grpc_proxy_endpoint&quot;</span><span style="color:#24292E;"> \\</span></span>
<span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">resolver</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ttl</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">60</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#032F62;">&quot;level&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;info&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;ts&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;2020-12-13T01:46:43.616+0800&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;caller&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;etcdmain/grpc_proxy.go:320&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;msg&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;listening for gRPC proxy client requests&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;address&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;127.0.0.1:23791&quot;</span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#032F62;">&quot;level&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;info&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;ts&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;2020-12-13T01:46:43.616+0800&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;caller&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;etcdmain/grpc_proxy.go:218&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;msg&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;started gRPC proxy&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;address&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;127.0.0.1:23791&quot;</span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#005CC5;">2020</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">12</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">01</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">46</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">43.622249</span><span style="color:#24292E;"> I </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> grpcproxy</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> registered </span><span style="color:#032F62;">&quot;127.0.0.1:23791&quot;</span><span style="color:#24292E;"> with </span><span style="color:#005CC5;">60</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">second lease</span></span></code></pre></div><p>在上面的启动命令中，将需要加入的自定义端点<code>--resolver-prefix</code>设置为<code>___grpc_proxy_endpoint</code>。启动成功之后，我们来验证下，gRPC 代理在查询成员时是否列出其所有成员作为成员列表，执行如下的命令：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> etcdctl </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">http</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//localhost:23790 member list --write-out table</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> etcdctl </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">http</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//localhost:23790 member list --write-out table</span></span></code></pre></div><p>通过下图，可以看到，通过相同的前缀端点名完成了自动发现所有成员列表的操作。</p>`,12),q=l(`<p>同样地，客户端也可以通过 Sync 方法自动发现代理的端点，代码实现如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">cli, err </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> clientv3.</span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(clientv3.Config{</span></span>
<span class="line"><span style="color:#E1E4E8;">    Endpoints</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> []string{</span><span style="color:#9ECBFF;">&quot;http://localhost:23790&quot;</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> nil {</span></span>
<span class="line"><span style="color:#E1E4E8;">    log.</span><span style="color:#B392F0;">Fatal</span><span style="color:#E1E4E8;">(err)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">defer cli.</span><span style="color:#B392F0;">Close</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#6A737D;">// 获取注册过的 grpc-proxy 端点</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> cli.</span><span style="color:#B392F0;">Sync</span><span style="color:#E1E4E8;">(context.</span><span style="color:#B392F0;">Background</span><span style="color:#E1E4E8;">()); err </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> nil {</span></span>
<span class="line"><span style="color:#E1E4E8;">    log.</span><span style="color:#B392F0;">Fatal</span><span style="color:#E1E4E8;">(err)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">cli, err </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> clientv3.</span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(clientv3.Config{</span></span>
<span class="line"><span style="color:#24292E;">    Endpoints</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> []string{</span><span style="color:#032F62;">&quot;http://localhost:23790&quot;</span><span style="color:#24292E;">},</span></span>
<span class="line"><span style="color:#24292E;">})</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> nil {</span></span>
<span class="line"><span style="color:#24292E;">    log.</span><span style="color:#6F42C1;">Fatal</span><span style="color:#24292E;">(err)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">defer cli.</span><span style="color:#6F42C1;">Close</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#6A737D;">// 获取注册过的 grpc-proxy 端点</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> cli.</span><span style="color:#6F42C1;">Sync</span><span style="color:#24292E;">(context.</span><span style="color:#6F42C1;">Background</span><span style="color:#24292E;">()); err </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> nil {</span></span>
<span class="line"><span style="color:#24292E;">    log.</span><span style="color:#6F42C1;">Fatal</span><span style="color:#24292E;">(err)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>相应地，如果配置的代理没有配置前缀，gRPC 代理启动命令如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ .</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">etcd grpc</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">proxy start </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">localhost</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">12379</span><span style="color:#E1E4E8;"> \\</span></span>
<span class="line"><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">listen</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">addr</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">23792</span><span style="color:#E1E4E8;"> \\</span></span>
<span class="line"><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">advertise</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">client</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">url</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">23792</span></span>
<span class="line"><span style="color:#E1E4E8;"># 输出结果</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#9ECBFF;">&quot;level&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;info&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;ts&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;2020-12-13T01:49:25.099+0800&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;caller&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;etcdmain/grpc_proxy.go:320&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;msg&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;listening for gRPC proxy client requests&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;address&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;127.0.0.1:23792&quot;</span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#9ECBFF;">&quot;level&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;info&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;ts&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;2020-12-13T01:49:25.100+0800&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;caller&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;etcdmain/grpc_proxy.go:218&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;msg&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;started gRPC proxy&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;address&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;127.0.0.1:23792&quot;</span><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ .</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">etcd grpc</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">proxy start </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">localhost</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">12379</span><span style="color:#24292E;"> \\</span></span>
<span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">listen</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">addr</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">23792</span><span style="color:#24292E;"> \\</span></span>
<span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">advertise</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">client</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">url</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">23792</span></span>
<span class="line"><span style="color:#24292E;"># 输出结果</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#032F62;">&quot;level&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;info&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;ts&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;2020-12-13T01:49:25.099+0800&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;caller&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;etcdmain/grpc_proxy.go:320&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;msg&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;listening for gRPC proxy client requests&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;address&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;127.0.0.1:23792&quot;</span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#032F62;">&quot;level&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;info&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;ts&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;2020-12-13T01:49:25.100+0800&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;caller&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;etcdmain/grpc_proxy.go:218&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;msg&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;started gRPC proxy&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;address&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;127.0.0.1:23792&quot;</span><span style="color:#24292E;">}</span></span></code></pre></div><p>我们来验证下 gRPC proxy 的成员列表 API 是不是只返回自己的<code>advertise-client-url</code>：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> etcdctl </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">http</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//localhost:23792 member list --write-out table</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> etcdctl </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">http</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//localhost:23792 member list --write-out table</span></span></code></pre></div><p>通过下图，可以看到，结果如我们预期：当我们<strong>没有配置代理的前缀端点名时，获取其成员列表只会显示当前节点的信息，也不会包含其他的端点</strong>。</p>`,7),C=s("h3",{id:"可伸缩的-watch-api",tabindex:"-1"},[o("可伸缩的 watch API "),s("a",{class:"header-anchor",href:"#可伸缩的-watch-api","aria-label":'Permalink to "可伸缩的 watch API"'},"​")],-1),g=s("p",null,"如果客户端监视同一键或某一范围内的键，gRPC 代理可以将这些客户端监视程序（c-watcher）合并为连接到 etcd 服务器的单个监视程序（s-watcher）。当 watch 事件发生时，代理将所有事件从 s-watcher 广播到其 c-watcher。",-1),A=s("p",null,"假设 N 个客户端监视相同的 key，则 gRPC 代理可以将 etcd 服务器上的监视负载从 N 减少到 1。用户可以部署多个 gRPC 代理，进一步分配服务器负载。",-1),D=s("p",null,"如下图所示，三个客户端监视键 A。gRPC 代理将三个监视程序合并，从而创建一个附加到 etcd 服务器的监视程序。",-1),h=l('<p>为了有效地将多个客户端监视程序合并为一个监视程序，gRPC 代理在可能的情况下将新的 c-watcher 合并为现有的 s-watcher。由于网络延迟或缓冲的未传递事件，合并的 s-watcher 可能与 etcd 服务器不同步。</p><p><strong>如果没有指定监视版本，gRPC 代理将不能保证 c-watcher 从最近的存储修订版本开始监视</strong>。例如，如果客户端从修订版本为 1000 的 etcd 服务器监视，则该监视者将从修订版本 1000 开始。如果客户端从 gRPC 代理监视，则可能从修订版本 990 开始监视。</p><p><strong>类似的限制也适用于取消</strong>。取消 watch 后，etcd 服务器的修订版可能大于取消响应修订版。</p><p>对于大多数情况，这两个限制一般不会引起问题，未来也可能会有其他选项强制观察者绕过 gRPC 代理以获得更准确的修订响应。</p><h3 id="可伸缩的-lease-api" tabindex="-1">可伸缩的 lease API <a class="header-anchor" href="#可伸缩的-lease-api" aria-label="Permalink to &quot;可伸缩的 lease API&quot;">​</a></h3><p>为了保持客户端申请租约的有效性，客户端至少建立一个 gRPC 连接到 etcd 服务器，以定期发送心跳信号。如果 etcd 工作负载涉及很多的客户端租约活动，这些流可能会导致 CPU 使用率过高。<strong>为了减少核心集群上的流总数，gRPC 代理支持将 lease 流合并</strong>。</p><p>假设有 N 个客户端正在更新租约，则单个 gRPC 代理将 etcd 服务器上的流负载从 N 减少到 1。在部署的过程中，可能还有其他 gRPC 代理，进一步在多个代理之间分配流。</p><p>在下图示例中，三个客户端更新了三个独立的租约（L1、L2 和 L3）。gRPC 代理将三个客户端租约流（c-stream）合并为连接到 etcd 服务器的单个租约（s-stream），以保持活动流。代理将客户端租约的心跳从 c-stream 转发到 s-stream，然后将响应返回到相应的 c-stream。</p>',8),B=l(`<p>除此之外，gRPC 代理在满足一致性时会缓存请求的响应。该功能可以保护 etcd 服务器免遭恶意 for 循环中滥用客户端的攻击。</p><h3 id="命名空间的实现" tabindex="-1">命名空间的实现 <a class="header-anchor" href="#命名空间的实现" aria-label="Permalink to &quot;命名空间的实现&quot;">​</a></h3><p>上面我们讲到 gRPC proxy 的端点可以通过配置前缀，自动发现。而当应用程序期望对整个键空间有完全控制，etcd 集群与其他应用程序共享的情况下，为了使所有应用程序都不会相互干扰地运行，代理可以对<strong>etcd 键空间进行分区</strong>，以便客户端大概率访问完整的键空间。</p><p>当给代理提供标志<code>--namespace</code>时，所有进入代理的客户端请求都将转换为<strong>在键上具有用户定义的前缀</strong>。普通的请求对 etcd 集群的访问将会在我们指定的前缀（即指定的 --namespace 的值）下，而来自代理的响应将删除该前缀；而这个操作对于客户端来说是透明的，根本察觉不到前缀。</p><p>下面我们给 gRPC proxy 命名，只需要启动时指定<code>--namespace</code>标识：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ .</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">etcd grpc</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">proxy start </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">localhost</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">12379</span><span style="color:#E1E4E8;"> \\</span></span>
<span class="line"><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">listen</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">addr</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">23790</span><span style="color:#E1E4E8;"> \\</span></span>
<span class="line"><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">namespace</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">my</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">prefix</span><span style="color:#F97583;">/</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#9ECBFF;">&quot;level&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;info&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;ts&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;2020-12-13T01:53:16.875+0800&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;caller&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;etcdmain/grpc_proxy.go:320&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;msg&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;listening for gRPC proxy client requests&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;address&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;127.0.0.1:23790&quot;</span><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#9ECBFF;">&quot;level&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;info&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;ts&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;2020-12-13T01:53:16.876+0800&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;caller&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;etcdmain/grpc_proxy.go:218&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;msg&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;started gRPC proxy&quot;</span><span style="color:#E1E4E8;">,</span><span style="color:#9ECBFF;">&quot;address&quot;</span><span style="color:#F97583;">:</span><span style="color:#9ECBFF;">&quot;127.0.0.1:23790&quot;</span><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ .</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">etcd grpc</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">proxy start </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">localhost</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">12379</span><span style="color:#24292E;"> \\</span></span>
<span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">listen</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">addr</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">23790</span><span style="color:#24292E;"> \\</span></span>
<span class="line"><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">namespace</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">my</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">prefix</span><span style="color:#D73A49;">/</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#032F62;">&quot;level&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;info&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;ts&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;2020-12-13T01:53:16.875+0800&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;caller&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;etcdmain/grpc_proxy.go:320&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;msg&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;listening for gRPC proxy client requests&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;address&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;127.0.0.1:23790&quot;</span><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">{</span><span style="color:#032F62;">&quot;level&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;info&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;ts&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;2020-12-13T01:53:16.876+0800&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;caller&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;etcdmain/grpc_proxy.go:218&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;msg&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;started gRPC proxy&quot;</span><span style="color:#24292E;">,</span><span style="color:#032F62;">&quot;address&quot;</span><span style="color:#D73A49;">:</span><span style="color:#032F62;">&quot;127.0.0.1:23790&quot;</span><span style="color:#24292E;">}</span></span></code></pre></div><p>此时对代理的访问会在 etcd 群集上自动地加上前缀，对于客户端来说没有感知。我们通过 etcdctl 客户端进行尝试：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> etcdctl </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">localhost</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">23790</span><span style="color:#E1E4E8;"> put my</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">key abc</span></span>
<span class="line"><span style="color:#E1E4E8;"># OK</span></span>
<span class="line"><span style="color:#E1E4E8;">$ ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> etcdctl </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">localhost</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">23790</span><span style="color:#E1E4E8;"> get my</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">key</span></span>
<span class="line"><span style="color:#E1E4E8;"># my</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">key</span></span>
<span class="line"><span style="color:#E1E4E8;"># abc</span></span>
<span class="line"><span style="color:#E1E4E8;">$ ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> etcdctl </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">localhost</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">2379</span><span style="color:#E1E4E8;"> get my</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">prefix</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">my</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">key</span></span>
<span class="line"><span style="color:#E1E4E8;"># my</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">prefix</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">my</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">key</span></span>
<span class="line"><span style="color:#E1E4E8;"># abc</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> etcdctl </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">localhost</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">23790</span><span style="color:#24292E;"> put my</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">key abc</span></span>
<span class="line"><span style="color:#24292E;"># OK</span></span>
<span class="line"><span style="color:#24292E;">$ ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> etcdctl </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">localhost</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">23790</span><span style="color:#24292E;"> get my</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">key</span></span>
<span class="line"><span style="color:#24292E;"># my</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">key</span></span>
<span class="line"><span style="color:#24292E;"># abc</span></span>
<span class="line"><span style="color:#24292E;">$ ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> etcdctl </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">localhost</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">2379</span><span style="color:#24292E;"> get my</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">prefix</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">my</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">key</span></span>
<span class="line"><span style="color:#24292E;"># my</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">prefix</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">my</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">key</span></span>
<span class="line"><span style="color:#24292E;"># abc</span></span></code></pre></div><p>上述三条命令，首先通过代理写入键值对，然后读取。为了验证结果，第三条命令通过 etcd 集群直接读取，不过需要加上代理的前缀，两种方式得到的结果完全一致。因此，<strong>使用 proxy 的命名空间即可实现 etcd 键空间分区</strong>，对于客户端来说非常便利。</p><h3 id="其他扩展功能" tabindex="-1">其他扩展功能 <a class="header-anchor" href="#其他扩展功能" aria-label="Permalink to &quot;其他扩展功能&quot;">​</a></h3><p>gRPC 代理的功能非常强大，除了上述提到的客户端端点同步、可伸缩 API、命名空间功能，还提供了指标与健康检查接口和 TLS 加密中止的扩展功能。</p><h4 id="指标与健康检查接口" tabindex="-1">指标与健康检查接口 <a class="header-anchor" href="#指标与健康检查接口" aria-label="Permalink to &quot;指标与健康检查接口&quot;">​</a></h4><p>gRPC 代理为<code>--endpoints</code>定义的 etcd 成员公开了<code>/health</code>和 Prometheus 的<code>/metrics</code>接口。我们通过浏览器访问这两个接口：</p>`,13),_=s("p",null,"访问 metrics 接口的结果",-1),v=l(`<p>访问 health 接口的结果</p><p>通过代理访问<code>/metrics</code>端点的结果如上图所示 ，其实和普通的 etcd 集群实例没有什么区别，同样也会结合一些中间件进行统计和页面展示，如 Prometheus 和 Grafana 的组合。</p><p>除了使用默认的端点访问这两个接口，另一种方法是定义一个附加 URL，该 URL 将通过 --metrics-addr 标志来响应<code>/metrics</code>和<code>/health</code>端点。命令如下所示 ：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ .</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">etcd grpc</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">proxy start \\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints http</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//localhost:12379 \\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">metrics</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">addr http</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//0.0.0.0:6633 \\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">listen</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">addr </span><span style="color:#79B8FF;">127.0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">0</span><span style="color:#E1E4E8;">.</span><span style="color:#FDAEB7;font-style:italic;">1</span><span style="color:#F97583;">:</span><span style="color:#79B8FF;">23790</span><span style="color:#E1E4E8;"> \\</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ .</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">etcd grpc</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">proxy start \\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints http</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//localhost:12379 \\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">metrics</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">addr http</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//0.0.0.0:6633 \\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">listen</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">addr </span><span style="color:#005CC5;">127.0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">0</span><span style="color:#24292E;">.</span><span style="color:#B31D28;font-style:italic;">1</span><span style="color:#D73A49;">:</span><span style="color:#005CC5;">23790</span><span style="color:#24292E;"> \\</span></span></code></pre></div><p>在执行如上启动命令时，会有如下的命令行输出，提示我们指定的 metrics 监听地址为 <a href="http://0.0.0.0:6633" target="_blank" rel="noreferrer">http://0.0.0.0:6633</a>。</p><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">{</span><span style="color:#9ECBFF;">&quot;level&quot;</span><span style="color:#E1E4E8;">:</span><span style="color:#9ECBFF;">&quot;info&quot;</span><span style="color:#F97583;">,</span><span style="color:#9ECBFF;">&quot;ts&quot;</span><span style="color:#E1E4E8;">:</span><span style="color:#9ECBFF;">&quot;2021-01-30T18:03:45.231+0800&quot;</span><span style="color:#F97583;">,</span><span style="color:#9ECBFF;">&quot;caller&quot;</span><span style="color:#E1E4E8;">:</span><span style="color:#9ECBFF;">&quot;etcdmain/grpc_proxy.go:456&quot;</span><span style="color:#F97583;">,</span><span style="color:#9ECBFF;">&quot;msg&quot;</span><span style="color:#E1E4E8;">:</span><span style="color:#9ECBFF;">&quot;gRPC proxy listening for metrics&quot;</span><span style="color:#F97583;">,</span><span style="color:#9ECBFF;">&quot;address&quot;</span><span style="color:#E1E4E8;">:</span><span style="color:#9ECBFF;">&quot;http://0.0.0.0:6633&quot;</span><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">{</span><span style="color:#032F62;">&quot;level&quot;</span><span style="color:#24292E;">:</span><span style="color:#032F62;">&quot;info&quot;</span><span style="color:#D73A49;">,</span><span style="color:#032F62;">&quot;ts&quot;</span><span style="color:#24292E;">:</span><span style="color:#032F62;">&quot;2021-01-30T18:03:45.231+0800&quot;</span><span style="color:#D73A49;">,</span><span style="color:#032F62;">&quot;caller&quot;</span><span style="color:#24292E;">:</span><span style="color:#032F62;">&quot;etcdmain/grpc_proxy.go:456&quot;</span><span style="color:#D73A49;">,</span><span style="color:#032F62;">&quot;msg&quot;</span><span style="color:#24292E;">:</span><span style="color:#032F62;">&quot;gRPC proxy listening for metrics&quot;</span><span style="color:#D73A49;">,</span><span style="color:#032F62;">&quot;address&quot;</span><span style="color:#24292E;">:</span><span style="color:#032F62;">&quot;http://0.0.0.0:6633&quot;</span><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="tls-加密的代理" tabindex="-1">TLS 加密的代理 <a class="header-anchor" href="#tls-加密的代理" aria-label="Permalink to &quot;TLS 加密的代理&quot;">​</a></h4><p>通过使用 gRPC 代理 etcd 集群的 TLS，可以给没有使用 HTTPS 加密方式的本地客户端提供服务，实现 etcd 集群的 TLS 加密中止，即未加密的客户端与 gRPC 代理通过 HTTP 方式通信，gRPC 代理与 etcd 集群通过 TLS 加密通信。下面我们进行实践：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ etcd </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">listen</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">client</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">urls https</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//localhost:12379 --advertise-client-urls https://localhost:2379 --cert-file=peer.crt --key-file=peer.key --trusted-ca-file=ca.crt --client-cert-auth</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ etcd </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">listen</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">client</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">urls https</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//localhost:12379 --advertise-client-urls https://localhost:2379 --cert-file=peer.crt --key-file=peer.key --trusted-ca-file=ca.crt --client-cert-auth</span></span></code></pre></div><p>上述命令使用 HTTPS 启动了单个成员的 etcd 集群，然后确认 etcd 集群以 HTTPS 的方式提供服务：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"># fails</span></span>
<span class="line"><span style="color:#E1E4E8;">$ ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> etcdctl </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">http</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//localhost:2379 endpoint status</span></span>
<span class="line"><span style="color:#E1E4E8;"># works</span></span>
<span class="line"><span style="color:#E1E4E8;">$ ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> etcdctl </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">https</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//localhost:2379 --cert=client.crt --key=client.key --cacert=ca.crt endpoint status</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"># fails</span></span>
<span class="line"><span style="color:#24292E;">$ ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> etcdctl </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">http</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//localhost:2379 endpoint status</span></span>
<span class="line"><span style="color:#24292E;"># works</span></span>
<span class="line"><span style="color:#24292E;">$ ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> etcdctl </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">https</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//localhost:2379 --cert=client.crt --key=client.key --cacert=ca.crt endpoint status</span></span></code></pre></div><p>显然第一种方式不能访问。</p><p>接下来通过使用客户端证书连接到 etcd 端点<code>https://localhost:2379</code>，并在 localhost:12379 上启动 gRPC 代理，命令如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ etcd grpc</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">proxy start </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">https</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//localhost:2379 --listen-addr localhost:12379 --cert client.crt --key client.key --cacert=ca.crt --insecure-skip-tls-verify</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ etcd grpc</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">proxy start </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">https</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//localhost:2379 --listen-addr localhost:12379 --cert client.crt --key client.key --cacert=ca.crt --insecure-skip-tls-verify</span></span></code></pre></div><p>启动后，我们通过 gRPC 代理写入一个键值对测试：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$ ETCDCTL_API</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> etcdctl </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">endpoints</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">http</span><span style="color:#F97583;">:</span><span style="color:#6A737D;">//localhost:12379 put abc def</span></span>
<span class="line"><span style="color:#E1E4E8;"># OK</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$ ETCDCTL_API</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> etcdctl </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">endpoints</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">http</span><span style="color:#D73A49;">:</span><span style="color:#6A737D;">//localhost:12379 put abc def</span></span>
<span class="line"><span style="color:#24292E;"># OK</span></span></code></pre></div><p>可以看到，使用 HTTP 的方式设置成功。</p><p>回顾上述操作，我们通过 etcd 的 gRPC 代理实现了代理与实际的 etcd 集群之间的 TLS 加密，而本地的客户端通过 HTTP 的方式与 gRPC 代理通信。因此这是一个简便的调试和开发手段，你在生产环境需要谨慎使用，以防安全风险。</p><h3 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h3><p>这一讲我们主要介绍了 etcd 中的 gRPC proxy。本讲主要内容如下：</p>`,20),m=s("p",null,"gRPC 代理用于支持多个 etcd 服务器端点，当代理启动时，它会随机选择一个 etcd 服务器端点来使用，该端点处理所有请求，直到代理检测到端点故障为止。如果 gRPC 代理检测到端点故障，它将切换到其他可用的端点，对客户端继续提供服务，并且隐藏了存在问题的 etcd 服务端点。",-1),P=s("p",null,"关于 gRPC 代理，你有什么经验和踩坑的经历，欢迎在留言区和我分享你的经验。",-1),f=s("p",null,"集群的部署并不是一劳永逸的事情，在我们日常的工作中经常会遇到集群的调整。下一讲，我们将会介绍如何动态配置 etcd 集群。我们下一讲再见。",-1);function x(T,k,b,R,I,$){const a=t("Image");return e(),c("div",null,[y,E,i,F,u,n(a,{alt:"202125-92345.png",src:"https://s0.lgstatic.com/i/image6/M00/02/39/CioPOWAdDsCAOeHvAACGoxT-wS8912.png"}),o(),d,n(a,{alt:"202125-92351.png",src:"https://s0.lgstatic.com/i/image6/M00/02/39/CioPOWAdDuaAL9IoAAMgcPZE1jc101.png"}),o(),q,n(a,{alt:"202125-92353.png",src:"https://s0.lgstatic.com/i/image6/M00/02/3B/Cgp9HWAdDu2Afub8AAI6unk0A5A099.png"}),o(),C,g,A,D,n(a,{alt:"202125-92355.png",src:"https://s0.lgstatic.com/i/image6/M00/02/39/CioPOWAdDvWAAhlsAADrPgju77A709.png"}),o(),h,n(a,{alt:"202125-92357.png",src:"https://s0.lgstatic.com/i/image6/M00/02/3C/Cgp9HWAdDwCAZYOCAAC-ZGY7vng236.png"}),o(),B,n(a,{alt:"Drawing 4.png",src:"https://s0.lgstatic.com/i/image/M00/94/3D/Ciqc1GAXy8qAAw3iAAaZ1XYdHxw861.png"}),o(),_,n(a,{alt:"Drawing 5.png",src:"https://s0.lgstatic.com/i/image/M00/94/48/CgqCHmAXy8-AZ0q5AACKTo_Vhhg176.png"}),o(),v,n(a,{alt:"202125-92359.png",src:"https://s0.lgstatic.com/i/image6/M00/02/39/CioPOWAdDxKAFk1BAAIimkNUiSk285.png"}),o(),m,P,f])}const S=p(r,[["render",x]]);export{w as __pageData,S as default};
