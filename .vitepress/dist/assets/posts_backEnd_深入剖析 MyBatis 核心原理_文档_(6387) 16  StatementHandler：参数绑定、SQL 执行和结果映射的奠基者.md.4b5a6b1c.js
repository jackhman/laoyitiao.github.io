import{_ as p,j as o,o as t,g as r,k as e,h as a,s,Q as l}from"./chunks/framework.4e7d56ce.js";const v=JSON.parse('{"title":"16StatementHandler：参数绑定、SQL执行和结果映射的奠基者","description":"","frontmatter":{},"headers":[],"relativePath":"posts/backEnd/深入剖析 MyBatis 核心原理_文档/(6387) 16  StatementHandler：参数绑定、SQL 执行和结果映射的奠基者.md","filePath":"posts/backEnd/深入剖析 MyBatis 核心原理_文档/(6387) 16  StatementHandler：参数绑定、SQL 执行和结果映射的奠基者.md","lastUpdated":1696682708000}'),c={name:"posts/backEnd/深入剖析 MyBatis 核心原理_文档/(6387) 16  StatementHandler：参数绑定、SQL 执行和结果映射的奠基者.md"},E=s("h1",{id:"_16statementhandler-参数绑定、sql执行和结果映射的奠基者",tabindex:"-1"},[a("16StatementHandler：参数绑定、SQL执行和结果映射的奠基者 "),s("a",{class:"header-anchor",href:"#_16statementhandler-参数绑定、sql执行和结果映射的奠基者","aria-label":'Permalink to "16StatementHandler：参数绑定、SQL执行和结果映射的奠基者"'},"​")],-1),y=s("p",null,[s("strong",null,"StatementHandler 接口是 MyBatis 中非常重要的一个接口"),a("，其实现类完成 SQL 语句执行中最核心的一系列操作，这也是后面我们要介绍的 Executor 接口实现的基础。")],-1),i=s("p",null,"StatementHandler 接口的定义如下图所示：",-1),d=s("p",null,"StatementHandler 接口中定义的方法",-1),u=s("p",null,"可以看到，其中提供了创建 Statement 对象（prepare() 方法）、为 SQL 语句绑定实参（parameterize() 方法）、执行单条 SQL 语句（query() 方法和 update() 方法）、批量执行 SQL 语句（batch() 方法）等多种功能。",-1),m=s("p",null,"下图展示了 MyBatis 中提供的所有 StatementHandler 接口实现类，以及它们的继承关系：",-1),S=l(`<p>StatementHandler 接口继承关系图</p><p>今天这一讲我们就来详细分析该继承关系图中每个 StatementHandler 实现的核心逻辑。</p><h3 id="routingstatementhandler" tabindex="-1">RoutingStatementHandler <a class="header-anchor" href="#routingstatementhandler" aria-label="Permalink to &quot;RoutingStatementHandler&quot;">​</a></h3><p>RoutingStatementHandler 这个 StatementHandler 实现，有点<strong>策略模式</strong>的意味。在 RoutingStatementHandler 的构造方法中，会根据 MappedStatement 中的 statementType 字段值，选择相应的 StatementHandler 实现进行创建，这个新建的 StatementHandler 对象由 RoutingStatementHandler 中的 delegate 字段维护。</p><p>RoutingStatementHandler 的构造方法如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">RoutingStatementHandler</span><span style="color:#E1E4E8;">(Executor executor, MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 下面就是根据MappedStatement的配置，生成一个相应的StatementHandler对</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 象，并设置到delegate字段中维护</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">switch</span><span style="color:#E1E4E8;"> (ms.</span><span style="color:#B392F0;">getStatementType</span><span style="color:#E1E4E8;">()) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> STATEMENT</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 创建SimpleStatementHandler对象</span></span>
<span class="line"><span style="color:#E1E4E8;">            delegate </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">SimpleStatementHandler</span><span style="color:#E1E4E8;">(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> PREPARED</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 创建PreparedStatementHandler对象</span></span>
<span class="line"><span style="color:#E1E4E8;">            delegate </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">PreparedStatementHandler</span><span style="color:#E1E4E8;">(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> CALLABLE</span><span style="color:#F97583;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#6A737D;">// 创建CallableStatementHandler对象</span></span>
<span class="line"><span style="color:#E1E4E8;">            delegate </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">CallableStatementHandler</span><span style="color:#E1E4E8;">(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">default:</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 抛出异常</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ExecutorException</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;...&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RoutingStatementHandler</span><span style="color:#24292E;">(Executor executor, MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 下面就是根据MappedStatement的配置，生成一个相应的StatementHandler对</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 象，并设置到delegate字段中维护</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">switch</span><span style="color:#24292E;"> (ms.</span><span style="color:#6F42C1;">getStatementType</span><span style="color:#24292E;">()) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> STATEMENT</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 创建SimpleStatementHandler对象</span></span>
<span class="line"><span style="color:#24292E;">            delegate </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">SimpleStatementHandler</span><span style="color:#24292E;">(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> PREPARED</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 创建PreparedStatementHandler对象</span></span>
<span class="line"><span style="color:#24292E;">            delegate </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">PreparedStatementHandler</span><span style="color:#24292E;">(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> CALLABLE</span><span style="color:#D73A49;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6A737D;">// 创建CallableStatementHandler对象</span></span>
<span class="line"><span style="color:#24292E;">            delegate </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">CallableStatementHandler</span><span style="color:#24292E;">(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">default:</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 抛出异常</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ExecutorException</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;...&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>在 RoutingStatementHandler 的其他方法中，<strong>都会委托给底层的 delegate 对象来完成具体的逻辑</strong>。</p><h3 id="basestatementhandler" tabindex="-1">BaseStatementHandler <a class="header-anchor" href="#basestatementhandler" aria-label="Permalink to &quot;BaseStatementHandler&quot;">​</a></h3><p>作为一个抽象类，BaseStatementHandler 只实现了 StatementHandler 接口的 prepare() 方法，其 prepare() 方法实现为新建的 Statement 对象设置了一些参数，例如，timeout、fetchSize 等。BaseStatementHandler 还新增了一个 instantiateStatement() 抽象方法给子类实现，来完成 Statement 对象的其他初始化操作。不过，BaseStatementHandler 中并没有实现 StatementHandler 接口中的数据库操作等核心方法。</p><p>了解了 BaseStatementHandler 对 StatementHandler 接口的实现情况之后，我们再来看一下 BaseStatementHandler 的构造方法，其中会<strong>初始化执行 SQL 需要的 Executor 对象</strong> 、<strong>为 SQL 绑定实参的 ParameterHandler 对象</strong> 以及<strong>生成结果对象的 ResultSetHandler 对象</strong> 。这三个核心对象中，ResultSetHandler 对象我们已经在<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=612&amp;sid=20-h5Url-0&amp;buyFrom=2&amp;pageId=1pz4#/detail/pc?id=6385" target="_blank" rel="noreferrer">《14 | 探究 MyBatis 结果集映射机制背后的秘密（上）》</a>中介绍过了，ParameterHandler 和 Executor 在后面会展开介绍。</p><h4 id="_1-keygenerator" tabindex="-1">1. KeyGenerator <a class="header-anchor" href="#_1-keygenerator" aria-label="Permalink to &quot;1. KeyGenerator&quot;">​</a></h4><p>这里需要关注的是 generateKeys() 方法，其中会<strong>通过 KeyGenerator 接口生成主键</strong>，下面我们就来看看 KeyGenerator 接口的相关内容。</p><p>我们知道不同数据库的自增 id 生成策略并不完全一样。例如，我们常见的 Oracle DB 是通过sequence 实现自增 id 的，如果使用自增 id 作为主键，就需要我们先获取到这个自增的 id 值，然后再使用；MySQL 在使用自增 id 作为主键的时候，insert 语句中可以不指定主键，在插入过程中由 MySQL 自动生成 id。KeyGenerator 接口支持 insert 语句执行前后获取自增的 id，分别对应 processBefore() 方法和 processAfter() 方法，下图展示了 MyBatis 提供的两个 KeyGenerator 接口实现：</p>`,13),F=l(`<p>KeyGenerator 接口继承关系图</p><p><strong>Jdbc3KeyGenerator 用于获取数据库生成的自增 id（例如 MySQL 那种生成模式）</strong>，其 processBefore() 方法是空实现，processAfter() 方法会将 insert 语句执行后生成的主键保存到用户传递的实参中。我们在使用 MyBatis 执行单行 insert 语句时，一般传入的实参是一个 POJO 对象或是 Map 对象，生成的主键会设置到对应的属性中；执行多条 insert 语句时，一般传入实参是 POJO 对象集合或 Map 对象的数组或集合，集合中每一个元素都对应一次插入操作，生成的多个自增 id 也会设置到每个元素的相应属性中。</p><p>Jdbc3KeyGenerator 中获取数据库自增 id 的核心代码片段如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 将数据库生成的自增id作为结果集返回</span></span>
<span class="line"><span style="color:#F97583;">try</span><span style="color:#E1E4E8;"> (ResultSet rs </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> stmt.</span><span style="color:#B392F0;">getGeneratedKeys</span><span style="color:#E1E4E8;">()) { </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> ResultSetMetaData rsmd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> rs.</span><span style="color:#B392F0;">getMetaData</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> Configuration configuration </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ms.</span><span style="color:#B392F0;">getConfiguration</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (rsmd.</span><span style="color:#B392F0;">getColumnCount</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> keyProperties.length) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 处理rs这个结果集，将生成的id设置到对应的属性中</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#B392F0;">assignKeys</span><span style="color:#E1E4E8;">(configuration, rs, rsmd, keyProperties, parameter);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">} </span><span style="color:#F97583;">catch</span><span style="color:#E1E4E8;"> (Exception </span><span style="color:#FFAB70;">e</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ExecutorException</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;...&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 将数据库生成的自增id作为结果集返回</span></span>
<span class="line"><span style="color:#D73A49;">try</span><span style="color:#24292E;"> (ResultSet rs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> stmt.</span><span style="color:#6F42C1;">getGeneratedKeys</span><span style="color:#24292E;">()) { </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> ResultSetMetaData rsmd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> rs.</span><span style="color:#6F42C1;">getMetaData</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> Configuration configuration </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ms.</span><span style="color:#6F42C1;">getConfiguration</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (rsmd.</span><span style="color:#6F42C1;">getColumnCount</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> keyProperties.length) {</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 处理rs这个结果集，将生成的id设置到对应的属性中</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6F42C1;">assignKeys</span><span style="color:#24292E;">(configuration, rs, rsmd, keyProperties, parameter);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">} </span><span style="color:#D73A49;">catch</span><span style="color:#24292E;"> (Exception </span><span style="color:#E36209;">e</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ExecutorException</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;...&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p><strong>如果使用像 Oracle 这种不支持自动生成主键自增 id 的数据库时，我们可以使用 SelectkeyGenerator 来生成主键 id</strong> 。Mapper 映射文件中的<code>&lt;selectKey&gt;</code>标签会被解析成 SelectkeyGenerator 对象，其中的 executeBefore 属性（boolean 类型）决定了是在 insert 语句执行之前获取主键，还是在 insert 语句执行之后获取主键 id。</p><p>SelectkeyGenerator 中的 processBefore() 方法和 processAfter() 方法都是通过 processGeneratedKeys() 这个私有方法获取主键 id 的，processGeneratedKeys() 方法会执行<code>&lt;selectKey&gt;</code>标签中指定的 select 语句，查询主键信息，并记录到用户传入的实参对象的对应属性中，核心代码片段如下所示：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 创建一个新的Executor对象来执行指定的select语句</span></span>
<span class="line"><span style="color:#E1E4E8;">Executor keyExecutor </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> configuration.</span><span style="color:#B392F0;">newExecutor</span><span style="color:#E1E4E8;">(executor.</span><span style="color:#B392F0;">getTransaction</span><span style="color:#E1E4E8;">(), ExecutorType.SIMPLE);</span></span>
<span class="line"><span style="color:#6A737D;">// 拿到主键信息</span></span>
<span class="line"><span style="color:#E1E4E8;">List&lt;</span><span style="color:#F97583;">Object</span><span style="color:#E1E4E8;">&gt; values </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> keyExecutor.</span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(keyStatement, parameter, RowBounds.DEFAULT, Executor.NO_RESULT_HANDLER);</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (values.</span><span style="color:#B392F0;">size</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ExecutorException</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;SelectKey returned no data.&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">} </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (values.</span><span style="color:#B392F0;">size</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">throw</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ExecutorException</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;SelectKey returned more than one value.&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">} </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 创建实参对象的MetaObject对象</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">final</span><span style="color:#E1E4E8;"> MetaObject metaParam </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> configuration.</span><span style="color:#B392F0;">newMetaObject</span><span style="color:#E1E4E8;">(parameter);</span></span>
<span class="line"><span style="color:#E1E4E8;">    MetaObject metaResult </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> configuration.</span><span style="color:#B392F0;">newMetaObject</span><span style="color:#E1E4E8;">(values.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (keyProperties.length </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;">// 将主键信息记录到用户传入的实参对象中</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (metaResult.</span><span style="color:#B392F0;">hasGetter</span><span style="color:#E1E4E8;">(keyProperties[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">])) {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">setValue</span><span style="color:#E1E4E8;">(metaParam, keyProperties[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">], metaResult.</span><span style="color:#B392F0;">getValue</span><span style="color:#E1E4E8;">(keyProperties[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">]));</span></span>
<span class="line"><span style="color:#E1E4E8;">        } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#B392F0;">setValue</span><span style="color:#E1E4E8;">(metaParam, keyProperties[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">], values.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        ... </span><span style="color:#6A737D;">// 多结果集的处理</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 创建一个新的Executor对象来执行指定的select语句</span></span>
<span class="line"><span style="color:#24292E;">Executor keyExecutor </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> configuration.</span><span style="color:#6F42C1;">newExecutor</span><span style="color:#24292E;">(executor.</span><span style="color:#6F42C1;">getTransaction</span><span style="color:#24292E;">(), ExecutorType.SIMPLE);</span></span>
<span class="line"><span style="color:#6A737D;">// 拿到主键信息</span></span>
<span class="line"><span style="color:#24292E;">List&lt;</span><span style="color:#D73A49;">Object</span><span style="color:#24292E;">&gt; values </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> keyExecutor.</span><span style="color:#6F42C1;">query</span><span style="color:#24292E;">(keyStatement, parameter, RowBounds.DEFAULT, Executor.NO_RESULT_HANDLER);</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (values.</span><span style="color:#6F42C1;">size</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ExecutorException</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;SelectKey returned no data.&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">} </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (values.</span><span style="color:#6F42C1;">size</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">throw</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ExecutorException</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;SelectKey returned more than one value.&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">} </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 创建实参对象的MetaObject对象</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">final</span><span style="color:#24292E;"> MetaObject metaParam </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> configuration.</span><span style="color:#6F42C1;">newMetaObject</span><span style="color:#24292E;">(parameter);</span></span>
<span class="line"><span style="color:#24292E;">    MetaObject metaResult </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> configuration.</span><span style="color:#6F42C1;">newMetaObject</span><span style="color:#24292E;">(values.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (keyProperties.length </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;">// 将主键信息记录到用户传入的实参对象中</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (metaResult.</span><span style="color:#6F42C1;">hasGetter</span><span style="color:#24292E;">(keyProperties[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">])) {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">setValue</span><span style="color:#24292E;">(metaParam, keyProperties[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], metaResult.</span><span style="color:#6F42C1;">getValue</span><span style="color:#24292E;">(keyProperties[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">]));</span></span>
<span class="line"><span style="color:#24292E;">        } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#6F42C1;">setValue</span><span style="color:#24292E;">(metaParam, keyProperties[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], values.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        ... </span><span style="color:#6A737D;">// 多结果集的处理</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="_2-parameterhandler" tabindex="-1">2. ParameterHandler <a class="header-anchor" href="#_2-parameterhandler" aria-label="Permalink to &quot;2. ParameterHandler&quot;">​</a></h4><p>介绍完 KeyGenerator 接口之后，我们再来看一下 BaseStatementHandler 中依赖的另一个辅助类------ ParameterHandler。</p><p>经过前面<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=612&amp;sid=20-h5Url-0&amp;buyFrom=2&amp;pageId=1pz4#/detail/pc?id=6384&amp;fileGuid=xxQTRXtVcqtHK6j8" target="_blank" rel="noreferrer">《13 | 深入分析动态 SQL 语句解析全流程（下）》</a>介绍的一系列 SqlNode 的处理之后，我们得到的 SQL 语句（维护在 BoundSql 对象中）可能包含多个&quot;?&quot;占位符，与此同时，用于替换每个&quot;?&quot;占位符的实参都记录在 BoundSql.parameterMappings 集合中。</p><p>ParameterHandler 接口中定义了两个方法：一个是 getParameterObject() 方法，用来获取传入的实参对象；另一个是 setParameters() 方法，用来替换&quot;?&quot;占位符，这是 ParameterHandler 的<strong>核心方法</strong>。</p><p><strong>DefaultParameterHandler 是 ParameterHandler 接口的唯一实现，其 setParameters() 方法会遍历 BoundSql.parameterMappings 集合</strong>，根据参数名称查找相应实参，最后会通过 PreparedStatement.set*() 方法与 SQL 语句进行绑定。setParameters() 方法的具体代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> parameterMappings.</span><span style="color:#B392F0;">size</span><span style="color:#E1E4E8;">(); i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    ParameterMapping parameterMapping </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> parameterMappings.</span><span style="color:#B392F0;">get</span><span style="color:#E1E4E8;">(i);</span></span>
<span class="line"><span style="color:#E1E4E8;">    Object value;</span></span>
<span class="line"><span style="color:#E1E4E8;">    String propertyName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> parameterMapping.</span><span style="color:#B392F0;">getProperty</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 获取实参值</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (boundSql.</span><span style="color:#B392F0;">hasAdditionalParameter</span><span style="color:#E1E4E8;">(propertyName)) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        value </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> boundSql.</span><span style="color:#B392F0;">getAdditionalParameter</span><span style="color:#E1E4E8;">(propertyName);</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (parameterObject </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        value </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (typeHandlerRegistry.</span><span style="color:#B392F0;">hasTypeHandler</span><span style="color:#E1E4E8;">(parameterObject.</span><span style="color:#B392F0;">getClass</span><span style="color:#E1E4E8;">())) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        value </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> parameterObject;</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        MetaObject metaObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> configuration.</span><span style="color:#B392F0;">newMetaObject</span><span style="color:#E1E4E8;">(parameterObject);</span></span>
<span class="line"><span style="color:#E1E4E8;">        value </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> metaObject.</span><span style="color:#B392F0;">getValue</span><span style="color:#E1E4E8;">(propertyName);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 获取TypeHandler</span></span>
<span class="line"><span style="color:#E1E4E8;">    TypeHandler typeHandler </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> parameterMapping.</span><span style="color:#B392F0;">getTypeHandler</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    JdbcType jdbcType </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> parameterMapping.</span><span style="color:#B392F0;">getJdbcType</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 底层会调用PreparedStatement.set*()方法完成绑定</span></span>
<span class="line"><span style="color:#E1E4E8;">    typeHandler.</span><span style="color:#B392F0;">setParameter</span><span style="color:#E1E4E8;">(ps, i </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, value, jdbcType);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; i </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> parameterMappings.</span><span style="color:#6F42C1;">size</span><span style="color:#24292E;">(); i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    ParameterMapping parameterMapping </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> parameterMappings.</span><span style="color:#6F42C1;">get</span><span style="color:#24292E;">(i);</span></span>
<span class="line"><span style="color:#24292E;">    Object value;</span></span>
<span class="line"><span style="color:#24292E;">    String propertyName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> parameterMapping.</span><span style="color:#6F42C1;">getProperty</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 获取实参值</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (boundSql.</span><span style="color:#6F42C1;">hasAdditionalParameter</span><span style="color:#24292E;">(propertyName)) {</span></span>
<span class="line"><span style="color:#24292E;">        value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> boundSql.</span><span style="color:#6F42C1;">getAdditionalParameter</span><span style="color:#24292E;">(propertyName);</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (parameterObject </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (typeHandlerRegistry.</span><span style="color:#6F42C1;">hasTypeHandler</span><span style="color:#24292E;">(parameterObject.</span><span style="color:#6F42C1;">getClass</span><span style="color:#24292E;">())) {</span></span>
<span class="line"><span style="color:#24292E;">        value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> parameterObject;</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        MetaObject metaObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> configuration.</span><span style="color:#6F42C1;">newMetaObject</span><span style="color:#24292E;">(parameterObject);</span></span>
<span class="line"><span style="color:#24292E;">        value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> metaObject.</span><span style="color:#6F42C1;">getValue</span><span style="color:#24292E;">(propertyName);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 获取TypeHandler</span></span>
<span class="line"><span style="color:#24292E;">    TypeHandler typeHandler </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> parameterMapping.</span><span style="color:#6F42C1;">getTypeHandler</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    JdbcType jdbcType </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> parameterMapping.</span><span style="color:#6F42C1;">getJdbcType</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 底层会调用PreparedStatement.set*()方法完成绑定</span></span>
<span class="line"><span style="color:#24292E;">    typeHandler.</span><span style="color:#6F42C1;">setParameter</span><span style="color:#24292E;">(ps, i </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, value, jdbcType);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="simplestatementhandler" tabindex="-1">SimpleStatementHandler <a class="header-anchor" href="#simplestatementhandler" aria-label="Permalink to &quot;SimpleStatementHandler&quot;">​</a></h3><p>SimpleStatementHandler 是 StatementHandler 的具体实现之一，继承了 BaseStatementHandler 抽象类。SimpleStatementHandler 各个方法接收的是 java.sql.Statement 对象，并通过该对象来完成 CRUD 操作，所以在 SimpleStatementHandler 中<strong>维护的 SQL 语句不能存在&quot;?&quot;占位符</strong>，填充占位符的 parameterize() 方法也是空实现。</p><p>在 instantiateStatement() 这个初始化方法中，SimpleStatementHandler 会直接通过 JDBC Connection 创建 Statement 对象，这个对象也是后续 SimpleStatementHandler 其他方法的入参。</p><p>在 query() 方法实现中，SimpleStatementHandler 会直接通过上面创建的 Statement 对象，执行 SQL 语句，返回的结果集由 ResultSetHandler 完成映射，核心代码如下：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">E</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> List</span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">E</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(Statement statement, ResultHandler resultHandler) throws SQLException {、</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 获取SQL语句</span></span>
<span class="line"><span style="color:#E1E4E8;">    String sql </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> boundSql.</span><span style="color:#B392F0;">getSql</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 执行SQL语句</span></span>
<span class="line"><span style="color:#E1E4E8;">    statement.</span><span style="color:#B392F0;">execute</span><span style="color:#E1E4E8;">(sql);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 处理ResultSet映射，得到结果对象</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> resultSetHandler.</span><span style="color:#B392F0;">handleResultSets</span><span style="color:#E1E4E8;">(statement);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">E</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> List</span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">E</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">query</span><span style="color:#24292E;">(Statement statement, ResultHandler resultHandler) throws SQLException {、</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 获取SQL语句</span></span>
<span class="line"><span style="color:#24292E;">    String sql </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> boundSql.</span><span style="color:#6F42C1;">getSql</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 执行SQL语句</span></span>
<span class="line"><span style="color:#24292E;">    statement.</span><span style="color:#6F42C1;">execute</span><span style="color:#24292E;">(sql);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 处理ResultSet映射，得到结果对象</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> resultSetHandler.</span><span style="color:#6F42C1;">handleResultSets</span><span style="color:#24292E;">(statement);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>queryCursor() 方法与 query() 方法实现类似，这里就不再赘述。</p><p>batch() 方法调用的是 Statement.addBatch() 方法添加批量执行的 SQL 语句，但并不是立即执行，而是等待 Statement.executeBatch() 方法执行时才会批量执行，这点你稍微注意一下即可。</p><p>至于 update() 方法，首先会通过 Statement.execute() 方法执行 insert、update 或 delete 类型的 SQL 语句，然后执行 KeyGenerator.processAfter() 方法查询主键并填充相应属性（processBefore() 方法已经在 prepare() 方法中执行过了），最后通过 Statement.getUpdateCount() 方法获取 SQL 语句影响的行数并返回。</p><h3 id="preparedstatementhandler" tabindex="-1">PreparedStatementHandler <a class="header-anchor" href="#preparedstatementhandler" aria-label="Permalink to &quot;PreparedStatementHandler&quot;">​</a></h3><p>PreparedStatementHandler 是 StatementHandler 的具体实现之一，也是最常用的 StatementHandler 实现，它同样继承了 BaseStatementHandler 抽象类。PreparedStatementHandler 各个方法接收的是 java.sql.PreparedStatement 对象，并通过该对象来完成 CRUD 操作，在其 parameterize() 方法中会通过前面介绍的 ParameterHandler调用 PreparedStatement.set*() 方法为 SQL 语句绑定参数，所以在 PreparedStatementHandler 中<strong>维护的 SQL 语句是可以包含&quot;?&quot;占位符的</strong>。</p><p>在 instantiateStatement() 方法中，PreparedStatementHandler 会直接通过 JDBC Connection 的 prepareStatement() 方法创建 PreparedStatement 对象，该对象就是 PreparedStatementHandler 其他方法的入参。</p><p>PreparedStatementHandler 的 query() 方法、batch() 方法以及 update() 方法与 SimpleStatementHandler 的实现基本相同，只不过是把 Statement API 换成了 PrepareStatement API 而已。下面我们以 update() 方法为例进行简单介绍：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">update</span><span style="color:#E1E4E8;">(Statement statement) throws SQLException {</span></span>
<span class="line"><span style="color:#E1E4E8;">    PreparedStatement ps </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (PreparedStatement) statement;</span></span>
<span class="line"><span style="color:#E1E4E8;">    ps.</span><span style="color:#B392F0;">execute</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 执行SQL语句，修改数据</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> rows </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ps.</span><span style="color:#B392F0;">getUpdateCount</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 获取影响行数</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 获取实参对象</span></span>
<span class="line"><span style="color:#E1E4E8;">    Object parameterObject </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> boundSql.</span><span style="color:#B392F0;">getParameterObject</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 执行KeyGenerator</span></span>
<span class="line"><span style="color:#E1E4E8;">    KeyGenerator keyGenerator </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> mappedStatement.</span><span style="color:#B392F0;">getKeyGenerator</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">    keyGenerator.</span><span style="color:#B392F0;">processAfter</span><span style="color:#E1E4E8;">(executor, mappedStatement, ps, parameterObject);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> rows; </span><span style="color:#6A737D;">// 返回影响行数</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">update</span><span style="color:#24292E;">(Statement statement) throws SQLException {</span></span>
<span class="line"><span style="color:#24292E;">    PreparedStatement ps </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (PreparedStatement) statement;</span></span>
<span class="line"><span style="color:#24292E;">    ps.</span><span style="color:#6F42C1;">execute</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 执行SQL语句，修改数据</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> rows </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ps.</span><span style="color:#6F42C1;">getUpdateCount</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 获取影响行数</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 获取实参对象</span></span>
<span class="line"><span style="color:#24292E;">    Object parameterObject </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> boundSql.</span><span style="color:#6F42C1;">getParameterObject</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 执行KeyGenerator</span></span>
<span class="line"><span style="color:#24292E;">    KeyGenerator keyGenerator </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> mappedStatement.</span><span style="color:#6F42C1;">getKeyGenerator</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">    keyGenerator.</span><span style="color:#6F42C1;">processAfter</span><span style="color:#24292E;">(executor, mappedStatement, ps, parameterObject);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> rows; </span><span style="color:#6A737D;">// 返回影响行数</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="callablestatementhandler" tabindex="-1">CallableStatementHandler <a class="header-anchor" href="#callablestatementhandler" aria-label="Permalink to &quot;CallableStatementHandler&quot;">​</a></h3><p><strong>CallableStatementHandler 是处理存储过程的 StatementHandler 实现</strong>，其 instantiateStatement() 方法会通过 JDBC Connection 的 prepareCall() 方法为指定存储过程创建对应的 java.sql.CallableStatement 对象。在 parameterize() 方法中，CallableStatementHandler 除了会通过 ParameterHandler 完成实参的绑定之外，还会指定输出参数的位置和类型。</p><p>在 CallableStatementHandler 的 query()、queryCursor()、update() 方法中，除了处理 SQL 语句本身的结果集（ResultSet 结果集或是影响行数），还会通过 ResultSetHandler 的 handleOutputParameters() 方法处理输出参数，这是与 PreparedStatementHandler 最大的不同。下面我们以 query() 方法为例进行简单分析：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">public</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">E</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> List</span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">E</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">query</span><span style="color:#E1E4E8;">(Statement statement, ResultHandler resultHandler) throws SQLException {</span></span>
<span class="line"><span style="color:#E1E4E8;">    CallableStatement cs </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (CallableStatement) statement;</span></span>
<span class="line"><span style="color:#E1E4E8;">    cs.</span><span style="color:#B392F0;">execute</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// 执行存储过程</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 处理存储过程返回的结果集</span></span>
<span class="line"><span style="color:#E1E4E8;">    List&lt;</span><span style="color:#F97583;">E</span><span style="color:#E1E4E8;">&gt; resultList </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> resultSetHandler.</span><span style="color:#B392F0;">handleResultSets</span><span style="color:#E1E4E8;">(cs);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 处理输出参数，可能修改resultList集合</span></span>
<span class="line"><span style="color:#E1E4E8;">    resultSetHandler.</span><span style="color:#B392F0;">handleOutputParameters</span><span style="color:#E1E4E8;">(cs);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 返回最后的结果对象</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> resultList;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">public</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">E</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> List</span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">E</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">query</span><span style="color:#24292E;">(Statement statement, ResultHandler resultHandler) throws SQLException {</span></span>
<span class="line"><span style="color:#24292E;">    CallableStatement cs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (CallableStatement) statement;</span></span>
<span class="line"><span style="color:#24292E;">    cs.</span><span style="color:#6F42C1;">execute</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// 执行存储过程</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 处理存储过程返回的结果集</span></span>
<span class="line"><span style="color:#24292E;">    List&lt;</span><span style="color:#D73A49;">E</span><span style="color:#24292E;">&gt; resultList </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> resultSetHandler.</span><span style="color:#6F42C1;">handleResultSets</span><span style="color:#24292E;">(cs);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 处理输出参数，可能修改resultList集合</span></span>
<span class="line"><span style="color:#24292E;">    resultSetHandler.</span><span style="color:#6F42C1;">handleOutputParameters</span><span style="color:#24292E;">(cs);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 返回最后的结果对象</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> resultList;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>这一讲我们重点讲解了 MyBatis 中的 StatementHandler 接口及其核心实现，StatementHandler 接口中定义了执行一条 SQL 语句的核心方法。</p><ul><li><p>首先，分析了 RoutingStatementHandler 实现，它可以帮助我们选择真正的 StatementHandler 实现类。</p></li><li><p>接下来，介绍了 BaseStatementHandler 这个抽象类的实现，同时还详细阐述了其中使用到的 KeyGenerator 和 ParameterHandler。</p></li><li><p>最后，又介绍了 SimpleStatementHandler、PreparedStatementHandler 等实现，它们基于 JDBC API 接口，实现了完整的 StatementHandler 功能。</p></li></ul><p>下一讲，我们将开始讲解 MyBatis 中另一个核心接口------ Executor 接口，记得按时来听课。</p><hr><p>[</p>`,36),g=s("p",null,[a("]("),s("a",{href:"https://shenceyun.lagou.com/t/Mka",target:"_blank",rel:"noreferrer"},"https://shenceyun.lagou.com/t/Mka"),a(")")],-1),A=s("p",null,[s("strong",null,"《Java 工程师高薪训练营》")],-1),h=s("p",null,[a("实战训练+面试模拟+大厂内推，想要提升技术能力，进大厂拿高薪，"),s("a",{href:"https://shenceyun.lagou.com/t/Mka",target:"_blank",rel:"noreferrer"},"点击链接，提升自己"),a("！")],-1);function D(b,C,H,B,P,_){const n=o("Image");return t(),r("div",null,[E,y,i,e(n,{alt:"Drawing 0.png",src:"https://s0.lgstatic.com/i/image6/M00/1F/5B/Cgp9HWBRyPSAPnqwAADa0tXnYqQ008.png"}),a(),d,u,m,e(n,{alt:"图片3.png",src:"https://s0.lgstatic.com/i/image6/M00/1F/64/Cgp9HWBR0IaAXG4BAAGLvM_7w1Y255.png"}),a(),S,e(n,{alt:"图片4.png",src:"https://s0.lgstatic.com/i/image6/M00/1F/64/Cgp9HWBR0HmAAYIQAAE2FEB8sfU102.png"}),a(),F,e(n,{alt:"1.png",src:"https://s0.lgstatic.com/i/image/M00/6D/3E/CgqCHl-s60-AC0B_AAhXSgFweBY762.png"}),a(),g,A,h])}const k=p(c,[["render",D]]);export{v as __pageData,k as default};
