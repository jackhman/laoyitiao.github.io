import{_ as o,j as e,o as t,g as c,k as l,h as a,Q as p,s}from"./chunks/framework.4e7d56ce.js";const J=JSON.parse('{"title":"18系统的实践设计（下）：完成一个通用投票系统","description":"","frontmatter":{},"headers":[],"relativePath":"posts/frontEnd/Node.js 应用开发实战_文档/(6800) 18  系统的实践设计（下）：完成一个通用投票系统.md","filePath":"posts/frontEnd/Node.js 应用开发实战_文档/(6800) 18  系统的实践设计（下）：完成一个通用投票系统.md","lastUpdated":1696682708000}'),r={name:"posts/frontEnd/Node.js 应用开发实战_文档/(6800) 18  系统的实践设计（下）：完成一个通用投票系统.md"},i=p("",16),E=p("",8),y=s("p",null,"图 2 活动列表接口",-1),d=s("p",null,"在图 2 中的红色框部分，就是应用框架的 loadService 加载 actService 这个类，然后调用该类的 getList 获取数据，那么我们继续来看 actService.getList 的逻辑，如图 3 所示。",-1),h=s("p",null,"图 3 actService getList 逻辑",-1),g=s("p",null,"在图 3 ，我们首先在第一个红色框中获取缓存数据，如果没有获取到则从数据库中获取，也就是第二个红框逻辑。",-1),_=s("p",null,[a("为了性能考虑以及实时性考虑，我们只能将活动列表的缓存设置为 120 秒，但是我们可以定时地每 60 秒去生成这个缓存。为了定时缓存，我们特意在 actService 中实现了一个 cacheList 方法，你可以前往"),s("a",{href:"https://github.com/love-flutter/nodejs-column?fileGuid=xxQTRXtVcqtHK6j8",target:"_blank",rel:"noreferrer"},"GitHub"),a("查看详细实现。")],-1),u=s("p",null,"这里你可以思考一下：为什么一个设置为 120 秒和另外一个为 60 秒？这在课程的某一讲提及过，你知道是哪一讲以及原因吗？欢迎在评论区分享你的答案。",-1),A=s("h4",{id:"活动详情",tabindex:"-1"},[a("活动详情 "),s("a",{class:"header-anchor",href:"#活动详情","aria-label":'Permalink to "活动详情"'},"​")],-1),v=s("p",null,"活动详情和活动列表的实现基本是一样的，核心都是从缓存中获取，代码如图 4 所示。",-1),b=p("",8),k=s("p",null,"图 5 个人票券码列表",-1),m=s("p",null,"从图 5 中可以看到，其实现逻辑和上面的活动列表实现非常相似，都是调用 Service 方法逻辑，只是区别在 ticketService 中的实现不同，代码如图 6 所示。",-1),D=p("",11),F=s("p",null,"图 7 import 券码逻辑",-1),C=s("p",null,"在图 7 中的红色框部分，就是调用 codeModel 中的 lpush 将券码插入 Redis 中，而这部分逻辑就是在调用 /tools/init 时完成。在 lpush 中有一个比较取巧的技巧，如图 8 所示。",-1),f=s("p",null,"图 8 lpush 逻辑实现",-1),B=s("p",null,[a("在图 8 的红色框内，我们需要先删除该项，删除完成后再插入，"),s("strong",null,"为什么这么复杂呢？"),a(" 主要是为了避免插入重复项，如果删除成功代表原来就有该数据，因此不算新插入，如果删除为 0 则表示新插入，这样就可以方便后续的逻辑，比如需要落地数据库，那么重复的就没有必要再次落数据库了。")],-1),j=s("p",null,"数据初始化完以后，我们再来看下抢票逻辑是如何实现的，该逻辑实现在 ticket controller 中的 get 方法。",-1),T=s("p",null,"图 9 抢票接口校验实现",-1),q=s("p",null,"图 9 主要是我们的抢票的资格校验，判断该用户是否参与过该项目，或者提交的一个活动是否是非法的（其次还可以根据需求校验该活动是否在生效期内）。校验通过后，就调用 codeService.getOneCode 方法，来抢一张票，如图 10 所示。",-1),S=s("p",null,"图 10 抢票逻辑",-1),P=s("p",null,"图 10 中的红色框部分就是调用 lpop 来实现抢票。抢票完成后，我们需要设置缓存，以方便后续用户再次进入活动时，主动提示用户已经参与过该活动。抢票实现完成后，我们再回过来看抢票后的逻辑。",-1),w=p("",5),x=s("p",null,"图 12 抢票结果信息",-1),M=s("p",null,"当你再次调用上面的接口时，就会提醒你已经参与过该活动了。",-1),H=s("h3",{id:"clinic-检测",tabindex:"-1"},[a("clinic 检测 "),s("a",{class:"header-anchor",href:"#clinic-检测","aria-label":'Permalink to "clinic 检测"'},"​")],-1),I=s("p",null,"在完成了所有接口以后，我们就需要使用 clinic 工具来检测是否存在一些性能问题，我们在 bin/clinic_test.js 中增加需要测试的接口列表，这部分也需要大家自行修改，因为其中的参数可能会不同。",-1),V=s("p",null,"比如我们修改以下配置。",-1),R=p("",12),N=s("p",null,"我们先请求活动列表，拿到一个可用的活动 ID ，我们获取图 15 中的最后一个活动 ID。",-1),O=p("",12);function W(z,G,K,L,Q,X){const n=e("Image");return t(),c("div",null,[i,l(n,{alt:"Drawing 0.png",src:"https://s0.lgstatic.com/i/image6/M00/3B/FE/CioPOWCHwuCASYE8AAA3Jdxt9po231.png"}),a(),E,l(n,{alt:"Drawing 1.png",src:"https://s0.lgstatic.com/i/image6/M00/3B/F5/Cgp9HWCHwuqAOGpKAAFix4u8UOA791.png"}),a(),y,d,l(n,{alt:"Drawing 2.png",src:"https://s0.lgstatic.com/i/image6/M00/3B/FE/CioPOWCHwvOAHPXsAAFObmPiKdI776.png"}),a(),h,g,_,u,A,v,l(n,{alt:"Drawing 3.png",src:"https://s0.lgstatic.com/i/image6/M00/3B/FE/CioPOWCHwv6AdGZaAADbxFIfj50739.png"}),a(),b,l(n,{alt:"Drawing 4.png",src:"https://s0.lgstatic.com/i/image6/M00/3B/FE/CioPOWCHwwqAP5GuAAD3ZbKdwSU388.png"}),a(),k,m,l(n,{alt:"Drawing 5.png",src:"https://s0.lgstatic.com/i/image6/M00/3B/F6/Cgp9HWCHwxKAVi9pAAE57SHwWPE688.png"}),a(),D,l(n,{alt:"Drawing 6.png",src:"https://s0.lgstatic.com/i/image6/M00/3B/F6/Cgp9HWCHwy6AJs7aAAGuUnYHXbA462.png"}),a(),F,C,l(n,{alt:"Drawing 7.png",src:"https://s0.lgstatic.com/i/image6/M00/3B/F6/Cgp9HWCHwziAJmT9AAFXUG0RFAo437.png"}),a(),f,B,j,l(n,{alt:"Drawing 8.png",src:"https://s0.lgstatic.com/i/image6/M00/3B/F6/Cgp9HWCHw0OAAnrLAAGblxCYBsA727.png"}),a(),T,q,l(n,{alt:"Drawing 9.png",src:"https://s0.lgstatic.com/i/image6/M00/3B/F6/Cgp9HWCHw0qAcn7NAAG9Pxo2yvQ405.png"}),a(),S,P,l(n,{alt:"Drawing 10.png",src:"https://s0.lgstatic.com/i/image6/M00/3B/FE/CioPOWCHw1KANkPlAAHBsH7y-v8488.png"}),a(),w,l(n,{alt:"Drawing 11.png",src:"https://s0.lgstatic.com/i/image6/M00/3B/FE/CioPOWCHw1uABdDNAADOAVf-s_g172.png"}),a(),x,M,H,I,V,l(n,{alt:"Drawing 12.png",src:"https://s0.lgstatic.com/i/image6/M00/3B/FE/CioPOWCHw2aANAAzAAEShovGyQg910.png"}),a(),R,l(n,{alt:"Drawing 13.png",src:"https://s0.lgstatic.com/i/image6/M00/3B/F6/Cgp9HWCHw3OAbeHJAAEBbgNTKdg378.png"}),a(),N,l(n,{alt:"Drawing 14.png",src:"https://s0.lgstatic.com/i/image6/M00/3B/FE/CioPOWCHw32ADMtjAAGXiGES6HI969.png"}),a(),O])}const $=o(r,[["render",W]]);export{J as __pageData,$ as default};
