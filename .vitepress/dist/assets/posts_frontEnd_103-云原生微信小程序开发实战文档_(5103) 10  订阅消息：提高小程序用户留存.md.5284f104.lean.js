import{_ as o,j as e,o as t,g as c,k as l,h as n,Q as p,s}from"./chunks/framework.4e7d56ce.js";const H=JSON.parse('{"title":"10订阅消息：提高小程序用户留存","description":"","frontmatter":{},"headers":[],"relativePath":"posts/frontEnd/103-云原生微信小程序开发实战文档/(5103) 10  订阅消息：提高小程序用户留存.md","filePath":"posts/frontEnd/103-云原生微信小程序开发实战文档/(5103) 10  订阅消息：提高小程序用户留存.md","lastUpdated":1696417798000}'),r={name:"posts/frontEnd/103-云原生微信小程序开发实战文档/(5103) 10  订阅消息：提高小程序用户留存.md"},E=p("",11),i=s("ol",null,[s("li",null,[s("p",null,"在发送消息之前必须获得用户授权，这是第一步也最基本的一步。")]),s("li",null,[s("p",null,"用户授权之后，你需要把授权信息记录下来，因为小程序的订阅消息能定义多种类型，每种都需要得到用户的授权后才可以发送。")]),s("li",null,[s("p",null,"消息的发送需要一个触发点，根据订阅消息的两种应用场景，触发点可以是用户的某个行为比如支付订单，也可以是小程序主动触发，比如定时发送。")])],-1),y=s("p",null,"这三个步骤是小程序订阅消息的基本流程，我讲这个流程是希望你能先对整体的轮廓有所了解，然后再深入完整架构和实现细节。在这个流程中，有一个没有覆盖的必要步骤：先配置订阅消息的模板。",-1),_=s("h3",{id:"配置消息模板",tabindex:"-1"},[n("配置消息模板 "),s("a",{class:"header-anchor",href:"#配置消息模板","aria-label":'Permalink to "配置消息模板"'},"​")],-1),d=s("p",null,'登录微信公众平台之后，消息模板的配置入口在小程序管理后台中的"功能"-"订阅消息"里，你会看到下面这张图展示的内容：',-1),u=s("p",null,'点击"添加"就可以配置消息模板了，微信官方提供了一些常用的模板类型，你可以自行选择：',-1),g=p("",8),F=s("p",null,'用户可以对列表中的每个消息模板分别授权，也可以全部勾选（也就是全部授权）。用户点击"允许"按钮之后，将会触发 wx.requestSubscribeMessage 的 success 回调函数，返回的数据结构可以参考上面的示例代码，每个模板 ID 都有一个状态标识，accept 代表得到授权、reject 代表未获得授权、ban 代表被后台封禁。当然，正常情况下是不会出现 ban 状态的，除非你的订阅消息涉嫌骚扰用户或内容违禁。',-1),h=s("p",null,[n("既然学习的是一次性订阅消息，那么你要在每次得到用户授权后都要把信息记录下来。但不能把这些信息保存在前端，而是同步到服务端保存（因为发送消息是在服务端执行的），"),s("strong",null,"那怎么把这些信息与用户一一对应起来呢？")],-1),m=s("p",null,"还记得我们在 02 讲学习的小程序登录功能吗？登录成功后服务端会拿到用户的 openId，然后用openId 创建自定义登录态返回给小程序的前端，后续小程序的每次请求都需要携带这个自定义登录态，服务端在接收到请求后可以从自定义登录态反解析出用户的 openId，这样就可以将请求的数据与用户一一对应起来了。整个过程如图所示：",-1),b=s("p",null,"这样我们就获取到了用户的授权，接下来就是向用户发送一条订阅消息，我们先学习传统的调用方式（这里会用到 09 讲中提到的使用缓存管理 access_token 的知识）。",-1),A=s("h3",{id:"发送消息的传统调用方式",tabindex:"-1"},[n("发送消息的传统调用方式 "),s("a",{class:"header-anchor",href:"#发送消息的传统调用方式","aria-label":'Permalink to "发送消息的传统调用方式"'},"​")],-1),C=s("p",null,"学完 09 讲后我们知道了，调用微信开放接口需要临时凭证 access_token，发送订阅消息的接口作为微信开放接口的一员同样要遵循这条规则。",-1),q=s("p",null,[n("服务端需要调用微信提供的"),s("a",{href:"https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html#method-cloud",target:"_blank",rel:"noreferrer"},"subscribeMessage.send"),n("接口向用户发送订阅消息，"),s("strong",null,"这个接口有几个请求参数需要你特别关注：")],-1),D=s("p",null,"其中 template_id 是上一步得到用户授权的几个模板 ID 中的一个，请注意，你每次调用 subscribeMessage.send 接口只能发送一条消息给用户，而不能同时发送多条，这是微信的限制。touser 参数的值是接收消息的用户 openId，access_token 是临时凭证。",-1),I=s("p",null,[n("而且我刚刚提到了，发送消息需要一个触发点（可以是用户的某个行为触发，也可以是服务端的定时任务，具体采用哪种方式需要根据业务场景来决定），"),s("strong",null,"我会以定时任务这种场景为例，对照下图讲解一下完整的发送消息流程：")],-1),B=p("",8),k=s("p",null,"对比这两种调用方式，你应该能够明显感受到不同。当然，这并不是说我们只学会用云调用而不用学习传统方式了。云调用的底层也是类似传统的调用方式，只不过帮你完成了定时任务、缓存管理这些服务端的开发工作，而且我们通过学习传统的调用方式能够明白底层的工作原理，也许有一天你能够成为一名架构师，那时候你就需要这些底层知识作为搭建复杂架构的基础了。",-1),v=s("h3",{id:"总结",tabindex:"-1"},[n("总结 "),s("a",{class:"header-anchor",href:"#总结","aria-label":'Permalink to "总结"'},"​")],-1),f=s("p",null,"今天这节课，我之所以带你了解小程序的订阅消息，是因为它能帮助小程序提高用户的留存率。通过这节课，我希望你能够将以下知识融会贯通：",-1),M=s("ol",null,[s("li",null,[s("p",null,"小程序订阅消息的基本流程，包括模板配置、用户授权和发送消息；")]),s("li",null,[s("p",null,"知晓发送消息的传统调用方式，并且能够充分理解每一个步骤的作用；")]),s("li",null,[s("p",null,"学会并能够使用通过云调用实现订阅消息的发送，并且能够体会到云调用带来的效率提升。")])],-1),x=s("p",null,"如果你能够完成上面三点要求，那么今天就交给你一个需要动动手的课后作业：使用云调用完成小程序的订阅消息功能。我相信在成功完成这个作业之后，你能够对今天这节课的知识有更深的理解和记忆。",-1);function T(S,w,P,j,N,V){const a=e("Image");return t(),c("div",null,[E,l(a,{alt:"Drawing 0.png",src:"https://s0.lgstatic.com/i/image/M00/73/98/CgqCHl_GE3qAF_7RAABLEPfMmqI643.png"}),n(),i,y,_,d,l(a,{alt:"Drawing 2.png",src:"https://s0.lgstatic.com/i/image/M00/73/98/CgqCHl_GE4WAYOoDAAL0XcqrBbQ218.png"}),n(),u,l(a,{alt:"Drawing 3.png",src:"https://s0.lgstatic.com/i/image/M00/73/8C/Ciqc1F_GE4uACShwAAEtUi3fSp4383.png"}),n(),g,l(a,{alt:"Drawing 4.png",src:"https://s0.lgstatic.com/i/image/M00/73/8C/Ciqc1F_GE5yAbToLAAGY_A8yTg0382.png"}),n(),F,h,m,l(a,{alt:"Drawing 6.png",src:"https://s0.lgstatic.com/i/image/M00/73/8C/Ciqc1F_GE6WAfMkcAABjm8w8YaY782.png"}),n(),b,A,C,q,l(a,{alt:"Drawing 8.png",src:"https://s0.lgstatic.com/i/image/M00/73/98/CgqCHl_GE6yAAFfIAACKHu0E_lM563.png"}),n(),D,I,l(a,{alt:"Drawing 9.png",src:"https://s0.lgstatic.com/i/image/M00/73/8C/Ciqc1F_GE7KAYExWAAB5fzAQH8U667.png"}),n(),B,l(a,{alt:"Drawing 11.png",src:"https://s0.lgstatic.com/i/image/M00/73/98/CgqCHl_GE76Afz1OAAA6mxKIJag728.png"}),n(),k,l(a,{alt:"10.png",src:"https://s0.lgstatic.com/i/image/M00/80/29/Ciqc1F_Qgn-AYMQVAACCFjfe-jA097.png"}),n(),v,f,M,x])}const O=o(r,[["render",T]]);export{H as __pageData,O as default};
