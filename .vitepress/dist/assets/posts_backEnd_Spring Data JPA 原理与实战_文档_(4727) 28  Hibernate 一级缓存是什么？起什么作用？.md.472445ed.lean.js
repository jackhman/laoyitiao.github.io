import{_ as o,j as e,o as t,g as r,k as n,h as p,Q as l,s}from"./chunks/framework.4e7d56ce.js";const N=JSON.parse('{"title":"一级缓存 ","description":"","frontmatter":{},"headers":[],"relativePath":"posts/backEnd/Spring Data JPA 原理与实战_文档/(4727) 28  Hibernate 一级缓存是什么？起什么作用？.md","filePath":"posts/backEnd/Spring Data JPA 原理与实战_文档/(4727) 28  Hibernate 一级缓存是什么？起什么作用？.md","lastUpdated":1696417798000}'),c={name:"posts/backEnd/Spring Data JPA 原理与实战_文档/(4727) 28  Hibernate 一级缓存是什么？起什么作用？.md"},y=l("",15),E=l("",22),i=s("p",null,"发现里面 parameterMetadataCache 是空的，也就是没有放置 nativeQuery=true 的 Query SQL，并且可以看到我们在方法里面定义的其他三个 @Query 的 JPQL 解析过程。那么我们打开第一个详细看一下，如下图所示。",-1),u=l("",4),_=s("p",null,"同时，parameterMetadataCache 里面就会多一条 key/value的nativeQuery=true 的解析记录，如下图所示。",-1),d=s("p",null,"通过上面的案例讲解，相信你已经清楚了 QueryPlanCache 的概念，总结起来就是，QueryPlanCache 用来存储的 JQPL 或者 SQL 的 Metadata 信息，从而提升了 Hibernate 执行 JPQL 的性能，因为只有第一次需要把 JPQL 转化成 SQL，后面的每次操作就可以直接从 HashMap 中找到对应的 SQL，直接执行就可以了。",-1),F=s("p",null,"那么它和 Session 到底是什么关系呢？它是否在一级缓存里面？",-1),m=s("h4",{id:"queryplancache-和-session-是什么关系",tabindex:"-1"},[p("QueryPlanCache 和 Session 是什么关系？ "),s("a",{class:"header-anchor",href:"#queryplancache-和-session-是什么关系","aria-label":'Permalink to "QueryPlanCache 和 Session 是什么关系？"'},"​")],-1),h=s("p",null,"我们通过查看源码会发现，在 SessionFactoryImpl 的构造方法里面会 new QueryPlanCache(...)，关键源码如下。",-1),A=s("p",null,"说明这个 application 只需要创建一次 QueryPlanCache，整个项目周期是单例的，也就是可以被不同的 Session 共享，那么我们可以查看 Session 的关键源码，如下图所示。",-1),C=l("",5),g=s("p",null,"而我们把堆栈拿出来分析的话会发现，其实是 Hibernate 的 QueryPlanCache 占用了大量的内存，如下图所示。",-1),f=l("",7),D=l("",11),P=s("p",null,"我们会发现，In 产生个数是 1 个的时候，它会共享参数为 1 个的 QueryPlanCache；而当参数是 3、4 个 In 参数的时候，它就会使用 4 个参数的 QueryPlanCache；以此类推，当参数是 5、6、7、8 个的时候，会使用 8 个参数的 QueryPlanCache......这种算法可以大大地减少 In 的不同查询参数生成的 QueryPlanCache 个数，占用的内存自然会减少很多。",-1),v=s("h3",{id:"总结",tabindex:"-1"},[p("总结 "),s("a",{class:"header-anchor",href:"#总结","aria-label":'Permalink to "总结"'},"​")],-1),q=s("p",null,"以上就是本讲介绍的全部内容，主要是帮助你理清工作中关于缓存的一些概念，其实一级缓存的原理我们在前面几讲都有详细介绍。其中你要重点了解一下 Query Plan Cache，因为实际工作中很多人会把它和一级缓存的概念混为一谈。",-1),B=s("p",null,"学习就是不断思考的过程，希望你能踊跃留言讨论。下个课时我会重点介绍二级缓存以及它的最佳实践，到时见。",-1),I=s("blockquote",null,[s("p",null,[p("点击下方链接查看源码（不定时更新）"),s("br"),s("a",{href:"https://github.com/zhangzhenhuajack/spring-boot-guide/tree/master/spring-data/spring-data-jpa",target:"_blank",rel:"noreferrer"},"https://github.com/zhangzhenhuajack/spring-boot-guide/tree/master/spring-data/spring-data-jpa")])],-1);function b(Q,M,S,U,L,k){const a=e("Image");return t(),r("div",null,[y,n(a,{alt:"image (2).png",src:"https://s0.lgstatic.com/i/image/M00/8B/04/Ciqc1F_bHCyAUu5UAACWL1LulDM631.png"}),p(),E,n(a,{alt:"Drawing 1.png",src:"https://s0.lgstatic.com/i/image2/M01/02/2B/CgpVE1_Z3dOAL3LeAAQ5bROVfnw790.png"}),i,n(a,{alt:"Drawing 2.png",src:"https://s0.lgstatic.com/i/image2/M01/02/2B/CgpVE1_Z3dmAPB5bAAKvPbM8_1U786.png"}),u,n(a,{alt:"Drawing 3.png",src:"https://s0.lgstatic.com/i/image2/M01/02/2A/Cip5yF_Z3eCAeweyAAFrt_Cy4Fw449.png"}),_,n(a,{alt:"Drawing 4.png",src:"https://s0.lgstatic.com/i/image2/M01/02/2B/CgpVE1_Z3eaAOrDUAAJ8yCqnbQI709.png"}),d,F,m,h,n(a,{alt:"Drawing 5.png",src:"https://s0.lgstatic.com/i/image2/M01/02/2B/CgpVE1_Z3e6APucVAAH8SpvcdMQ168.png"}),A,n(a,{alt:"Drawing 6.png",src:"https://s0.lgstatic.com/i/image2/M01/02/2A/Cip5yF_Z3feAeEqeAAMBOQfm2s8156.png"}),C,n(a,{alt:"Drawing 7.png",src:"https://s0.lgstatic.com/i/image2/M01/02/2B/CgpVE1_Z3f6AJ3zkAAA0cwikRBI522.png"}),g,n(a,{alt:"Drawing 8.png",src:"https://s0.lgstatic.com/i/image2/M01/02/2A/Cip5yF_Z3gOAAypLAAH1VLcPqOU952.png"}),f,n(a,{alt:"Drawing 9.png",src:"https://s0.lgstatic.com/i/image2/M01/02/2B/CgpVE1_Z3guAcgqyAAILGhMwzQg748.png"}),D,n(a,{alt:"Drawing 10.png",src:"https://s0.lgstatic.com/i/image2/M01/02/2B/CgpVE1_Z3hWAGkLbAAH30LPJHmA137.png"}),P,v,q,B,I])}const R=o(c,[["render",b]]);export{N as __pageData,R as default};
